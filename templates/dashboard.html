{% extends "base.html" %}

{% block title %}{{ page_title }} - Growth Intelligence Dashboard{% endblock %}

{% block extra_css %}
<!-- Leaflet CSS para el mapa de tiempo real -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
    /* Global box-sizing */
    *, *::before, *::after {
        box-sizing: border-box;
    }
    
    .dashboard-wrapper {
        display: flex;
        min-height: 100vh;
        overflow-x: hidden;
    }
    
    /* ===== SIDEBAR ===== */
    .sidebar {
        width: 280px;
        background: linear-gradient(180deg, #0a0a0a 0%, #111 100%);
        border-right: 1px solid rgba(108, 168, 164, 0.2);
        padding: 0;
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        overflow-y: auto;
        z-index: 100;
        display: flex;
        flex-direction: column;
    }
    
    .sidebar-header {
        padding: 0.75rem;
        border-bottom: 1px solid rgba(108, 168, 164, 0.15);
        text-align: center;
        background: linear-gradient(180deg, rgba(108, 168, 164, 0.08) 0%, transparent 100%);
    }
    
    .sidebar-logo {
        max-width: 130px;
    }
    
    /* ===== SMART ASSISTANT BOX ===== */
    .assistant-box {
        margin: 0.75rem;
        padding: 1.25rem;
        background: linear-gradient(135deg, rgba(108, 168, 164, 0.1) 0%, rgba(108, 168, 164, 0.05) 100%);
        border: 1px solid rgba(108, 168, 164, 0.2);
        border-radius: 12px;
        position: relative;
        overflow: visible;
    }
    
    .assistant-box::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: linear-gradient(90deg, #6CA8A4, rgba(108, 168, 164, 0.3));
    }
    
    .assistant-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 0.75rem;
    }
    
    .assistant-avatar {
        width: 42px;
        height: 42px;
        background: linear-gradient(135deg, #6CA8A4 0%, #4a8a86 100%);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.3rem;
        box-shadow: 0 4px 12px rgba(108, 168, 164, 0.3);
        animation: avatarPulse 3s ease-in-out infinite;
    }
    
    @keyframes avatarPulse {
        0%, 100% { box-shadow: 0 4px 12px rgba(108, 168, 164, 0.3); }
        50% { box-shadow: 0 4px 20px rgba(108, 168, 164, 0.5); }
    }
    
    .assistant-info {
        flex: 1;
    }
    
    .assistant-name {
        font-family: 'Montserrat', sans-serif;
        font-size: 0.9rem;
        font-weight: 700;
        color: #fff;
        margin: 0;
    }
    
    .assistant-status {
        font-family: 'Outfit', sans-serif;
        font-size: 0.75rem;
        color: #6CA8A4;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.3rem;
    }
    
    .assistant-status::before {
        content: '';
        width: 6px;
        height: 6px;
        background: #6CA8A4;
        border-radius: 50%;
        animation: statusBlink 2s ease-in-out infinite;
    }
    
    @keyframes statusBlink {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.4; }
    }
    
    /* Usuarios en tiempo real */
    .assistant-realtime {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.65rem 0.85rem;
        background: rgba(108, 168, 164, 0.1);
        border: 1px solid rgba(108, 168, 164, 0.2);
        border-radius: 8px;
        margin-bottom: 1rem;
        text-decoration: none;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .assistant-realtime:hover {
        background: rgba(108, 168, 164, 0.2);
        border-color: rgba(108, 168, 164, 0.4);
        transform: translateX(2px);
    }
    
    .realtime-arrow {
        font-size: 0.7rem;
        color: rgba(108, 168, 164, 0.6);
        margin-left: auto;
        transition: transform 0.2s ease;
    }
    
    .assistant-realtime:hover .realtime-arrow {
        transform: translateX(3px);
        color: #6CA8A4;
    }
    
    /* ===== REALTIME PAGE ===== */
    .realtime-header {
        text-align: center;
        padding: 1rem 0;
        margin-bottom: 1rem;
        background: linear-gradient(180deg, rgba(108, 168, 164, 0.1) 0%, transparent 100%);
        border-radius: 12px;
        border: 1px solid rgba(108, 168, 164, 0.2);
    }
    
    .realtime-main-stat {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1rem;
    }
    
    .realtime-pulse {
        width: 16px;
        height: 16px;
        background: #4CAF50;
        border-radius: 50%;
        animation: realtimePulseBig 1.5s ease-in-out infinite;
        box-shadow: 0 0 20px rgba(76, 175, 80, 0.5);
    }
    
    @keyframes realtimePulseBig {
        0%, 100% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.2); opacity: 0.7; }
    }
    
    .realtime-big-number {
        font-family: 'Space Grotesk', sans-serif;
        font-size: 2.5rem;
        font-weight: 700;
        color: #fff;
        line-height: 1;
    }
    
    .realtime-big-label {
        font-family: 'Outfit', sans-serif;
        font-size: 1.1rem;
        color: rgba(255, 255, 255, 0.7);
        text-transform: uppercase;
        letter-spacing: 2px;
    }
    
    .realtime-subtitle {
        font-family: 'Outfit', sans-serif;
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.5);
        margin-top: 0.5rem;
    }
    
    .realtime-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
    }
    
    .realtime-card {
        background: linear-gradient(135deg, rgba(20, 20, 20, 0.9) 0%, rgba(15, 15, 15, 0.95) 100%);
        border: 1px solid rgba(108, 168, 164, 0.2);
        border-radius: 12px;
        overflow: hidden;
    }
    
    .realtime-card-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 1rem;
        background: rgba(108, 168, 164, 0.1);
        border-bottom: 1px solid rgba(108, 168, 164, 0.15);
    }
    
    .realtime-card-icon {
        font-size: 1.2rem;
    }
    
    .realtime-card-title {
        font-family: 'Montserrat', sans-serif;
        font-size: 0.9rem;
        font-weight: 600;
        color: #fff;
        margin: 0;
    }
    
    .realtime-card-body {
        padding: 0.75rem;
        max-height: 200px;
        overflow-y: auto;
    }
    
    .realtime-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.6rem 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .realtime-row:last-child {
        border-bottom: none;
    }
    
    .realtime-row-name {
        font-family: 'Outfit', sans-serif;
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.8);
        flex: 1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-right: 1rem;
    }
    
    .realtime-row-value {
        font-family: 'Montserrat', sans-serif;
        font-size: 0.9rem;
        font-weight: 700;
        color: #6CA8A4;
        min-width: 30px;
        text-align: right;
    }
    
    .realtime-row-bar {
        flex: 1;
        height: 6px;
        background: rgba(108, 168, 164, 0.2);
        border-radius: 3px;
        margin: 0 1rem;
        overflow: hidden;
    }
    
    .realtime-row-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #6CA8A4, #4a8a86);
        border-radius: 3px;
        transition: width 0.5s ease;
    }
    
    .realtime-empty {
        text-align: center;
        padding: 2rem;
        color: rgba(255, 255, 255, 0.4);
        font-family: 'Outfit', sans-serif;
        font-size: 0.9rem;
    }
    
    /* ===== REALTIME MAP ===== */
    .realtime-map-container {
        margin-top: 1.5rem;
        background: linear-gradient(135deg, rgba(20, 20, 20, 0.9) 0%, rgba(15, 15, 15, 0.95) 100%);
        border: 1px solid rgba(108, 168, 164, 0.2);
        border-radius: 12px;
        overflow: hidden;
    }
    
    .realtime-map-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem;
        background: rgba(108, 168, 164, 0.1);
        border-bottom: 1px solid rgba(108, 168, 164, 0.15);
    }
    
    .realtime-map-title {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .realtime-map-title span {
        font-size: 1.2rem;
    }
    
    .realtime-map-title h3 {
        font-family: 'Montserrat', sans-serif;
        font-size: 0.9rem;
        font-weight: 600;
        color: #fff;
        margin: 0;
    }
    
    .realtime-map-legend {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-family: 'Outfit', sans-serif;
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.6);
    }
    
    .legend-pulse {
        width: 10px;
        height: 10px;
        background: #4CAF50;
        border-radius: 50%;
        animation: legendPulse 1.5s ease-in-out infinite;
    }
    
    @keyframes legendPulse {
        0%, 100% { transform: scale(1); opacity: 1; box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7); }
        50% { transform: scale(1.2); opacity: 0.8; box-shadow: 0 0 10px 5px rgba(76, 175, 80, 0.3); }
    }
    
    #realtimeMap {
        height: 280px;
        width: 100%;
        background: #0a0a0a;
    }
    
    /* Custom Leaflet Dark Theme */
    .leaflet-container {
        background: #0a0a0a !important;
        font-family: 'Outfit', sans-serif;
    }
    
    .leaflet-tile-pane {
        filter: grayscale(100%) invert(100%) contrast(90%) hue-rotate(180deg) brightness(0.8);
    }
    
    .leaflet-control-zoom {
        border: 1px solid rgba(108, 168, 164, 0.3) !important;
        border-radius: 8px !important;
        overflow: hidden;
    }
    
    .leaflet-control-zoom a {
        background: rgba(20, 20, 20, 0.9) !important;
        color: #6CA8A4 !important;
        border-bottom: 1px solid rgba(108, 168, 164, 0.2) !important;
    }
    
    .leaflet-control-zoom a:hover {
        background: rgba(108, 168, 164, 0.2) !important;
    }
    
    .leaflet-control-attribution {
        background: rgba(10, 10, 10, 0.8) !important;
        color: rgba(255, 255, 255, 0.4) !important;
        font-size: 0.65rem !important;
    }
    
    .leaflet-control-attribution a {
        color: rgba(108, 168, 164, 0.6) !important;
    }
    
    /* Pulsing Marker */
    .pulse-marker {
        width: 20px;
        height: 20px;
        position: relative;
    }
    
    .pulse-marker-inner {
        width: 12px;
        height: 12px;
        background: #4CAF50;
        border-radius: 50%;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        box-shadow: 0 0 10px rgba(76, 175, 80, 0.8);
        z-index: 2;
    }
    
    .pulse-marker-ring {
        width: 30px;
        height: 30px;
        border: 2px solid rgba(76, 175, 80, 0.6);
        border-radius: 50%;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        animation: pulseRing 2s ease-out infinite;
    }
    
    .pulse-marker-ring-2 {
        animation-delay: 0.5s;
    }
    
    @keyframes pulseRing {
        0% {
            transform: translate(-50%, -50%) scale(0.5);
            opacity: 1;
        }
        100% {
            transform: translate(-50%, -50%) scale(2);
            opacity: 0;
        }
    }
    
    /* Popup styling */
    .leaflet-popup-content-wrapper {
        background: rgba(15, 15, 15, 0.95) !important;
        border: 1px solid rgba(108, 168, 164, 0.3) !important;
        border-radius: 10px !important;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5) !important;
    }
    
    .leaflet-popup-content {
        color: #fff !important;
        font-family: 'Outfit', sans-serif !important;
        margin: 10px 14px !important;
    }
    
    .leaflet-popup-tip {
        background: rgba(15, 15, 15, 0.95) !important;
        border: 1px solid rgba(108, 168, 164, 0.3) !important;
    }
    
    .popup-city {
        font-weight: 600;
        font-size: 0.95rem;
        color: #6CA8A4;
        margin-bottom: 4px;
    }
    
    .popup-users {
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.8);
    }
    
    .popup-users strong {
        color: #4CAF50;
    }
    
    .realtime-icon {
        font-size: 0.75rem;
    }
    
    .realtime-label {
        font-family: 'Outfit', sans-serif;
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.6);
    }
    
    .realtime-value {
        font-family: 'Montserrat', sans-serif;
        font-size: 0.95rem;
        font-weight: 700;
        color: #6CA8A4;
        margin-left: auto;
        animation: realtimePulse 2s ease-in-out infinite;
    }
    
    @keyframes realtimePulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }

    .assistant-message {
        font-family: 'Outfit', sans-serif;
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.85);
        line-height: 1.6;
        margin-bottom: 1rem;
        min-height: 45px;
        padding: 0.25rem 0;
    }
    
    .assistant-message strong {
        color: #fff;
    }
    
    .assistant-message .highlight {
        color: #ff5252;
        font-weight: 600;
    }
    
    .assistant-action {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }
    
    .assistant-btn {
        flex: 1;
        padding: 0.65rem 0.85rem;
        border-radius: 8px;
        font-family: 'Montserrat', sans-serif;
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        border: none;
        text-align: center;
        text-decoration: none;
    }
    
    .assistant-btn.primary {
        background: linear-gradient(135deg, #ff5252 0%, #ff1744 100%);
        color: #fff;
    }
    
    .assistant-btn.primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(255, 23, 68, 0.4);
    }
    
    .assistant-btn.secondary {
        background: rgba(108, 168, 164, 0.2);
        color: rgba(255, 255, 255, 0.8);
        border: 1px solid rgba(108, 168, 164, 0.3);
    }
    
    .assistant-btn.secondary:hover {
        background: rgba(108, 168, 164, 0.3);
        color: #fff;
    }
    
    /* Estado sin alertas */
    .assistant-box.no-alerts .assistant-avatar {
        background: linear-gradient(135deg, #6CA8A4 0%, #4a8a86 100%);
    }
    
    /* Estado con alertas */
    .assistant-box.has-alerts {
        border-color: rgba(255, 82, 82, 0.3);
        background: linear-gradient(135deg, rgba(255, 82, 82, 0.08) 0%, rgba(108, 168, 164, 0.05) 100%);
    }
    
    .assistant-box.has-alerts::before {
        background: linear-gradient(90deg, #ff5252, rgba(255, 82, 82, 0.3));
    }
    
    .assistant-box.has-alerts .assistant-avatar {
        background: linear-gradient(135deg, #ff5252 0%, #ff1744 100%);
        animation: alertAvatarPulse 1.5s ease-in-out infinite;
    }
    
    @keyframes alertAvatarPulse {
        0%, 100% { box-shadow: 0 4px 12px rgba(255, 82, 82, 0.4); transform: scale(1); }
        50% { box-shadow: 0 4px 25px rgba(255, 82, 82, 0.6); transform: scale(1.05); }
    }

    .sidebar-nav {
        padding: 0.75rem 0.75rem;
    }
    
    .nav-section-title {
        font-family: 'Montserrat', sans-serif;
        font-size: 0.65rem;
        font-weight: 600;
        color: rgba(108, 168, 164, 0.8);
        text-transform: uppercase;
        letter-spacing: 1.5px;
        margin-bottom: 0.5rem;
        padding-left: 0.5rem;
        padding-top: 0.75rem;
        border-top: 1px solid rgba(108, 168, 164, 0.2);
    }
    
    .nav-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.6rem 0.75rem;
        margin-bottom: 0.35rem;
        border-radius: 10px;
        color: rgba(255, 255, 255, 0.7);
        text-decoration: none;
        font-family: 'Montserrat', sans-serif;
        font-size: 0.8rem;
        font-weight: 500;
        transition: all 0.3s ease;
        position: relative;
        border: 1px solid transparent;
    }
    
    .nav-item:hover {
        background: rgba(108, 168, 164, 0.1);
        color: #fff;
        border-color: rgba(108, 168, 164, 0.3);
        transform: translateX(4px);
    }
    
    .nav-item.active {
        background: linear-gradient(135deg, rgba(29, 71, 68, 0.8) 0%, rgba(98, 169, 167, 0.5) 100%);
        color: #fff;
        border-color: rgba(108, 168, 164, 0.5);
        box-shadow: 0 4px 15px rgba(108, 168, 164, 0.2);
    }
    
/* ===== ALERTS CRITICAL STATE (MODERN) ===== */
.nav-item.alerts-critical {
    background: linear-gradient(
        135deg,
        rgba(160, 20, 20, 0.95) 0%,
        rgba(200, 40, 40, 0.95) 100%
    ) !important;

    color: #ffffff !important;
    border-color: rgba(255, 90, 90, 0.85) !important;

    box-shadow:
        0 6px 18px rgba(255, 60, 60, 0.35),
        0 0 0 1px rgba(255, 90, 90, 0.6);

    position: relative;
    overflow: hidden;
}

/* Accent line (señal moderna, no glow) */
.nav-item.alerts-critical::after {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    height: 100%;
    width: 3px;
    background: linear-gradient(
        180deg,
        rgba(255, 120, 120, 1),
        rgba(255, 60, 60, 1)
    );
    opacity: 0.9;
}

/* Soft breathing effect (muy lento) */
.nav-item.alerts-critical {
    animation: alertsBreath 4.5s ease-in-out infinite;
}

@keyframes alertsBreath {
    0%, 100% {
        box-shadow:
            0 6px 18px rgba(255, 60, 60, 0.35),
            0 0 0 1px rgba(255, 90, 90, 0.6);
    }
    50% {
        box-shadow:
            0 10px 26px rgba(255, 60, 60, 0.45),
            0 0 0 1px rgba(255, 120, 120, 0.85);
    }
}

/* Hover mantiene elegancia */
.nav-item.alerts-critical:hover {
    background: linear-gradient(
        135deg,
        rgba(180, 30, 30, 1),
        rgba(220, 60, 60, 1)
    ) !important;

    box-shadow:
        0 12px 30px rgba(255, 80, 80, 0.5),
        0 0 0 1px rgba(255, 140, 140, 1);
}

/* ===== ALERTS COUNT BADGE (MINIMAL) ===== */
.nav-item[data-alert-count] {
    position: relative;
}

.nav-item[data-alert-count]::before {
    content: '+' attr(data-alert-count);
    position: absolute;
    top: 50%;
    right: 12px;
    transform: translateY(-50%);
    
    min-width: 22px;
    height: 20px;
    padding: 0 6px;
    
    display: flex;
    align-items: center;
    justify-content: center;
    
    background: #e53935;
    color: #fff;
    
    font-family: 'Montserrat', sans-serif;
    font-size: 0.7rem;
    font-weight: 700;
    line-height: 1;
    
    border-radius: 10px;
    pointer-events: none;
    z-index: 10;
}

/* Estado crítico - badge más llamativo */
.nav-item.alerts-critical[data-alert-count]::before {
    background: #ff1744;
    box-shadow: 0 0 8px rgba(255, 23, 68, 0.6);
}

/* ===== PAGE TRANSITION SYSTEM ===== */

/* Progress Bar (Top) */
.page-progress {
    position: fixed;
    top: 0;
    left: 0;
    width: 0%;
    height: 3px;
    background: linear-gradient(90deg, #6CA8A4 0%, #8dd4cf 50%, #6CA8A4 100%);
    background-size: 200% 100%;
    box-shadow: 0 0 15px rgba(108, 168, 164, 0.8);
    z-index: 99999;
    opacity: 0;
    transition: opacity 0.2s ease;
    animation: progressShimmer 1.5s ease-in-out infinite;
}

.page-progress.active {
    opacity: 1;
    animation: progressGrow 1.5s ease-out forwards, progressShimmer 1.5s ease-in-out infinite;
}

.page-progress.complete {
    width: 100% !important;
    opacity: 0;
    transition: width 0.2s ease, opacity 0.3s ease 0.2s;
}

@keyframes progressGrow {
    0% { width: 0%; }
    20% { width: 25%; }
    50% { width: 60%; }
    80% { width: 85%; }
    100% { width: 92%; }
}

@keyframes progressShimmer {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}

/* Content Fade during transition */
.main-content {
    opacity: 1;
    transition: opacity 0.3s ease;
}

.main-content.loading {
    opacity: 0.4;
    pointer-events: none;
}

/* Fade-in animation on page load */
.main-content.fade-in {
    animation: contentFadeIn 0.5s ease-out forwards;
}

@keyframes contentFadeIn {
    from { 
        opacity: 0.4;
        transform: translateY(10px);
    }
    to { 
        opacity: 1;
        transform: translateY(0);
    }
}

/* Quick Spinner (Small, centered) */
.quick-spinner {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 9998;
    opacity: 0;
    visibility: hidden;
    transition: all 0.2s ease;
}

.quick-spinner.active {
    opacity: 1;
    visibility: visible;
}

.quick-spinner-ring {
    width: 40px;
    height: 40px;
    border: 3px solid rgba(108, 168, 164, 0.2);
    border-top-color: #6CA8A4;
    border-radius: 50%;
    animation: quickSpin 0.8s linear infinite;
}

@keyframes quickSpin {
    to { transform: rotate(360deg); }
}

/* Refresh indicator (for F5) */
.refresh-indicator {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
    z-index: 9998;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
}

.refresh-indicator.active {
    opacity: 1;
    visibility: visible;
}

.refresh-icon {
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    background: rgba(108, 168, 164, 0.15);
    border: 2px solid rgba(108, 168, 164, 0.4);
    border-radius: 50%;
    animation: refreshRotate 1s ease-in-out infinite;
}

@keyframes refreshRotate {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.refresh-text {
    font-family: 'Montserrat', sans-serif;
    font-size: 0.85rem;
    font-weight: 500;
    color: rgba(255, 255, 255, 0.7);
    letter-spacing: 1px;
}
    
    /* Date Filter Section */
    .filter-section {
        padding: 0.75rem;
        margin-top: 0.5rem;
    }
    
    .filter-title {
        font-family: 'Montserrat', sans-serif;
        font-size: 0.65rem;
        font-weight: 600;
        color: rgba(108, 168, 164, 0.8);
        text-transform: uppercase;
        letter-spacing: 1.5px;
        margin-bottom: 0.75rem;
        margin-left: 0.25rem;
        padding-top: 0.75rem;
        border-top: 1px solid rgba(108, 168, 164, 0.3);
    }
    
    /* Contenedor de filtros con márgenes */
    .filter-group {
        margin: 0 0.25rem 0.6rem 0.25rem;
        padding: 0.5rem;
        background: rgba(108, 168, 164, 0.05);
        border-radius: 6px;
        border: 1px solid rgba(108, 168, 164, 0.1);
    }
    
    .filter-label {
        font-family: 'Montserrat', sans-serif;
        font-size: 0.7rem;
        color: rgba(255, 255, 255, 0.6);
        margin-bottom: 0.35rem;
        display: block;
    }
    
    .filter-select, .filter-input {
        width: 100%;
        padding: 0.5rem 0.6rem;
        background: rgba(20, 20, 20, 0.8);
        border: 1px solid rgba(108, 168, 164, 0.3);
        border-radius: 6px;
        color: #fff;
        font-family: 'Outfit', sans-serif;
        font-size: 0.75rem;
        transition: all 0.3s ease;
    }
    
    .filter-select:focus, .filter-input:focus {
        outline: none;
        border-color: rgba(108, 168, 164, 0.7);
        box-shadow: 0 0 0 2px rgba(108, 168, 164, 0.1);
    }
    
    .filter-btn {
        width: calc(100% - 0.5rem);
        margin: 0.6rem 0.25rem 0.25rem 0.25rem;
        padding: 0.6rem;
        background: linear-gradient(135deg, rgba(29, 71, 68, 0.9) 0%, rgba(98, 169, 167, 0.7) 100%);
        border: 1px solid rgba(108, 168, 164, 0.5);
        border-radius: 8px;
        color: #fff;
        font-family: 'Outfit', sans-serif;
        font-size: 0.8rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .filter-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(108, 168, 164, 0.3);
    }
    
    .filter-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }
    
    .filter-btn.secondary {
        background: transparent;
        border: 1px solid rgba(108, 168, 164, 0.4);
        color: rgba(255, 255, 255, 0.7);
        font-weight: 500;
    }
    
    .filter-btn.secondary:hover {
        background: rgba(108, 168, 164, 0.1);
        border-color: rgba(108, 168, 164, 0.6);
        color: #fff;
    }
    
    /* ===== USER SECTION ===== */
    .user-section {
        margin-top: auto;
        padding: 0.75rem;
        border-top: 1px solid rgba(108, 168, 164, 0.15);
        background: linear-gradient(0deg, rgba(108, 168, 164, 0.05) 0%, transparent 100%);
    }
    
    .user-info-sidebar {
        padding: 0.5rem;
        margin-bottom: 0.5rem;
    }
    
    .user-email {
        font-family: 'Outfit', sans-serif;
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.6);
        word-break: break-all;
    }
    
    .logout-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        width: 100%;
        padding: 0.6rem;
        background: rgba(255, 82, 82, 0.1);
        border: 1px solid rgba(255, 82, 82, 0.3);
        border-radius: 8px;
        color: rgba(255, 255, 255, 0.8);
        font-family: 'Outfit', sans-serif;
        font-size: 0.8rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
    }
    
    .logout-btn:hover {
        background: rgba(255, 82, 82, 0.2);
        border-color: rgba(255, 82, 82, 0.5);
        color: #ff5252;
        transform: translateY(-2px);
    }
    
    .logout-icon {
        font-size: 1rem;
    }
    
    /* ===== MAIN CONTENT ===== */
    .main-content {
        flex: 1;
        margin-left: 280px;
        padding: 1.25rem;
        position: relative;
        z-index: 2;
        box-sizing: border-box;
        overflow-x: hidden;
        max-width: calc(100% - 280px);
    }
    
    /* Marca de agua del logo */
    .main-content::before {
        content: '';
        position: fixed;
        top: 50%;
        left: calc(280px + (100% - 280px) / 2); /* Centrado en el área de contenido */
        transform: translate(-50%, -50%);
        width: 400px;
        height: 400px;
        background-image: url('/static/images/logo.png');
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
        opacity: 0.03;
        pointer-events: none;
        z-index: 0;
    }
    
    
    /* ===== TABS ===== */
    .tabs-container {
        display: flex;
        gap: 0;
        margin-bottom: 2rem;
        border-bottom: 1px solid rgba(108, 168, 164, 0.2);
        width: 100%;
    }
    
    .tab-btn {
        flex: 1;
        padding: 1rem 2rem;
        background: transparent;
        border: none;
        color: rgba(255, 255, 255, 0.6);
        font-family: 'Outfit', sans-serif;
        font-size: 0.95rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        text-align: center;
    }
    
    .tab-btn:hover {
        color: #fff;
        background: rgba(108, 168, 164, 0.1);
    }
    
    .tab-btn.active {
        color: #6CA8A4;
    }
    
    .tab-btn.active::after {
        content: '';
        position: absolute;
        bottom: -1px;
        left: 0;
        right: 0;
        height: 2px;
        background: linear-gradient(90deg, #6CA8A4 0%, #1D4744 100%);
    }
    
    /* ===== SECTION HEADERS ===== */
    .section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 2rem;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid rgba(108, 168, 164, 0.3);
    }
    
    .section-header.kpis-header {
        padding-bottom: 1rem;
        margin-bottom: 0.5rem;
        border-bottom: 1px solid rgba(108, 168, 164, 0.3);
    }
    
    .section-title {
        font-family: 'Montserrat', sans-serif;
        font-size: 1.5rem;
        font-weight: 700;
        color: #ffffff;
        text-transform: uppercase;
        letter-spacing: 3px;
        margin: 0;
        white-space: nowrap;
    }
    
    .section-title.small {
        font-size: 1rem;
        letter-spacing: 1.5px;
    }
    
    .section-info {
        display: flex;
        align-items: center;
        gap: 1.25rem;
        max-width: 650px;
    }
    
    .section-info p {
        margin: 0;
        font-family: 'Outfit', sans-serif;
        font-size: 1rem;
        color: #ffffff;
        line-height: 1.6;
    }
    
    .section-description {
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
        padding: 0.75rem 0;
    }
    
    .section-description p {
        margin: 0;
        font-family: 'Outfit', sans-serif;
        font-size: 1rem;
        color: #ffffff;
    }
    
    .info-icon {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 28px;
        height: 28px;
        border: 2px solid #6CA8A4;
        border-radius: 50%;
        font-family: 'Georgia', serif;
        font-size: 1rem;
        font-style: italic;
        font-weight: 600;
        color: #6CA8A4;
        flex-shrink: 0;
    }
    
    /* ===== KPI CARDS ===== */
    .kpi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .kpi-card {
        background: rgba(20, 40, 40, 0.35) !important;
        border: 1px solid rgba(108, 168, 164, 0.25);
        border-radius: 12px;
        padding: 0.9rem;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        min-height: 180px;
        backdrop-filter: blur(5px);
    }
    
    .kpi-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, #6CA8A4 0%, #1D4744 100%);
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .kpi-card:hover {
        transform: translateY(-4px);
        border-color: rgba(108, 168, 164, 0.4);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }
    
    .kpi-card:hover::before {
        opacity: 1;
    }
    
    .kpi-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 0.5rem;
    }
    
    .kpi-title {
        font-family: 'Montserrat', sans-serif;
        font-size: 0.85rem;
        font-weight: 600;
        color: #ffffff;
    }
    
    .kpi-value-row {
        display: flex;
        align-items: center;
        gap: 1rem;
        flex: 1;
        justify-content: flex-start;
        padding: 0.5rem 0;
    }
    
    .kpi-growth-container {
        display: flex;
        flex-direction: column;
        flex: 1;
        justify-content: center;
    }
    
    .kpi-value {
        font-family: 'Space Grotesk', sans-serif;
        font-size: 2.5rem;
        font-weight: 700;
        color: #fff;
    }
    
    .kpi-delta {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        font-family: 'Outfit', sans-serif;
        font-size: 0.95rem;
        font-weight: 600;
    }
    
    .kpi-delta.positive {
        color: #4CAF50;
    }
    
    .kpi-delta.negative {
        color: #f44336;
    }
    
    /* Crecimiento con colores */
    .kpi-growth-value {
        font-family: 'Space Grotesk', sans-serif;
        font-size: 1.6rem;
        font-weight: 700;
        margin-bottom: 0.25rem;
    }
    
    .kpi-growth-value.positive {
        color: #4CAF50;
    }
    
    .kpi-growth-value.negative {
        color: #f44336;
    }
    
    .kpi-subtitle {
        font-family: 'Outfit', sans-serif;
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.5);
        margin-top: auto;
        padding-top: 1rem;
        text-align: center;
        font-style: italic;
    }
    
    /* ===== INSIGHT BOX ===== */
    .insight-box {
        background: linear-gradient(135deg, rgba(108, 168, 164, 0.7) 0%, rgba(29, 71, 68, 0.65) 100%);
        border: 1px solid rgba(108, 168, 164, 0.4);
        border-radius: 12px;
        padding: 1.5rem;
        display: flex;
        gap: 1.25rem;
        align-items: center;
        margin-bottom: 2rem;
    }
    
    .insight-icon {
        font-size: 2.2rem;
        color: #FFD700;
        animation: lightBulbGlow 2s ease-in-out infinite;
        filter: drop-shadow(0 0 5px rgba(255, 215, 0, 0.5));
    }
    
    @keyframes lightBulbGlow {
        0%, 100% {
            filter: drop-shadow(0 0 5px rgba(255, 215, 0, 0.3));
            opacity: 0.85;
        }
        50% {
            filter: drop-shadow(0 0 15px rgba(255, 215, 0, 0.9)) drop-shadow(0 0 25px rgba(255, 215, 0, 0.5));
            opacity: 1;
        }
    }
    
    .insight-content {
        flex: 1;
    }
    
    .insight-title {
        font-family: 'Space Grotesk', sans-serif;
        font-size: 0.9rem;
        font-weight: 600;
        color: #FFD700;
        margin-bottom: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    .insight-text {
        font-family: 'Outfit', sans-serif;
        font-size: 0.95rem;
        color: #000000;
        line-height: 1.7;
        font-weight: 500;
    }
    
    .insight-text .data-positive {
        color: #00ff00;
        font-weight: 700;
        text-shadow: 0 0 2px rgba(0, 0, 0, 0.3);
    }
    
    .insight-text .data-negative {
        color: #ff4444;
        font-weight: 700;
        text-shadow: 0 0 2px rgba(0, 0, 0, 0.3);
    }
    
    .insight-text .data-neutral {
        color: #1a1a1a;
        font-weight: 700;
    }
    
    /* ===== LOADING STATE ===== */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
    }
    
    .loading-overlay.active {
        opacity: 1;
        visibility: visible;
    }
    
    /* ===== VOLCANO ERUPTION LOADER ===== */
    .loading-spinner {
        width: 100px;
        height: 120px;
        position: relative;
        display: flex;
        justify-content: center;
        align-items: flex-end; /* Alineado abajo */
    }

    /* El núcleo del volcán (base brillante) */
    .volcano-core {
        position: absolute;
        bottom: 0;
        width: 60px;
        height: 30px;
        background: radial-gradient(circle, #ffaa00 0%, #ff4444 50%, transparent 100%);
        border-radius: 50% 50% 0 0;
        box-shadow: 0 0 30px rgba(255, 68, 68, 0.8);
        animation: magmaPulse 0.8s ease-in-out infinite alternate;
        z-index: 2;
    }

    /* Partículas de lava */
    .ember {
        position: absolute;
        bottom: 10px;
        width: 12px;
        height: 12px;
        background: #ffaa00;
        border-radius: 50%;
        box-shadow: 0 0 10px #ffaa00;
        opacity: 0;
        animation: eruption 2s linear infinite;
    }

    /* Aleatoriedad para las partículas */
    .ember:nth-child(2) { left: 45%; width: 15px; height: 15px; animation-duration: 1.8s; animation-delay: 0.1s; }
    .ember:nth-child(3) { left: 55%; width: 8px; height: 8px; animation-duration: 2.2s; animation-delay: 0.3s; background: #ff4444; }
    .ember:nth-child(4) { left: 40%; width: 10px; height: 10px; animation-duration: 1.5s; animation-delay: 0.5s; }
    .ember:nth-child(5) { left: 60%; width: 12px; height: 12px; animation-duration: 2.5s; animation-delay: 0.2s; background: #ff4444; }
    .ember:nth-child(6) { left: 48%; width: 6px; height: 6px; animation-duration: 1.2s; animation-delay: 0.7s; }
    .ember:nth-child(7) { left: 52%; width: 14px; height: 14px; animation-duration: 2.0s; animation-delay: 0.4s; }
    .ember:nth-child(8) { left: 35%; width: 9px; height: 9px; animation-duration: 2.3s; animation-delay: 0.6s; background: #ffcc00; }
    .ember:nth-child(9) { left: 65%; width: 7px; height: 7px; animation-duration: 1.7s; animation-delay: 0.8s; }

    @keyframes magmaPulse {
        0% { transform: scale(1); opacity: 0.8; }
        100% { transform: scale(1.1); opacity: 1; box-shadow: 0 0 50px rgba(255, 100, 0, 0.8); }
    }

    @keyframes eruption {
        0% {
            bottom: 10px;
            opacity: 1;
            transform: scale(1) translateX(0);
        }
        50% {
            opacity: 0.8;
            transform: scale(0.8) translateX(var(--drift, 10px)); /* Movimiento lateral */
        }
        100% {
            bottom: 140px; /* Suben alto */
            opacity: 0;
            transform: scale(0) translateX(var(--drift-end, -20px));
            background: #880000; /* Se enfrían a rojo oscuro/humo */
        }
    }

    /* Asignar drift aleatorio con variables CSS en las reglas nth-child si fuera SCSS, 
       pero aquí lo simularé con keyframes ligeramente distintos o hardcodeando valores en el keyframe generico 
       es complicado sin preprocesador, así que usaré un truco de margins */
    
    .ember:nth-child(odd) { --drift: 15px; --drift-end: 30px; }
    .ember:nth-child(even) { --drift: -15px; --drift-end: -30px; }


    .loading-text {
        margin-top: 0.5rem; /* Ajuste porque el spinner es más alto */
        font-family: 'Montserrat', sans-serif;
        font-size: 0.85rem;
        font-weight: 700;
        color: rgba(255, 255, 255, 0.9);
        letter-spacing: 4px;
        text-transform: uppercase;
        text-shadow: 0 0 10px rgba(255, 80, 80, 0.5);
        animation: textGlow 1.5s ease-in-out infinite alternate;
    }
    
    @keyframes textGlow {
        from { text-shadow: 0 0 10px rgba(255, 68, 68, 0.5); opacity: 0.8; }
        to { text-shadow: 0 0 20px rgba(255, 150, 50, 0.8); opacity: 1; }
    }
    
    /* ===== DATA TABLE ===== */
    .data-table-container {
        background: rgba(20, 20, 20, 0.9);
        border: 1px solid rgba(108, 168, 164, 0.2);
        border-radius: 16px;
        overflow: hidden;
    }
    
    .data-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .data-table th {
        background: rgba(108, 168, 164, 0.1);
        padding: 1rem;
        text-align: left;
        font-family: 'Space Grotesk', sans-serif;
        font-size: 0.8rem;
        font-weight: 600;
        color: rgba(255, 255, 255, 0.8);
        text-transform: uppercase;
        letter-spacing: 1px;
        border-bottom: 1px solid rgba(108, 168, 164, 0.2);
    }
    
    .data-table td {
        padding: 1rem;
        font-family: 'Outfit', sans-serif;
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.7);
        border-bottom: 1px solid rgba(108, 168, 164, 0.1);
    }
    
    .data-table tr:hover td {
        background: rgba(108, 168, 164, 0.05);
        color: #fff;
    }
    
    /* Estilos para tablas editables */
    .editable-table td[contenteditable="true"] {
        cursor: text;
        transition: all 0.2s ease;
        min-width: 80px;
    }
    
    .editable-table td[contenteditable="true"]:hover {
        background: rgba(108, 168, 164, 0.1);
    }
    
    .editable-table td[contenteditable="true"]:focus {
        background: rgba(108, 168, 164, 0.15);
        outline: 2px solid rgba(108, 168, 164, 0.4);
        outline-offset: -2px;
    }
    
    .btn-add-row {
        transition: all 0.2s ease;
    }
    
    .btn-add-row:hover {
        background: #5a9a96 !important;
        transform: translateY(-1px);
    }
    
    /* Expander Styles */
    .expander-container {
        background: rgba(108, 168, 164, 0.05);
        border: 1px solid rgba(108, 168, 164, 0.2);
        border-radius: 8px;
        overflow: hidden;
        transition: all 0.3s ease;
    }
    
    .expander-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.5rem;
        background: rgba(108, 168, 164, 0.1);
        cursor: pointer;
        transition: all 0.2s ease;
        user-select: none;
    }
    
    .expander-header:hover {
        background: rgba(108, 168, 164, 0.15);
    }
    
    .expander-title {
        font-family: 'Montserrat', sans-serif;
        font-size: 1rem;
        font-weight: 600;
        color: #fff;
        margin: 0;
    }
    
    .expander-icon {
        font-size: 0.9rem;
        color: #6CA8A4;
        transition: transform 0.3s ease;
    }
    
    .expander-container.expanded .expander-icon {
        transform: rotate(180deg);
    }
    
    .expander-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
        padding: 0 1.5rem;
    }
    
    .expander-container.expanded .expander-content {
        max-height: 5000px;
        padding: 1.5rem;
    }
    
    /* Tab Content */
    .tab-content {
        display: none;
        width: 100%;
        box-sizing: border-box;
        overflow-x: hidden;
    }
    
    .tab-content.active {
        display: block;
        width: 100%;
        box-sizing: border-box;
        overflow-x: hidden;
    }
    
    /* ===== CHART SECTION ===== */
    .chart-section {
        margin-top: 2rem;
        padding: 2rem 1rem 1rem 1rem;
        border-top: 1px solid rgba(108, 168, 164, 0.2);
        overflow: visible;
    }
    
    /* Chart Sub-Tabs */
    .chart-tabs-container {
        display: flex;
        gap: 0;
        margin-bottom: 1.5rem;
        margin-right: 0;
        background: rgba(10, 10, 10, 0.4);
        border-radius: 12px;
        padding: 4px;
        border: 1px solid rgba(108, 168, 164, 0.15);
    }
    
    .chart-tab-btn {
        flex: 1;
        padding: 0.75rem 1.5rem;
        background: transparent;
        border: none;
        color: rgba(255, 255, 255, 0.6);
        font-family: 'Montserrat', sans-serif;
        font-size: 0.85rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        border-radius: 10px;
    }
    
    .chart-tab-btn:hover {
        color: #fff;
        background: rgba(108, 168, 164, 0.15);
    }
    
    .chart-tab-btn.active {
        background: linear-gradient(135deg, rgba(29, 71, 68, 0.9) 0%, rgba(98, 169, 167, 0.7) 100%);
        color: #fff;
        font-weight: 600;
        box-shadow: 0 2px 8px rgba(108, 168, 164, 0.3);
    }
    
    .chart-tab-content {
        display: none;
        padding: 0;
        width: 100%;
        box-sizing: border-box;
    }
    
    .chart-tab-content.active {
        display: block;
        padding: 0;
        width: 100%;
        box-sizing: border-box;
    }
    
    .chart-title {
        font-family: 'Montserrat', sans-serif;
        font-size: 0.95rem;
        font-weight: 600;
        color: #fff;
        margin-bottom: 0.5rem;
        margin-top: 1rem;
    }
    
    .chart-controls {
        margin-bottom: 1.5rem;
    }
    
    .chart-controls label {
        display: block;
        color: rgba(255,255,255,0.7);
        font-family: 'Montserrat', sans-serif;
        font-size: 0.85rem;
        margin-bottom: 0.5rem;
    }
    
    .metric-select {
        font-family: 'Montserrat', sans-serif;
        padding: 0.85rem 1.25rem;
        background: rgba(29, 71, 68, 0.5);
        border: 1px solid rgba(108, 168, 164, 0.3);
        border-radius: 12px;
        color: #fff;
        font-size: 0.95rem;
        cursor: pointer;
        width: 100%;
        display: block;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236CA8A4' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 1.25rem center;
        padding-right: 3rem;
    }
    
    .metric-select:hover {
        border-color: rgba(108, 168, 164, 0.6);
        background-color: rgba(29, 71, 68, 0.7);
    }
    
    .metric-select:focus {
        outline: none;
        border-color: #6CA8A4;
        box-shadow: 0 0 0 2px rgba(108, 168, 164, 0.2);
    }
    
    .metric-select option {
        background: #1a1a1a;
        color: #fff;
        padding: 0.5rem;
    }
    
    /* ===== CHANNEL TABLE ===== */
    .channel-table-container {
        background: rgba(10, 10, 10, 0.6);
        border: 1px solid rgba(108, 168, 164, 0.2);
        border-radius: 12px;
        overflow: hidden;
        margin-bottom: 1.5rem;
    }
    
    .channel-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .channel-table thead {
        background: rgba(108, 168, 164, 0.15);
    }
    
    .channel-table th {
        font-family: 'Montserrat', sans-serif;
        font-size: 0.75rem;
        font-weight: 600;
        color: #6CA8A4;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        padding: 0.85rem 1rem;
        text-align: left;
        border-bottom: 1px solid rgba(108, 168, 164, 0.2);
    }
    
    .channel-table th:not(:first-child) {
        text-align: center;
    }
    
    .channel-table tbody tr {
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        transition: background 0.2s ease;
    }
    
    .channel-table tbody tr:hover {
        background: rgba(108, 168, 164, 0.08);
    }
    
    .channel-table tbody tr:last-child {
        border-bottom: none;
    }
    
    .channel-table td {
        font-family: 'Outfit', sans-serif;
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.9);
        padding: 0.75rem 1rem;
        text-align: left;
    }
    
    .channel-table td:not(:first-child) {
        text-align: center;
    }
    
    .channel-name {
        font-weight: 600;
        color: #fff;
    }
    
    .channel-value {
        font-family: 'Space Grotesk', sans-serif;
        font-weight: 700;
        font-size: 0.95rem;
        color: #fff;
    }
    
    .channel-delta {
        font-size: 0.75rem;
        font-weight: 500;
        margin-left: 0.35rem;
    }
    
    .channel-delta.positive {
        color: #4CAF50;
    }
    
    .channel-delta.negative {
        color: #ff5252;
    }
    
    .channel-delta .arrow {
        font-size: 0.65rem;
        margin-right: 2px;
    }
    
    .engagement-value {
        font-family: 'Space Grotesk', sans-serif;
        font-weight: 600;
        color: rgba(255, 255, 255, 0.8);
    }
    
    .wow-value, .mom-value {
        font-family: 'Space Grotesk', sans-serif;
        font-weight: 600;
    }
    
    .wow-value.positive, .mom-value.positive {
        color: #4CAF50;
    }
    
    .wow-value.negative, .mom-value.negative {
        color: #ff5252;
    }
    
    .table-detail-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.25rem;
        background: rgba(108, 168, 164, 0.1);
        border: 1px solid rgba(108, 168, 164, 0.2);
        border-top: none;
        color: #6CA8A4;
        font-family: 'Montserrat', sans-serif;
        font-size: 0.8rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        width: 100%;
        justify-content: center;
    }
    
    .table-detail-btn:hover {
        background: rgba(108, 168, 164, 0.2);
        color: #fff;
    }
    
    .table-detail-btn .arrow-icon {
        transition: transform 0.2s ease;
    }
    
    .table-detail-btn:hover .arrow-icon {
        transform: translateX(3px);
    }
    
    .charts-row {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
    }
    
    .chart-wrapper {
        background: rgba(10, 10, 10, 0.4);
        border: 1px solid rgba(108, 168, 164, 0.15);
        border-radius: 10px;
        padding: 1rem;
    }
    
    .chart-container {
        background: rgba(10, 10, 10, 0.6);
        border: 1px solid rgba(108, 168, 164, 0.2);
        border-radius: 10px;
        padding: 0.75rem;
        min-height: 320px;
        width: 100%;
        box-sizing: border-box;
        overflow: hidden;
    }
    
    /* ===== GEOGRAPHY SECTION ===== */
    .geo-section {
        margin-top: 1.5rem;
    }
    
    .geo-columns {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        margin-top: 1rem;
    }
    
    .geo-column {
        background: rgba(10, 10, 10, 0.6);
        border: 1px solid rgba(108, 168, 164, 0.2);
        border-radius: 12px;
        padding: 1rem;
    }
    
    .geo-column-title {
        font-family: 'Montserrat', sans-serif;
        font-size: 0.9rem;
        font-weight: 600;
        color: #fff;
        margin: 0 0 1rem 0;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid rgba(108, 168, 164, 0.2);
    }
    
    .geo-list {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .geo-item {
        display: grid;
        grid-template-columns: 30px 1fr auto;
        align-items: center;
        gap: 0.5rem;
        padding: 0.7rem 1rem;
        background: rgba(108, 168, 164, 0.08);
        border-radius: 8px;
        transition: background 0.2s ease;
    }
    
    .geo-item:hover {
        background: rgba(108, 168, 164, 0.15);
    }
    
    .geo-item-bar {
        display: none;
    }
    
    .geo-item-rank {
        font-family: 'Montserrat', sans-serif;
        font-weight: 700;
        font-size: 0.9rem;
        color: #6CA8A4;
        text-align: center;
    }
    
    .geo-item-name {
        font-family: 'Outfit', sans-serif;
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.9);
        text-align: left;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .geo-item-value {
        font-family: 'Montserrat', sans-serif;
        font-weight: 600;
        font-size: 0.9rem;
        color: #fff;
        text-align: right;
    }
    
    .loading-text {
        color: rgba(255, 255, 255, 0.5);
        font-style: italic;
        text-align: center;
        padding: 1rem;
    }
    
    /* ===== ALERTS PAGE ===== */
    .alert-section {
        margin-top: 1.5rem;
    }
    
    .alert-top-box {
        background: rgba(10, 10, 10, 0.6);
        border: 1px solid rgba(108, 168, 164, 0.3);
        border-left: 4px solid #FFB347;
        border-radius: 12px;
        padding: 1.5rem;
        margin-top: 1rem;
    }
    
    .alert-details {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .alert-details li {
        font-family: 'Outfit', sans-serif;
        font-size: 0.95rem;
        color: rgba(255, 255, 255, 0.9);
        margin-bottom: 0.75rem;
        line-height: 1.5;
    }
    
    .alert-details li strong {
        color: #fff;
        font-family: 'Montserrat', sans-serif;
    }
    
    .alert-stats-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-top: 1rem;
    }
    
    .alert-stat-box {
        background: rgba(10, 10, 10, 0.6);
        border: 1px solid rgba(108, 168, 164, 0.2);
        border-radius: 12px;
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
    }
    
    .alert-stat-label {
        font-family: 'Montserrat', sans-serif;
        font-size: 0.75rem;
        font-weight: 600;
        color: rgba(255, 255, 255, 0.6);
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 0.5rem;
    }
    
    .alert-stat-value {
        font-family: 'Montserrat', sans-serif;
        font-size: 2.5rem;
        font-weight: 700;
        color: #fff;
    }
    
    .alert-status {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-family: 'Montserrat', sans-serif;
        font-size: 1.1rem;
        font-weight: 600;
    }
    
    .status-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        animation: pulse 2s infinite;
    }
    
    .status-dot.normal { background: #6CA8A4; }
    .status-dot.warning { background: #FFB347; }
    .status-dot.anomaly { background: #FF6B6B; }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.6; transform: scale(1.1); }
    }
    
    .alert-types-row {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        margin-top: 1rem;
    }
    
    .alert-type-box {
        background: rgba(10, 10, 10, 0.6);
        border: 1px solid rgba(108, 168, 164, 0.2);
        border-radius: 12px;
        padding: 1rem 1.5rem;
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    
    .alert-type-box.critical {
        border-left: 4px solid #FF6B6B;
    }
    
    .alert-type-box.moderate {
        border-left: 4px solid #FFB347;
    }
    
    .alert-type-box.info {
        border-left: 4px solid #6CA8A4;
    }
    
    .alert-type-label {
        font-family: 'Montserrat', sans-serif;
        font-size: 0.85rem;
        font-weight: 600;
        color: rgba(255, 255, 255, 0.8);
    }
    
    .alert-type-value {
        font-family: 'Montserrat', sans-serif;
        font-size: 1.8rem;
        font-weight: 700;
        color: #fff;
    }
    
    .alert-type-pct {
        font-family: 'Outfit', sans-serif;
        font-size: 0.7rem;
        color: rgba(255, 255, 255, 0.5);
        text-transform: uppercase;
        margin-left: auto;
    }
    
    .alerts-list {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        margin-top: 1rem;
    }
    
    .alert-item {
        background: rgba(10, 10, 10, 0.6);
        border: 1px solid rgba(108, 168, 164, 0.2);
        border-radius: 10px;
        padding: 1rem 1.25rem;
        display: flex;
        align-items: flex-start;
        gap: 1rem;
    }
    
    .alert-item.critical { border-left: 4px solid #FF6B6B; }
    .alert-item.moderate { border-left: 4px solid #FFB347; }
    .alert-item.info { border-left: 4px solid #6CA8A4; }
    
    .alert-item-icon {
        font-size: 1.2rem;
        flex-shrink: 0;
    }
    
    .alert-item-content {
        flex: 1;
    }
    
    .alert-item-title {
        font-family: 'Montserrat', sans-serif;
        font-size: 0.9rem;
        font-weight: 600;
        color: #fff;
        margin-bottom: 0.25rem;
    }
    
    .alert-item-desc {
        font-family: 'Outfit', sans-serif;
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.7);
    }
    
    .alert-item-meta {
        font-family: 'Outfit', sans-serif;
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.5);
        text-align: right;
        flex-shrink: 0;
    }
    
    /* ========================================
       TABLA DE RANKING DE CONTENIDO
    ======================================== */
    .content-table-container {
        background: rgba(0, 0, 0, 0.3);
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid rgba(255, 255, 255, 0.08);
    }
    
    .content-ranking-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.85rem;
    }
    
    .content-ranking-table thead {
        background: rgba(0, 0, 0, 0.4);
    }
    
    .content-ranking-table th {
        padding: 1rem 1.25rem;
        text-align: left;
        font-weight: 600;
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: rgba(255, 255, 255, 0.6);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .content-ranking-table th.col-metric {
        text-align: left;
        width: 140px;
    }
    
    .content-ranking-table th.col-title {
        width: 40%;
    }
    
    .content-ranking-table tbody tr {
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        transition: background 0.2s ease;
    }
    
    .content-ranking-table tbody tr:hover {
        background: rgba(255, 255, 255, 0.03);
    }
    
    .content-ranking-table td {
        padding: 0.9rem 1.25rem;
        vertical-align: middle;
    }
    
    .content-ranking-table .page-title {
        color: rgba(255, 255, 255, 0.9);
        font-weight: 500;
        line-height: 1.4;
    }
    
    .content-ranking-table .metric-cell {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
    }
    
    .content-ranking-table .metric-value {
        font-weight: 600;
        color: #fff;
        font-size: 0.95rem;
    }
    
    .content-ranking-table .metric-bar {
        height: 4px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 2px;
        overflow: hidden;
        width: 80px;
    }
    
    .content-ranking-table .metric-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #3b82f6, #60a5fa);
        border-radius: 2px;
        transition: width 0.5s ease;
    }
    
    .content-ranking-table .bounce-rate {
        font-weight: 600;
        color: #fff;
    }
    
    .content-ranking-table .bounce-rate.high {
        color: #f87171;
    }
    
    .content-ranking-table .bounce-rate.medium {
        color: #fbbf24;
    }
    
    .content-ranking-table .bounce-rate.low {
        color: #34d399;
    }
    
    /* ========================================
       TRAFFIC SUB-TABS (Análisis General / SEO)
    ======================================== */
    .traffic-subtabs {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
        border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        padding-bottom: 0;
    }
    
    .traffic-subtab-btn {
        padding: 0.85rem 1.75rem;
        background: transparent;
        border: none;
        border-bottom: 3px solid transparent;
        color: rgba(255, 255, 255, 0.5);
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        margin-bottom: -2px;
    }
    
    .traffic-subtab-btn:hover {
        color: rgba(255, 255, 255, 0.8);
        background: rgba(255, 255, 255, 0.03);
    }
    
    .traffic-subtab-btn.active {
        color: #f0b429;
        border-bottom-color: #f0b429;
    }
    
    .traffic-subtab-content {
        display: none;
    }
    
    .traffic-subtab-content.active {
        display: block;
    }
    
    /* ========================================
       ORGANIC QUERIES/PAGES SECTION
    ======================================== */
    .organic-section {
        margin-top: 2rem;
    }
    
    .organic-tabs {
        display: flex;
        gap: 0;
        margin-bottom: 0;
    }
    
    .organic-tab-btn {
        padding: 0.75rem 1.5rem;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-bottom: none;
        color: rgba(255, 255, 255, 0.6);
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        border-radius: 8px 8px 0 0;
    }
    
    .organic-tab-btn:hover {
        background: rgba(255, 255, 255, 0.05);
        color: rgba(255, 255, 255, 0.8);
    }
    
    .organic-tab-btn.active {
        background: rgba(0, 0, 0, 0.5);
        color: #f0b429;
        border-color: rgba(240, 180, 41, 0.3);
    }
    
    .organic-tab-content {
        display: none;
        padding: 1.5rem;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 0 12px 12px 12px;
    }
    
    .organic-tab-content.active {
        display: block;
    }
    
    .organic-table-container {
        overflow-x: auto;
    }
    
    .organic-ranking-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.85rem;
    }
    
    .organic-ranking-table thead {
        background: rgba(0, 0, 0, 0.4);
    }
    
    .organic-ranking-table th {
        padding: 0.9rem 1rem;
        text-align: left;
        font-weight: 600;
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: rgba(255, 255, 255, 0.6);
        border-bottom: 1px solid rgba(255, 255, 255, 0.15);
    }
    
    .organic-ranking-table th.col-query {
        width: 30%;
    }
    
    .organic-ranking-table th.col-metric {
        text-align: center;
        width: 12%;
    }
    
    .organic-ranking-table th.col-delta {
        width: 22%;
    }
    
    .organic-ranking-table tbody tr {
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        transition: background 0.2s ease;
    }
    
    .organic-ranking-table tbody tr:hover {
        background: rgba(255, 255, 255, 0.03);
    }
    
    .organic-ranking-table td {
        padding: 0.8rem 1rem;
        vertical-align: middle;
        color: rgba(255, 255, 255, 0.9);
    }
    
    .organic-ranking-table td.query-cell {
        font-weight: 500;
    }
    
    .organic-ranking-table td.metric-cell {
        text-align: center;
        font-weight: 600;
    }
    
    .organic-ranking-table td.delta-cell {
        font-size: 0.8rem;
    }
    
    .organic-ranking-table .delta-positive {
        color: #34d399;
    }
    
    .organic-ranking-table .delta-negative {
        color: #f87171;
    }
    
    .organic-ranking-table .delta-neutral {
        color: rgba(255, 255, 255, 0.5);
    }
    
    /* Header row con info y selector */
    .organic-header-row {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 1rem;
        margin-bottom: 1rem;
    }
    
    .organic-header-row .section-info {
        flex: 1;
    }
    
    /* Top selector buttons */
    .top-selector {
        display: flex;
        gap: 0.25rem;
        flex-shrink: 0;
    }
    
    .top-btn {
        padding: 0.4rem 0.8rem;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 6px;
        color: rgba(255, 255, 255, 0.6);
        font-size: 0.75rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .top-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        color: rgba(255, 255, 255, 0.9);
    }
    
    .top-btn.active {
        background: rgba(240, 180, 41, 0.15);
        border-color: #f0b429;
        color: #f0b429;
    }
    
</style>
{% endblock %}

{% block body %}
<!-- Video Background -->
<video autoplay muted loop playsinline class="video-background">
    <source src="{{ url_for('static', filename='video/background.mp4') }}" type="video/mp4">
</video>
<div class="video-overlay"></div>

<div class="dashboard-wrapper">
    <!-- Sidebar -->
    <aside class="sidebar">
        <!-- Header con logo -->
        <div class="sidebar-header">
            <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Crata AI" class="sidebar-logo">
        </div>
        
        <!-- Smart Assistant -->
        <div class="assistant-box no-alerts" id="assistantBox">
            <div class="assistant-header">
                <div class="assistant-avatar">🤖</div>
                <div class="assistant-info">
                    <p class="assistant-name">Crata Assistant</p>
                    <p class="assistant-status">Activo</p>
                </div>
            </div>
            <!-- Variable con el nombre del usuario para JavaScript -->
            <script>window.userName = "{{ user_name or user_email.split('@')[0] if user_email else 'Usuario' }}";</script>
            <a href="/realtime" class="assistant-realtime" id="assistantRealtime" title="Ver tracking en tiempo real">
                <span class="realtime-icon">👁️</span>
                <span class="realtime-label">Usuarios activos ahora:</span>
                <span class="realtime-value" id="realtimeUsers">--</span>
                <span class="realtime-arrow">→</span>
            </a>
            <div class="assistant-message" id="assistantMessage">
                ¡Hola, <strong>{{ user_name or user_email.split('@')[0] if user_email else 'Usuario' }}</strong>! Estoy analizando tus datos...
            </div>
            <div class="assistant-action" id="assistantAction">
                <a href="/alerts" class="assistant-btn secondary">Ver Alertas</a>
            </div>
        </div>
        
        <nav class="sidebar-nav">
            <p class="nav-section-title">Navegación</p>
            
            <a href="/dashboard" class="nav-item {{ 'active' if active_page == 'general_overview' else '' }}" title="Visión general del tráfico web, métricas de visitas, usuarios y tendencias principales.">
                <span>Tráfico General</span>
            </a>
            
            <a href="/user-behavior" class="nav-item {{ 'active' if active_page == 'user_behavior' else '' }}" title="Patrones de navegación, tiempo en página, rebote y recorridos de usuario.">
                <span>Comportamiento Usuarios</span>
            </a>
            
            <a href="/alerts"
                id="alertsNavItem"
                class="nav-item {{ 'active' if active_page == 'alerts' else '' }}"
                title="Sistema de alertas y notificaciones sobre cambios significativos en métricas.">
                    <span>Alertas</span>
                </a>
            
            <a href="/diana" class="nav-item {{ 'active' if active_page == 'diana' else '' }}" title="Diana - Métricas de mensajería: mensajes enviados, respuestas, leads, reuniones.">
                <span>Diana</span>
            </a>
            
            <a href="/apollo" class="nav-item {{ 'active' if active_page == 'apollo' else '' }}" title="Apollo.io - Datos crudos de la API, contactos y emails.">
                <span>Apollo</span>
            </a>

            <a href="/leads" class="nav-item {{ 'active' if active_page == 'leads' else '' }}" title="Gestión centralizada de leads de todas las fuentes.">
                <span>Leads</span>
            </a>
            
            <a href="/team" class="nav-item {{ 'active' if active_page == 'team' else '' }}" title="Gestión de equipos y métricas de growth.">
                <span>Team</span>
            </a>

        </nav>
        
        <!-- Filters Section -->
        <div class="filter-section">
            <p class="filter-title">Filtros de Fecha</p>
            
            <div class="filter-group">
                <label class="filter-label">Filtro Rápido</label>
                <select class="filter-select" id="quickFilter">
                    <option value="7">Últimos 7 días</option>
                    <option value="28">Últimos 28 días</option>
                    <option value="30">Últimos 30 días</option>
                    <option value="90">Últimos 90 días</option>
                    <option value="custom">Personalizado</option>
                </select>
            </div>
            
            <div class="filter-group" id="customDates" style="display: none;">
                <label class="filter-label">Fecha Inicio</label>
                <input type="date" class="filter-input" id="startDate">
                
                <label class="filter-label" style="margin-top: 0.75rem;">Fecha Fin</label>
                <input type="date" class="filter-input" id="endDate">
            </div>
            
            <p class="filter-title" style="margin-top: 1rem;">Filtros de Página</p>
            
            <div class="filter-group">
                <label class="filter-label">Página</label>
                <select class="filter-select" id="pageFilter">
                    <option value="all">Todas las páginas</option>
                </select>
            </div>
            
            <p class="filter-title" style="margin-top: 1rem;">Filtros de País</p>
            
            <div class="filter-group">
                <label class="filter-label">País</label>
                <select class="filter-select" id="countryFilter">
                    <option value="all">Todos los países</option>
                </select>
            </div>
            
            <p class="filter-title" style="margin-top: 1rem;">Filtros de Tráfico</p>
            
            <div class="filter-group">
                <label class="filter-label">Fuente de Tráfico</label>
                <select class="filter-select" id="trafficSourceFilter">
                    <option value="all">Todas las fuentes</option>
                    <option value="Organic Search">Búsqueda Orgánica</option>
                    <option value="Direct">Tráfico Directo</option>
                    <option value="Referral">Referral</option>
                    <option value="Organic Social">Redes Sociales</option>
                    <option value="Email">Email</option>
                    <option value="Paid Search">Búsqueda Pagada</option>
                    <option value="Display">Display</option>
                </select>
            </div>
            
            <button class="filter-btn" id="applyFiltersBtn">
                Aplicar Filtros
            </button>
            
            <button class="filter-btn secondary" id="clearFiltersBtn" style="margin-top: 0.5rem;">
                Limpiar Filtros
            </button>
        </div>
        
        <!-- User Section -->
        <div class="user-section">
            <div class="user-info-sidebar">
                <span class="user-email">{{ user_email or 'Usuario' }}</span>
            </div>
            <a href="/logout" class="logout-btn" title="Cerrar sesión">
                <span>Cerrar Sesión</span>
                <span class="logout-icon">🚪</span>
            </a>
        </div>
    </aside>
    
    <!-- Main Content -->
    <main class="main-content">
        {% if active_page == 'general_overview' %}
        <!-- Tabs -->
        <div class="tabs-container">
            <button class="tab-btn active" data-tab="vision-general">Visión General</button>
            <button class="tab-btn" data-tab="calidad-trafico">Calidad del Tráfico</button>
            <button class="tab-btn" data-tab="geografia">Geografía</button>
            <button class="tab-btn" data-tab="fuentes-trafico">Fuentes de Tráfico</button>
            <button class="tab-btn" data-tab="pagina-contenido">Página y Contenido</button>
        </div>
        
        <!-- Tab Content: Visión General -->
        <div class="tab-content active" id="vision-general">
            
            <!-- Section Header: Visión General -->
            <div class="section-header">
                <h2 class="section-title">VISIÓN GENERAL</h2>
                <div class="section-info">
                    <span class="info-icon">i</span>
                    <p>Este tab resume el volumen total de tráfico, mostrando cuántos usuarios y sesiones genera la web y cómo evoluciona frente al periodo anterior. Proporciona una lectura rápida para detectar tendencias, cambios de ritmo y variaciones relevantes en la actividad digital.</p>
                </div>
            </div>
            
            <!-- Section Header: KPIs Clave -->
            <div class="section-header kpis-header">
                <h2 class="section-title small">KPIS CLAVE</h2>
            </div>
            <div class="section-description">
                <span class="info-icon">i</span>
                <p>Indicadores principales del rendimiento web: muestran cuántas sesiones y usuarios únicos hemos recibido y cómo está evolucionando el tráfico semana a semana y mes a mes.</p>
            </div>
            
            <!-- KPI Cards -->
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-header">
                        <span class="kpi-title">Sesiones Totales</span>
                    </div>
                    <div class="kpi-value-row">
                        <div class="kpi-value" id="kpi-sessions">--</div>
                        <span class="kpi-delta positive" id="kpi-sessions-delta">↑ --</span>
                    </div>
                    <p class="kpi-subtitle">Total de sesiones en el periodo</p>
                </div>
                
                <div class="kpi-card">
                    <div class="kpi-header">
                        <span class="kpi-title">Total Usuarios</span>
                    </div>
                    <div class="kpi-value-row">
                        <div class="kpi-value" id="kpi-users">--</div>
                        <span class="kpi-delta positive" id="kpi-users-delta">↑ --</span>
                    </div>
                    <p class="kpi-subtitle">Usuarios que pasan más de 5s</p>
                </div>
                
                <div class="kpi-card">
                    <div class="kpi-header">
                        <span class="kpi-title">Crecimiento</span>
                    </div>
                    <div class="kpi-growth-container">
                        <div class="kpi-growth-value" id="kpi-wow">WoW: --</div>
                        <div class="kpi-growth-value" id="kpi-mom">MoM: --</div>
                    </div>
                    <p class="kpi-subtitle">Comparación con periodos anteriores</p>
                </div>
            </div>
            
            <!-- Insight Box -->
            <div class="insight-box">
                <span class="insight-icon">💡</span>
                <div class="insight-content">
                    <p class="insight-text" id="insight-text">
                        Cargando datos para generar insights...
                    </p>
                </div>
            </div>
            
            <!-- Gráficos de KPIs Clave -->
            <div class="chart-section">
                <!-- Section Header: Gráficos -->
                <div class="section-header kpis-header">
                    <h2 class="section-title small">GRÁFICOS DE KPIS CLAVE</h2>
                </div>
                
                <!-- Sub-tabs para gráficos -->
                <div class="chart-tabs-container">
                    <button class="chart-tab-btn active" data-chart-tab="comparacion-periodos">Comparación de Períodos</button>
                    <button class="chart-tab-btn" data-chart-tab="usuarios-tipo">Nuevos vs. Recurrentes</button>
                </div>
                
                <!-- Tab: Comparación de Períodos -->
                <div class="chart-tab-content active" id="comparacion-periodos">
                    <h3 class="chart-title">Comparación Período Actual vs Anterior</h3>
                    <div class="section-description">
                        <span class="info-icon">i</span>
                        <p>El gráfico compara día a día la KPI seleccionada del período actual frente al período anterior, permitiendo identificar variaciones en el comportamiento del tráfico.</p>
                    </div>
                    
                    <div class="chart-controls">
                        <label for="metricSelector">Selecciona la métrica a comparar:</label>
                        <select id="metricSelector" class="metric-select" onchange="updateComparisonChart()">
                            <option value="sessions">Sesiones Totales</option>
                            <option value="totalUsers">Usuarios Únicos</option>
                            <option value="screenPageViews">Páginas Vistas</option>
                        </select>
                    </div>
                    
                    <div class="chart-container" id="comparisonChart"></div>
                    
                    <!-- Insight del gráfico -->
                    <div class="insight-box" style="margin-top: 1.5rem;">
                        <span class="insight-icon">💡</span>
                        <div class="insight-content">
                            <p class="insight-text" id="chart-insight-text">
                                Cargando análisis del gráfico...
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- Tab: Usuarios Nuevos vs Recurrentes -->
                <div class="chart-tab-content" id="usuarios-tipo">
                    <h3 class="chart-title">Usuarios Nuevos vs. Recurrentes</h3>
                    <div class="section-description">
                        <span class="info-icon">i</span>
                        <p>Compara la evolución diaria de usuarios nuevos frente a usuarios que regresan, permitiendo evaluar la capacidad de retención y adquisición.</p>
                    </div>
                    
                    <div class="chart-container" id="usersTypeChart"></div>
                    
                    <!-- Insight del gráfico -->
                    <div class="insight-box" style="margin-top: 1.5rem;">
                        <span class="insight-icon">💡</span>
                        <div class="insight-content">
                            <p class="insight-text" id="users-type-insight-text">
                                Cargando análisis...
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
        
        <!-- Tab Content: Calidad del Tráfico -->
        <div class="tab-content" id="calidad-trafico">
            
            <!-- Section Header: Calidad del Tráfico -->
            <div class="section-header">
                <h2 class="section-title">CALIDAD DEL TRÁFICO</h2>
                <div class="section-info">
                    <span class="info-icon">i</span>
                    <p>Este tab evalúa la calidad real del tráfico recibido, analizando rebotes, usuarios no válidos y la tasa de interacción efectiva. Permite identificar si las visitas son relevantes y detectar posibles señales de ruido o baja intención.</p>
                </div>
            </div>
            
            <!-- Section Header: KPIs Calidad -->
            <div class="section-header kpis-header">
                <h2 class="section-title small">KPIS CALIDAD</h2>
            </div>
            <div class="section-description">
                <span class="info-icon">i</span>
                <p>Estas métricas muestran la calidad del tráfico, identificando cuántos usuarios interactúan realmente, cuántos abandonan enseguida y si el tráfico captado es sólido o de baja relevancia.</p>
            </div>
            
            <!-- KPI Cards -->
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-header">
                        <span class="kpi-title">Tasa de Calidad</span>
                    </div>
                    <div class="kpi-value-row">
                        <div class="kpi-value" id="kpi-quality-rate">--</div>
                        <span class="kpi-delta" id="kpi-quality-rate-delta">--</span>
                    </div>
                    <p class="kpi-subtitle">Usuarios que están > 5 seg</p>
                </div>
                
                <div class="kpi-card">
                    <div class="kpi-header">
                        <span class="kpi-title">Bounce Rate</span>
                    </div>
                    <div class="kpi-value-row">
                        <div class="kpi-value" id="kpi-bounce-rate">--</div>
                        <span class="kpi-delta" id="kpi-bounce-rate-delta">--</span>
                    </div>
                    <p class="kpi-subtitle">Sesión sin ningún evento adicional</p>
                </div>
                
                <div class="kpi-card">
                    <div class="kpi-header">
                        <span class="kpi-title">Usuarios Engaged</span>
                    </div>
                    <div class="kpi-value-row">
                        <div class="kpi-value" id="kpi-engaged-users">--</div>
                        <span class="kpi-delta" id="kpi-engaged-users-delta">--</span>
                    </div>
                    <p class="kpi-subtitle">Usuarios con interacción real</p>
                </div>
            </div>
            
            <!-- Insight Box -->
            <div class="insight-box">
                <span class="insight-icon">💡</span>
                <div class="insight-content">
                    <p class="insight-text" id="quality-insight-text">
                        Cargando análisis de calidad del tráfico...
                    </p>
                </div>
            </div>
            
            <!-- Gráficos de KPIs de Calidad -->
            <div class="chart-section">
                <div class="section-header kpis-header">
                    <h2 class="section-title small">GRÁFICOS DE KPIS DE CALIDAD</h2>
                </div>
                
                <!-- Sub-tabs para gráficos -->
                <div class="chart-tabs-container">
                    <button class="chart-tab-btn active" data-chart-tab="invalid-users-dist">Usuarios No Válidos</button>
                    <button class="chart-tab-btn" data-chart-tab="quality-rate-trend">Tasa de Calidad</button>
                    <button class="chart-tab-btn" data-chart-tab="valid-vs-invalid">Válidos vs No Válidos</button>
                </div>
                
                <!-- Tab: Distribución de Usuarios No Válidos -->
                <div class="chart-tab-content active" id="invalid-users-dist">
                    <h3 class="chart-title">Distribución de Usuarios No Válidos</h3>
                    <div class="section-description">
                        <span class="info-icon">i</span>
                        <p>Visualiza cuántos usuarios salen en menos de 5 segundos. Permite detectar tráfico de baja calidad (bots, campañas mal segmentadas, QR mal escaneado, etc.).</p>
                    </div>
                    
                    <div class="chart-container" id="invalidUsersChart"></div>
                </div>
                
                <!-- Tab: Tasa de Calidad -->
                <div class="chart-tab-content" id="quality-rate-trend">
                    <h3 class="chart-title">Evolución de la Tasa de Calidad</h3>
                    <div class="section-description">
                        <span class="info-icon">i</span>
                        <p>Mide qué porcentaje de usuarios interactúa realmente día a día. Perfecto para evaluar la salud global del tráfico.</p>
                    </div>
                    
                    <div class="chart-container" id="qualityRateChart"></div>
                </div>
                
                <!-- Tab: Válidos vs No Válidos -->
                <div class="chart-tab-content" id="valid-vs-invalid">
                    <h3 class="chart-title">Usuarios Válidos vs. No Válidos</h3>
                    <div class="section-description">
                        <span class="info-icon">i</span>
                        <p>Visualización rápida de la proporción de tráfico útil mediante barras apiladas. Buen KPI de eficiencia de adquisición.</p>
                    </div>
                    
                    <div class="chart-container" id="validVsInvalidChart"></div>
                </div>
            </div>
            
        </div>
        
        <!-- Tab Content: Geografía -->
        <div class="tab-content" id="geografia">
            <!-- Section Header: Geografía -->
            <div class="section-header">
                <h2 class="section-title">GEOGRAFÍA</h2>
                <div class="section-description">
                    <span class="info-icon">i</span>
                    <p>Este tab muestra cómo se distribuye el tráfico por países y ciudades, destacando las áreas con mayor interacción y detectando patrones territoriales relevantes. Facilita identificar mercados activos, anomalías geográficas y oportunidades de segmentación.</p>
                </div>
            </div>
            
            <!-- Sub-tabs para geografía -->
            <div class="chart-tabs-container">
                <button class="chart-tab-btn active" data-chart-tab="geo-ranking-paises">Ranking Países</button>
                <button class="chart-tab-btn" data-chart-tab="geo-ranking-ciudades">Ranking Ciudades</button>
            </div>
            
            <!-- Tab: RANKING DE PAÍSES -->
            <div class="chart-tab-content active" id="geo-ranking-paises">
                <div class="section-description" style="margin-bottom: 1rem;">
                    <span class="info-icon">i</span>
                    <p>Ranking de países ordenado por sesiones engaged. Muestra el peso real de cada mercado con datos de calidad.</p>
                </div>
                
                <!-- Tablas primero -->
                <div class="geo-columns">
                    <div class="geo-column">
                        <h4 class="geo-column-title">Sesiones de Calidad</h4>
                        <div class="geo-list" id="geo-users-list">
                            <p class="loading-text">Cargando...</p>
                        </div>
                    </div>
                    <div class="geo-column">
                        <h4 class="geo-column-title">Por Sesiones Engaged</h4>
                        <div class="geo-list" id="geo-sessions-list">
                            <p class="loading-text">Cargando...</p>
                        </div>
                    </div>
                    <div class="geo-column">
                        <h4 class="geo-column-title">Por Engagement Rate</h4>
                        <div class="geo-list" id="geo-engagement-list">
                            <p class="loading-text">Cargando...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Insight -->
                <div class="insight-box" style="margin-top: 1.5rem;">
                    <span class="insight-icon">💡</span>
                    <div class="insight-content">
                        <p class="insight-text" id="geo-insight-text">
                            Cargando análisis geográfico...
                        </p>
                    </div>
                </div>
                
                <!-- Gráfico: Mapa de Calor -->
                <div class="chart-section" style="margin-top: 2rem; border-top: none; padding-top: 1rem;">
                    <h3 class="chart-title">Mapa de Calor por País</h3>
                    <div class="section-description">
                        <span class="info-icon">i</span>
                        <p>Visualización mundial que muestra de un vistazo dónde se concentra el tráfico. Permite detectar países inesperados o crecimiento en nuevos mercados.</p>
                    </div>
                    <div class="chart-container" id="geoMapChart" style="min-height: 450px;"></div>
                    <div class="insight-box" style="margin-top: 1.5rem;">
                        <span class="insight-icon">💡</span>
                        <div class="insight-content">
                            <p class="insight-text" id="geo-map-insight-text">Cargando análisis del mapa...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Gráfico: Top 10 Países -->
                <div class="chart-section" style="margin-top: 2rem; border-top: none; padding-top: 1rem;">
                    <h3 class="chart-title">Top 10 Países por Sesiones Engaged</h3>
                    <div class="section-description">
                        <span class="info-icon">i</span>
                        <p>Ranking de barras horizontales ordenado por volumen de sesiones. El color indica el nivel de engagement de cada país.</p>
                    </div>
                    <div class="chart-container" id="geoBarChart" style="min-height: 350px;"></div>
                    <div class="insight-box" style="margin-top: 1.5rem;">
                        <span class="insight-icon">💡</span>
                        <div class="insight-content">
                            <p class="insight-text" id="geo-bar-insight-text">Cargando análisis del ranking...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tab: RANKING DE CIUDADES -->
            <div class="chart-tab-content" id="geo-ranking-ciudades">
                <div class="section-description" style="margin-bottom: 1rem;">
                    <span class="info-icon">i</span>
                    <p>Detalle a nivel ciudad para identificar los núcleos urbanos con mayor concentración de tráfico y engagement.</p>
                </div>
                
                <!-- Tablas primero -->
                <div class="geo-columns">
                    <div class="geo-column">
                        <h4 class="geo-column-title">Sesiones de Calidad</h4>
                        <div class="geo-list" id="city-users-list">
                            <p class="loading-text">Cargando...</p>
                        </div>
                    </div>
                    <div class="geo-column">
                        <h4 class="geo-column-title">Por Sesiones Engaged</h4>
                        <div class="geo-list" id="city-sessions-list">
                            <p class="loading-text">Cargando...</p>
                        </div>
                    </div>
                    <div class="geo-column">
                        <h4 class="geo-column-title">Por Engagement Rate</h4>
                        <div class="geo-list" id="city-engagement-list">
                            <p class="loading-text">Cargando...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Insight ciudades -->
                <div class="insight-box" style="margin-top: 1.5rem;">
                    <span class="insight-icon">💡</span>
                    <div class="insight-content">
                        <p class="insight-text" id="city-insight-text">
                            Cargando análisis de ciudades...
                        </p>
                    </div>
                </div>
                
                <!-- Gráfico: Bubble de Ciudades -->
                <div class="chart-section" style="margin-top: 2rem; border-top: none; padding-top: 1rem;">
                    <h3 class="chart-title">Ciudades por Sesiones y Engagement</h3>
                    <div class="section-description">
                        <span class="info-icon">i</span>
                        <p>Scatter donde cada burbuja representa una ciudad. El tamaño indica volumen de sesiones y el color el nivel de engagement. Detecta ciudades con alta calidad o patrones anómalos.</p>
                    </div>
                    <div class="chart-container" id="cityBubbleChart" style="min-height: 400px;"></div>
                    <div class="insight-box" style="margin-top: 1.5rem;">
                        <span class="insight-icon">💡</span>
                        <div class="insight-content">
                            <p class="insight-text" id="city-bubble-insight-text">Cargando análisis de ciudades...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Gráfico: Top 10 Ciudades -->
                <div class="chart-section" style="margin-top: 2rem; border-top: none; padding-top: 1rem;">
                    <h3 class="chart-title">Top 10 Ciudades por Sesiones Engaged</h3>
                    <div class="section-description">
                        <span class="info-icon">i</span>
                        <p>Ranking de barras horizontales de las principales ciudades. El color indica el nivel de engagement de cada núcleo urbano.</p>
                    </div>
                    <div class="chart-container" id="cityBarChart" style="min-height: 350px;"></div>
                    <div class="insight-box" style="margin-top: 1.5rem;">
                        <span class="insight-icon">💡</span>
                        <div class="insight-content">
                            <p class="insight-text" id="city-bar-insight-text">Cargando análisis del ranking...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ================================================================== -->
        <!-- TAB 4: FUENTES DE TRÁFICO -->
        <!-- ================================================================== -->
        <div class="tab-content" id="fuentes-trafico">
            
            <!-- Section Header -->
            <div class="section-header">
                <h2 class="section-title">FUENTES DE TRÁFICO</h2>
                <div class="section-info">
                    <span class="info-icon">i</span>
                    <p>Analiza de dónde provienen tus visitantes: búsqueda orgánica, tráfico directo, referencias de otros sitios y redes sociales. Identifica qué canales generan más tráfico de calidad.</p>
                </div>
            </div>
            
            <!-- Sub-tabs: Análisis General / SEO -->
            <div class="traffic-subtabs">
                <button class="traffic-subtab-btn active" data-traffic-subtab="analisis-general">Análisis General</button>
                <button class="traffic-subtab-btn" data-traffic-subtab="seo">SEO</button>
            </div>
            
            <!-- ================================================================== -->
            <!-- SUB-TAB: ANÁLISIS GENERAL -->
            <!-- ================================================================== -->
            <div class="traffic-subtab-content active" id="subtab-analisis-general">
                <!-- KPIs Clave por Canal -->
                <div class="section-header kpis-header">
                    <h2 class="section-title small">KPIS CLAVE POR CANAL</h2>
                </div>
                <div class="section-description">
                    <span class="info-icon">i</span>
                    <p>Indicadores principales del rendimiento web: muestran cuántas sesiones y usuarios únicos hemos recibido y cómo está evolucionando el tráfico semana a semana y mes a mes por canal</p>
                </div>
                
                <!-- Tabla de Canales -->
                <div class="channel-table-container">
                    <table class="channel-table">
                        <thead>
                            <tr>
                                <th>Canal</th>
                                <th>Sesiones Totales</th>
                                <th>Usuarios Únicos</th>
                                <th>Engagement Rate</th>
                                <th>WoW</th>
                                <th>MoM</th>
                            </tr>
                        </thead>
                        <tbody id="channelTableBody">
                            <tr>
                                <td colspan="6" style="text-align: center; color: rgba(255,255,255,0.5);">Cargando datos...</td>
                            </tr>
                        </tbody>
                    </table>
                    <button class="table-detail-btn" onclick="toggleDetailedTable()">
                        VER TABLA DETALLADA <span class="arrow-icon">→</span>
                    </button>
                </div>
                
                <!-- Insight Box -->
                <div class="insight-box">
                    <span class="insight-icon">💡</span>
                    <div class="insight-content">
                        <p class="insight-text" id="traffic-insight-text">
                            Analizando distribución de canales de tráfico...
                        </p>
                    </div>
                </div>
                
                <!-- Gráfico de distribución de canales -->
                <div class="chart-section">
                    <div class="section-header kpis-header">
                        <h2 class="section-title small">GRÁFICOS DE ADQUISICIÓN</h2>
                    </div>
                    
                    <div class="charts-row">
                        <div class="chart-wrapper">
                            <h3 class="chart-title">Distribución por Canal</h3>
                            <div class="chart-container" id="channelDistributionChart"></div>
                        </div>
                        
                        <div class="chart-wrapper">
                            <h3 class="chart-title">Tendencia por Canal</h3>
                            <div class="chart-container" id="channelTrendChart"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ================================================================== -->
            <!-- SUB-TAB: SEO (Google Search Console) -->
            <!-- ================================================================== -->
            <div class="traffic-subtab-content" id="subtab-seo">
                <!-- Tabs para Queries vs Páginas -->
                <div class="organic-tabs">
                    <button class="organic-tab-btn active" data-organic-tab="queries">Queries Orgánicas</button>
                    <button class="organic-tab-btn" data-organic-tab="pages">Paginas Orgánicas</button>
                </div>
                
                <!-- Tab Content: Queries -->
                <div class="organic-tab-content active" id="organic-queries">
                    <div class="organic-header-row">
                        <div class="section-info" style="margin-bottom: 0;">
                            <span class="info-icon">i</span>
                            <p><em>Esta tabla consolida las palabras clave que generan mayor visibilidad para Crata AI en Google. Permite evaluar qué términos impulsan el tráfico orgánico, identificar oportunidades de mejora en posicionamiento y detectar variaciones respecto al periodo anterior.</em></p>
                        </div>
                        <div class="top-selector">
                            <button class="top-btn" data-top="5" data-table="queries">Top 5</button>
                            <button class="top-btn active" data-top="10" data-table="queries">Top 10</button>
                            <button class="top-btn" data-top="25" data-table="queries">Top 25</button>
                        </div>
                    </div>
                    
                    <div class="organic-table-container">
                        <table class="organic-ranking-table">
                            <thead>
                                <tr>
                                    <th class="col-query">Query</th>
                                    <th class="col-metric">Impresiones</th>
                                    <th class="col-metric">Clics</th>
                                    <th class="col-metric">CTR</th>
                                    <th class="col-metric">Posición Media</th>
                                    <th class="col-delta">Δ Periodo Anterior</th>
                                </tr>
                            </thead>
                            <tbody id="organic-queries-body">
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 2rem; color: rgba(255,255,255,0.5);">
                                        Datos de Search Console no disponibles
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Tab Content: Páginas -->
                <div class="organic-tab-content" id="organic-pages">
                    <div class="organic-header-row">
                        <div class="section-info" style="margin-bottom: 0;">
                            <span class="info-icon">i</span>
                            <p><em>Esta tabla muestra las páginas con mejor rendimiento en búsquedas orgánicas. Identifica qué contenido genera más visibilidad y clics desde Google.</em></p>
                        </div>
                        <div class="top-selector">
                            <button class="top-btn" data-top="5" data-table="pages">Top 5</button>
                            <button class="top-btn active" data-top="10" data-table="pages">Top 10</button>
                            <button class="top-btn" data-top="25" data-table="pages">Top 25</button>
                        </div>
                    </div>
                    
                    <div class="organic-table-container">
                        <table class="organic-ranking-table">
                            <thead>
                                <tr>
                                    <th class="col-query">Página</th>
                                    <th class="col-metric">Impresiones</th>
                                    <th class="col-metric">Clics</th>
                                    <th class="col-metric">CTR</th>
                                    <th class="col-metric">Posición Media</th>
                                    <th class="col-delta">Δ Periodo Anterior</th>
                                </tr>
                            </thead>
                            <tbody id="organic-pages-body">
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 2rem; color: rgba(255,255,255,0.5);">
                                        Datos de Search Console no disponibles
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ================================================================== -->
        <!-- TAB 5: PÁGINA Y CONTENIDO -->
        <!-- ================================================================== -->
        <div class="tab-content" id="pagina-contenido">
            
            <!-- Section Header -->
            <div class="section-header">
                <h2 class="section-title">TABLA RANKING POR SESIONES</h2>
                <div class="section-info">
                    <span class="info-icon">i</span>
                    <p><em>volumen y valor de las páginas más visitadas</em></p>
                </div>
            </div>
            
            <!-- Tabla de Ranking de Páginas -->
            <div class="content-table-container" style="margin-top: 1.5rem;">
                <table class="content-ranking-table" id="content-ranking-table">
                    <thead>
                        <tr>
                            <th class="col-title">PAGE TITLE AND SCREEN CLASS</th>
                            <th class="col-metric">VIEWS</th>
                            <th class="col-metric">ACTIVE USERS</th>
                            <th class="col-metric">EVENT COUNT</th>
                            <th class="col-metric">BOUNCE RATE</th>
                        </tr>
                    </thead>
                    <tbody id="content-ranking-body">
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 2rem; color: rgba(255,255,255,0.5);">
                                Cargando datos...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        {% elif active_page == 'user_behavior' %}
        <!-- User Behavior -->
        <p style="color: rgba(255,255,255,0.6);">Datos de comportamiento de usuarios disponibles en los KPIs.</p>
        
        {% elif active_page == 'diana' %}
        <!-- Diana Page -->
        <div class="diana-container">
            <!-- Tabs de Diana -->
            <div class="tabs-container">
                <button class="tab-btn active" data-tab="overview">Overview</button>
                <button class="tab-btn" data-tab="diana-leads">Diana Leads</button>
                <button class="tab-btn" data-tab="mensajes-recientes">Mensajes Recientes</button>
            </div>
            
            <!-- ================================================================== -->
            <!-- TAB 1: OVERVIEW -->
            <!-- ================================================================== -->
            <div class="tab-content active" id="overview">
                <!-- Section Header: KPIs Clave -->
                <div class="section-header kpis-header">
                    <h2 class="section-title small">KPIS CLAVE</h2>
                </div>
                <div class="section-description">
                    <span class="info-icon">i</span>
                    <p>Indicadores principales del rendimiento de mensajería: mensajes enviados, respuestas recibidas, leads generados y reuniones agendadas.</p>
                </div>
                
                <!-- KPI Cards -->
                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-header">
                            <span class="kpi-title">Mensajes Enviados</span>
                        </div>
                        <div class="kpi-value-row">
                            <div class="kpi-value" id="diana-messages-sent">--</div>
                            <span class="kpi-delta positive" id="diana-messages-sent-delta">↑ --</span>
                        </div>
                        <p class="kpi-subtitle">Total de mensajes enviados en el periodo</p>
                    </div>
                    
                    <div class="kpi-card">
                        <div class="kpi-header">
                            <span class="kpi-title">Respuestas</span>
                        </div>
                        <div class="kpi-value-row">
                            <div class="kpi-value" id="diana-messages-replied">--</div>
                            <span class="kpi-delta positive" id="diana-messages-replied-delta">↑ --</span>
                        </div>
                        <p class="kpi-subtitle">Mensajes que recibieron respuesta</p>
                    </div>
                    
                    <div class="kpi-card">
                        <div class="kpi-header">
                            <span class="kpi-title">Leads Generados</span>
                        </div>
                        <div class="kpi-value-row">
                            <div class="kpi-value" id="diana-leads-generated">--</div>
                            <span class="kpi-delta positive" id="diana-leads-generated-delta">↑ --</span>
                        </div>
                        <p class="kpi-subtitle">Leads generados a partir de respuestas</p>
                    </div>
                    
                    <div class="kpi-card">
                        <div class="kpi-header">
                            <span class="kpi-title">Reuniones Agendadas</span>
                        </div>
                        <div class="kpi-value-row">
                            <div class="kpi-value" id="diana-meetings-scheduled">--</div>
                            <span class="kpi-delta positive" id="diana-meetings-scheduled-delta">↑ --</span>
                        </div>
                        <p class="kpi-subtitle">Reuniones agendadas desde leads</p>
                    </div>
                </div>
                
                <!-- Gráficos -->
                <div class="chart-section" style="margin-top: 2rem;">
                    <div class="section-header kpis-header">
                        <h2 class="section-title small">GRÁFICOS</h2>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-top: 1.5rem;">
                        <div class="chart-container">
                            <h3 class="chart-title">Mensajes Enviados por Día</h3>
                            <canvas id="diana-messages-chart"></canvas>
                        </div>
                        
                        <div class="chart-container">
                            <h3 class="chart-title">Tasa de Respuesta</h3>
                            <canvas id="diana-response-rate-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ================================================================== -->
            <!-- TAB 2: DIANA LEADS -->
            <!-- ================================================================== -->
            <div class="tab-content" id="diana-leads">
                <div class="section-header kpis-header">
                    <h2 class="section-title small">TOP 3 TARGETS GENERADOS POR DIANA</h2>
                </div>
                <div class="section-description">
                    <span class="info-icon">i</span>
                    <p>Resumen de los principales targets identificados por Diana basado en análisis de perfiles de LinkedIn, incluyendo industria, nacionalidad y headlines más comunes.</p>
                </div>
                
                <!-- Resumen de Targets -->
                <div id="diana-targets-summary" style="margin-top: 2rem;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                        <!-- Target 1 -->
                        <div class="kpi-card" style="min-height: 250px;">
                            <div class="kpi-header">
                                <span class="kpi-title">Target #1</span>
                                <span class="kpi-delta positive" id="diana-target1-score">--</span>
                            </div>
                            <div style="margin-top: 1rem;">
                                <p style="color: rgba(255,255,255,0.7); font-size: 0.85rem; margin-bottom: 0.5rem;"><strong>Tipo:</strong></p>
                                <p style="color: #fff; font-size: 0.95rem; margin-bottom: 1rem;" id="diana-target1-type">--</p>
                                
                                <p style="color: rgba(255,255,255,0.7); font-size: 0.85rem; margin-bottom: 0.5rem;"><strong>Industria:</strong></p>
                                <p style="color: #fff; font-size: 0.95rem; margin-bottom: 1rem;" id="diana-target1-industry">--</p>
                                
                                <p style="color: rgba(255,255,255,0.7); font-size: 0.85rem; margin-bottom: 0.5rem;"><strong>Nacionalidad:</strong></p>
                                <p style="color: #fff; font-size: 0.95rem; margin-bottom: 1rem;" id="diana-target1-country">--</p>
                                
                                <p style="color: rgba(255,255,255,0.7); font-size: 0.85rem; margin-bottom: 0.5rem;"><strong>Headline Principal:</strong></p>
                                <p style="color: #6CA8A4; font-size: 0.85rem; font-style: italic; line-height: 1.4;" id="diana-target1-headline">--</p>
                            </div>
                        </div>
                        
                        <!-- Target 2 -->
                        <div class="kpi-card" style="min-height: 250px;">
                            <div class="kpi-header">
                                <span class="kpi-title">Target #2</span>
                                <span class="kpi-delta positive" id="diana-target2-score">--</span>
                            </div>
                            <div style="margin-top: 1rem;">
                                <p style="color: rgba(255,255,255,0.7); font-size: 0.85rem; margin-bottom: 0.5rem;"><strong>Tipo:</strong></p>
                                <p style="color: #fff; font-size: 0.95rem; margin-bottom: 1rem;" id="diana-target2-type">--</p>
                                
                                <p style="color: rgba(255,255,255,0.7); font-size: 0.85rem; margin-bottom: 0.5rem;"><strong>Industria:</strong></p>
                                <p style="color: #fff; font-size: 0.95rem; margin-bottom: 1rem;" id="diana-target2-industry">--</p>
                                
                                <p style="color: rgba(255,255,255,0.7); font-size: 0.85rem; margin-bottom: 0.5rem;"><strong>Nacionalidad:</strong></p>
                                <p style="color: #fff; font-size: 0.95rem; margin-bottom: 1rem;" id="diana-target2-country">--</p>
                                
                                <p style="color: rgba(255,255,255,0.7); font-size: 0.85rem; margin-bottom: 0.5rem;"><strong>Headline Principal:</strong></p>
                                <p style="color: #6CA8A4; font-size: 0.85rem; font-style: italic; line-height: 1.4;" id="diana-target2-headline">--</p>
                            </div>
                        </div>
                        
                        <!-- Target 3 -->
                        <div class="kpi-card" style="min-height: 250px;">
                            <div class="kpi-header">
                                <span class="kpi-title">Target #3</span>
                                <span class="kpi-delta positive" id="diana-target3-score">--</span>
                            </div>
                            <div style="margin-top: 1rem;">
                                <p style="color: rgba(255,255,255,0.7); font-size: 0.85rem; margin-bottom: 0.5rem;"><strong>Tipo:</strong></p>
                                <p style="color: #fff; font-size: 0.95rem; margin-bottom: 1rem;" id="diana-target3-type">--</p>
                                
                                <p style="color: rgba(255,255,255,0.7); font-size: 0.85rem; margin-bottom: 0.5rem;"><strong>Industria:</strong></p>
                                <p style="color: #fff; font-size: 0.95rem; margin-bottom: 1rem;" id="diana-target3-industry">--</p>
                                
                                <p style="color: rgba(255,255,255,0.7); font-size: 0.85rem; margin-bottom: 0.5rem;"><strong>Nacionalidad:</strong></p>
                                <p style="color: #fff; font-size: 0.95rem; margin-bottom: 1rem;" id="diana-target3-country">--</p>
                                
                                <p style="color: rgba(255,255,255,0.7); font-size: 0.85rem; margin-bottom: 0.5rem;"><strong>Headline Principal:</strong></p>
                                <p style="color: #6CA8A4; font-size: 0.85rem; font-style: italic; line-height: 1.4;" id="diana-target3-headline">--</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Estadísticas Generales -->
                    <div class="chart-section" style="margin-top: 2rem;">
                        <div class="section-header kpis-header">
                            <h2 class="section-title small">ESTADÍSTICAS DE TARGETS</h2>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1.5rem;">
                            <div class="kpi-card" style="min-height: 120px;">
                                <div class="kpi-header">
                                    <span class="kpi-title">Industria Más Común</span>
                                </div>
                                <div class="kpi-value" style="font-size: 1.5rem;" id="diana-top-industry">--</div>
                                <p class="kpi-subtitle" id="diana-top-industry-count">-- leads</p>
                            </div>
                            
                            <div class="kpi-card" style="min-height: 120px;">
                                <div class="kpi-header">
                                    <span class="kpi-title">Nacionalidad Principal</span>
                                </div>
                                <div class="kpi-value" style="font-size: 1.5rem;" id="diana-top-country">--</div>
                                <p class="kpi-subtitle" id="diana-top-country-count">-- leads</p>
                            </div>
                            
                            <div class="kpi-card" style="min-height: 120px;">
                                <div class="kpi-header">
                                    <span class="kpi-title">Tipo Más Frecuente</span>
                                </div>
                                <div class="kpi-value" style="font-size: 1.5rem;" id="diana-top-type">--</div>
                                <p class="kpi-subtitle" id="diana-top-type-count">-- leads</p>
                            </div>
                            
                            <div class="kpi-card" style="min-height: 120px;">
                                <div class="kpi-header">
                                    <span class="kpi-title">Total Leads</span>
                                </div>
                                <div class="kpi-value" style="font-size: 1.5rem;" id="diana-total-leads">--</div>
                                <p class="kpi-subtitle">Targets generados</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            </div>
            
            <!-- ================================================================== -->
            <!-- TAB 3: MENSAJES RECIENTES -->
            <!-- ================================================================== -->
            <div class="tab-content" id="mensajes-recientes">
                <div class="section-header kpis-header">
                    <h2 class="section-title small">MENSAJES RECIENTES</h2>
                </div>
                <div class="section-description">
                    <span class="info-icon">i</span>
                    <p>Lista de los mensajes más recientes enviados a través de Diana, incluyendo estado de respuesta y tiempo de respuesta.</p>
                </div>
                
                <div class="table-container" style="margin-top: 1.5rem;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Destinatario</th>
                                    <th>Asunto</th>
                                    <th>Estado</th>
                                    <th>Tiempo de Respuesta</th>
                                </tr>
                            </thead>
                            <tbody id="diana-messages-table">
                                <tr>
                                    <td colspan="5" style="text-align: center; color: rgba(255,255,255,0.5);">Cargando datos...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        {% elif active_page == 'apollo' %}
        <!-- Apollo Page - Raw API Data -->
        <div class="apollo-container">
            <div class="tabs-container">
                <button class="tab-btn active" data-tab="apollo-status">API Status</button>
                <button class="tab-btn" data-tab="apollo-contacts">Contactos</button>
                <button class="tab-btn" data-tab="apollo-emails">Emails</button>
            </div>

            <div>
                <!-- TAB 1: API STATUS -->
                <div class="tab-content active" id="apollo-status">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1.5rem; margin-bottom: 1rem;">
                        <div class="section-header kpis-header" style="margin:0;">
                            <h2 class="section-title small">ESTADO DE CONEXIÓN APOLLO.IO</h2>
                        </div>
                        <button id="apollo-test-btn" onclick="loadApolloData()" style="padding: 0.6rem 1.2rem; background: #6CA8A4; border: none; border-radius: 4px; color: white; cursor: pointer; font-family: 'Outfit', sans-serif; font-size: 0.85rem;">Test Connection</button>
                    </div>

                    <div class="kpi-grid">
                        <div class="kpi-card">
                            <div class="kpi-header"><span class="kpi-title">API Key</span></div>
                            <div class="kpi-value-row">
                                <div class="kpi-value" id="apollo-key-status" style="font-size: 1.2rem;">--</div>
                            </div>
                            <p class="kpi-subtitle" id="apollo-key-masked">Verificando...</p>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-header"><span class="kpi-title">People Endpoint</span></div>
                            <div class="kpi-value-row">
                                <div class="kpi-value" id="apollo-people-status" style="font-size: 1.2rem;">--</div>
                            </div>
                            <p class="kpi-subtitle" id="apollo-people-detail">Verificando...</p>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-header"><span class="kpi-title">Emails Endpoint</span></div>
                            <div class="kpi-value-row">
                                <div class="kpi-value" id="apollo-emails-status" style="font-size: 1.2rem;">--</div>
                            </div>
                            <p class="kpi-subtitle" id="apollo-emails-detail">Verificando...</p>
                        </div>
                    </div>

                    <!-- Endpoint Details -->
                    <div style="margin-top: 2rem;">
                        <div class="section-header kpis-header"><h2 class="section-title small">DETALLE DE ENDPOINTS</h2></div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-top: 1rem;">
                            <div class="kpi-card">
                                <h3 style="color: #6CA8A4; margin-bottom: 1rem; font-size: 0.95rem;">mixed_people/api_search</h3>
                                <div id="apollo-people-details">
                                    <p style="color: rgba(255,255,255,0.5);">Esperando test...</p>
                                </div>
                            </div>
                            <div class="kpi-card">
                                <h3 style="color: #6CA8A4; margin-bottom: 1rem; font-size: 0.95rem;">emailer_messages/search</h3>
                                <div id="apollo-emails-details">
                                    <p style="color: rgba(255,255,255,0.5);">Esperando test...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Raw JSON Preview -->
                    <div style="margin-top: 2rem;">
                        <div class="section-header kpis-header"><h2 class="section-title small">RAW JSON PREVIEW</h2></div>
                        <div class="kpi-card" style="margin-top: 1rem;">
                            <pre id="apollo-raw-json" style="color: rgba(255,255,255,0.7); font-size: 0.75rem; overflow-x: auto; white-space: pre-wrap; max-height: 400px; overflow-y: auto;">Esperando test...</pre>
                        </div>
                    </div>
                </div>

                <!-- TAB 2: CONTACTOS -->
                <div class="tab-content" id="apollo-contacts">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1.5rem; margin-bottom: 1rem;">
                        <div class="section-header kpis-header" style="margin:0;">
                            <h2 class="section-title small">CONTACTOS APOLLO (<span id="apollo-contacts-count">0</span>)</h2>
                        </div>
                    </div>
                    <div class="kpi-card" style="padding: 0; overflow: hidden;">
                        <div style="overflow-x: auto;">
                            <table class="data-table" style="width: 100%;">
                                <thead>
                                    <tr>
                                        <th>Nombre</th>
                                        <th>Título</th>
                                        <th>Empresa</th>
                                        <th>Industria</th>
                                        <th>País</th>
                                        <th>Email</th>
                                        <th>LinkedIn</th>
                                    </tr>
                                </thead>
                                <tbody id="apollo-contacts-table">
                                    <tr><td colspan="7" style="text-align:center; color: rgba(255,255,255,0.5);">Cargando datos...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- TAB 3: EMAILS -->
                <div class="tab-content" id="apollo-emails">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1.5rem; margin-bottom: 1rem;">
                        <div class="section-header kpis-header" style="margin:0;">
                            <h2 class="section-title small">EMAILS APOLLO (<span id="apollo-emails-count">0</span>)</h2>
                        </div>
                    </div>
                    <div class="kpi-card" style="padding: 0; overflow: hidden;">
                        <div style="overflow-x: auto;">
                            <table class="data-table" style="width: 100%;">
                                <thead>
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Destinatario</th>
                                        <th>Asunto</th>
                                        <th>Estado</th>
                                        <th>Respondido</th>
                                    </tr>
                                </thead>
                                <tbody id="apollo-emails-table">
                                    <tr><td colspan="5" style="text-align:center; color: rgba(255,255,255,0.5);">Cargando datos...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {% elif active_page == 'leads' %}
        <!-- Leads Page - Pipeline View -->
        <div class="leads-container">
            <!-- Header con botón -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 2rem; margin-bottom: 1rem;">
                <div class="section-header kpis-header">
                    <h2 class="section-title small">PIPELINE DE LEADS</h2>
                </div>
                <button id="btn-add-lead" class="btn-primary" style="padding: 0.75rem 1.5rem; font-size: 0.95rem; background: #6CA8A4; border: none; border-radius: 4px; color: white; cursor: pointer;">
                    + Agregar Lead
                </button>
            </div>
            
            <div class="section-description">
                <span class="info-icon">i</span>
                <p>Pipeline de ventas organizado por fases. Arrastra los leads entre columnas o usa el botón de editar para cambiar su fase.</p>
            </div>
            
            <!-- Pipeline Visual -->
            <div class="pipeline-container" style="display: flex; gap: 1rem; margin-top: 2rem; overflow-x: auto; padding-bottom: 1rem;">
                
                <!-- Fase 1: Respuesta Positiva -->
                <div class="pipeline-column" data-phase="respuesta_positiva" style="min-width: 280px; flex: 1; background: rgba(76, 175, 80, 0.05); border: 1px solid rgba(76, 175, 80, 0.3); border-radius: 8px; padding: 1rem;">
                    <div class="pipeline-header" style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 2px solid #4CAF50;">
                        <span style="font-size: 1.2rem;">💬</span>
                        <h3 style="color: #4CAF50; font-size: 0.9rem; font-weight: 600; margin: 0; text-transform: uppercase;">Respuesta Positiva</h3>
                        <span class="pipeline-count" id="count-respuesta_positiva" style="background: #4CAF50; color: white; font-size: 0.75rem; padding: 0.2rem 0.5rem; border-radius: 10px; margin-left: auto;">0</span>
                    </div>
                    <div class="pipeline-cards" id="cards-respuesta_positiva" style="display: flex; flex-direction: column; gap: 0.75rem; min-height: 200px;">
                        <!-- Cards se cargan dinámicamente -->
                    </div>
                </div>
                
                <!-- Fase 2: 1ª Reunión -->
                <div class="pipeline-column" data-phase="primera_reunion" style="min-width: 280px; flex: 1; background: rgba(33, 150, 243, 0.05); border: 1px solid rgba(33, 150, 243, 0.3); border-radius: 8px; padding: 1rem;">
                    <div class="pipeline-header" style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 2px solid #2196F3;">
                        <span style="font-size: 1.2rem;">📅</span>
                        <h3 style="color: #2196F3; font-size: 0.9rem; font-weight: 600; margin: 0; text-transform: uppercase;">1ª Reunión</h3>
                        <span class="pipeline-count" id="count-primera_reunion" style="background: #2196F3; color: white; font-size: 0.75rem; padding: 0.2rem 0.5rem; border-radius: 10px; margin-left: auto;">0</span>
                    </div>
                    <div class="pipeline-cards" id="cards-primera_reunion" style="display: flex; flex-direction: column; gap: 0.75rem; min-height: 200px;">
                        <!-- Cards se cargan dinámicamente -->
                    </div>
                </div>
                
                <!-- Fase 3: 2ª Reunión -->
                <div class="pipeline-column" data-phase="segunda_reunion" style="min-width: 280px; flex: 1; background: rgba(156, 39, 176, 0.05); border: 1px solid rgba(156, 39, 176, 0.3); border-radius: 8px; padding: 1rem;">
                    <div class="pipeline-header" style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 2px solid #9C27B0;">
                        <span style="font-size: 1.2rem;">🤝</span>
                        <h3 style="color: #9C27B0; font-size: 0.9rem; font-weight: 600; margin: 0; text-transform: uppercase;">2ª Reunión</h3>
                        <span class="pipeline-count" id="count-segunda_reunion" style="background: #9C27B0; color: white; font-size: 0.75rem; padding: 0.2rem 0.5rem; border-radius: 10px; margin-left: auto;">0</span>
                    </div>
                    <div class="pipeline-cards" id="cards-segunda_reunion" style="display: flex; flex-direction: column; gap: 0.75rem; min-height: 200px;">
                        <!-- Cards se cargan dinámicamente -->
                    </div>
                </div>
                
                <!-- Fase 4: Propuesta -->
                <div class="pipeline-column" data-phase="propuesta" style="min-width: 280px; flex: 1; background: rgba(255, 152, 0, 0.05); border: 1px solid rgba(255, 152, 0, 0.3); border-radius: 8px; padding: 1rem;">
                    <div class="pipeline-header" style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 2px solid #FF9800;">
                        <span style="font-size: 1.2rem;">📋</span>
                        <h3 style="color: #FF9800; font-size: 0.9rem; font-weight: 600; margin: 0; text-transform: uppercase;">Propuesta</h3>
                        <span class="pipeline-count" id="count-propuesta" style="background: #FF9800; color: white; font-size: 0.75rem; padding: 0.2rem 0.5rem; border-radius: 10px; margin-left: auto;">0</span>
                    </div>
                    <div class="pipeline-cards" id="cards-propuesta" style="display: flex; flex-direction: column; gap: 0.75rem; min-height: 200px;">
                        <!-- Cards se cargan dinámicamente -->
                    </div>
                </div>
                
                <!-- Fase 5: Cerrado -->
                <div class="pipeline-column" data-phase="cerrado_ganado" style="min-width: 280px; flex: 1; background: rgba(108, 168, 164, 0.05); border: 1px solid rgba(108, 168, 164, 0.3); border-radius: 8px; padding: 1rem;">
                    <div class="pipeline-header" style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 2px solid #6CA8A4;">
                        <span style="font-size: 1.2rem;">🏆</span>
                        <h3 style="color: #6CA8A4; font-size: 0.9rem; font-weight: 600; margin: 0; text-transform: uppercase;">Cerrado Ganado</h3>
                        <span class="pipeline-count" id="count-cerrado_ganado" style="background: #6CA8A4; color: white; font-size: 0.75rem; padding: 0.2rem 0.5rem; border-radius: 10px; margin-left: auto;">0</span>
                    </div>
                    <div class="pipeline-cards" id="cards-cerrado_ganado" style="display: flex; flex-direction: column; gap: 0.75rem; min-height: 200px;">
                        <!-- Cards se cargan dinámicamente -->
                    </div>
                </div>
                
            </div>
            
            <!-- Filtro por fuente -->
            <div style="display: flex; gap: 1rem; margin-top: 1.5rem; flex-wrap: wrap; align-items: center;">
                <span style="color: rgba(255,255,255,0.7); font-size: 0.9rem;">Filtrar por fuente:</span>
                <select id="filter-source" style="padding: 0.5rem 1rem; background: #0f0f1e; border: 1px solid #6CA8A4; border-radius: 4px; color: white; font-size: 0.9rem;">
                    <option value="">Todas las fuentes</option>
                    <option value="diana">Diana</option>
                    <option value="manual">Manual</option>
                    <option value="web">Web</option>
                    <option value="linkedin">LinkedIn</option>
                </select>
            </div>
            
            <!-- Modal para Agregar/Editar Lead -->
            <div id="lead-modal" class="modal" style="display: none;">
                <div class="modal-content" style="background: #1a1a2e; border: 1px solid #6CA8A4; border-radius: 8px; padding: 2rem; max-width: 600px; margin: 5% auto; max-height: 90vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2 style="color: #6CA8A4; margin: 0;" id="lead-modal-title">Agregar Nuevo Lead</h2>
                        <span class="modal-close" style="color: rgba(255,255,255,0.7); font-size: 1.5rem; cursor: pointer; user-select: none;">&times;</span>
                    </div>
                    <form id="lead-form">
                        <input type="hidden" id="lead-id" value="">
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; color: rgba(255,255,255,0.8); margin-bottom: 0.5rem; font-size: 0.9rem;">Fuente *</label>
                            <select id="lead-source" required style="width: 100%; padding: 0.75rem; background: #0f0f1e; border: 1px solid #6CA8A4; border-radius: 4px; color: white; font-size: 0.95rem;">
                                <option value="">Selecciona una fuente</option>
                                <option value="diana">Diana</option>
                                <option value="manual">Manual</option>
                                <option value="web">Web</option>
                                <option value="linkedin">LinkedIn</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; color: rgba(255,255,255,0.8); margin-bottom: 0.5rem; font-size: 0.9rem;">Nombre de la Empresa *</label>
                            <input type="text" id="lead-company" required style="width: 100%; padding: 0.75rem; background: #0f0f1e; border: 1px solid #6CA8A4; border-radius: 4px; color: white; font-size: 0.95rem;">
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; color: rgba(255,255,255,0.8); margin-bottom: 0.5rem; font-size: 0.9rem;">Nombre del Contacto</label>
                            <input type="text" id="lead-contact-name" style="width: 100%; padding: 0.75rem; background: #0f0f1e; border: 1px solid #6CA8A4; border-radius: 4px; color: white; font-size: 0.95rem;">
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; color: rgba(255,255,255,0.8); margin-bottom: 0.5rem; font-size: 0.9rem;">Email</label>
                            <input type="email" id="lead-email" style="width: 100%; padding: 0.75rem; background: #0f0f1e; border: 1px solid #6CA8A4; border-radius: 4px; color: white; font-size: 0.95rem;">
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; color: rgba(255,255,255,0.8); margin-bottom: 0.5rem; font-size: 0.9rem;">Teléfono</label>
                            <input type="tel" id="lead-phone" style="width: 100%; padding: 0.75rem; background: #0f0f1e; border: 1px solid #6CA8A4; border-radius: 4px; color: white; font-size: 0.95rem;">
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; color: rgba(255,255,255,0.8); margin-bottom: 0.5rem; font-size: 0.9rem;">Fecha de Reunión</label>
                            <input type="date" id="lead-meeting-date" style="width: 100%; padding: 0.75rem; background: #0f0f1e; border: 1px solid #6CA8A4; border-radius: 4px; color: white; font-size: 0.95rem;">
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; color: rgba(255,255,255,0.8); margin-bottom: 0.5rem; font-size: 0.9rem;">Motivo/Proyecto</label>
                            <textarea id="lead-project-reason" rows="3" style="width: 100%; padding: 0.75rem; background: #0f0f1e; border: 1px solid #6CA8A4; border-radius: 4px; color: white; font-size: 0.95rem; resize: vertical; font-family: inherit;"></textarea>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; color: rgba(255,255,255,0.8); margin-bottom: 0.5rem; font-size: 0.9rem;">Fase del Pipeline *</label>
                            <select id="lead-status" required style="width: 100%; padding: 0.75rem; background: #0f0f1e; border: 1px solid #6CA8A4; border-radius: 4px; color: white; font-size: 0.95rem;">
                                <option value="respuesta_positiva">💬 Respuesta Positiva</option>
                                <option value="primera_reunion">📅 1ª Reunión</option>
                                <option value="segunda_reunion">🤝 2ª Reunión</option>
                                <option value="propuesta">📋 Propuesta</option>
                                <option value="cerrado_ganado">🏆 Cerrado Ganado</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; color: rgba(255,255,255,0.8); margin-bottom: 0.5rem; font-size: 0.9rem;">Notas</label>
                            <textarea id="lead-notes" rows="3" style="width: 100%; padding: 0.75rem; background: #0f0f1e; border: 1px solid #6CA8A4; border-radius: 4px; color: white; font-size: 0.95rem; resize: vertical; font-family: inherit;"></textarea>
                        </div>
                        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                            <button type="button" class="modal-close" style="padding: 0.75rem 1.5rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; color: white; cursor: pointer; font-size: 0.95rem;">Cancelar</button>
                            <button type="submit" style="padding: 0.75rem 1.5rem; background: #6CA8A4; border: none; border-radius: 4px; color: white; cursor: pointer; font-size: 0.95rem;">Guardar Lead</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        {% elif active_page == 'team' %}
        <!-- Team Page -->
        <div class="team-container">
            <!-- Tabs de Team -->
            <div class="tabs-container">
                <button class="tab-btn active" data-tab="team-overview">Overview</button>
                <button class="tab-btn" data-tab="generation-team">Generation Team</button>
                <button class="tab-btn" data-tab="close-team">Close Team</button>
            </div>
            
            <!-- ================================================================== -->
            <!-- TAB 1: OVERVIEW -->
            <!-- ================================================================== -->
            <div class="tab-content active" id="team-overview">
                <div class="section-header">
                    <h2 class="section-title">TEAM OVERVIEW - Q1 GROWTH PLAN</h2>
                    <div class="section-info">
                        <span class="info-icon">i</span>
                        <p>Visión general del plan de crecimiento del Q1 y recomendaciones para todos los equipos.</p>
                    </div>
                </div>
                
                <!-- Recomendaciones para Todos -->
                <div class="chart-section" style="margin-top: 2rem;">
                    <div class="section-header kpis-header">
                        <h2 class="section-title small">RECOMENDACIONES PARA TODOS</h2>
                    </div>
                    <div style="background: rgba(108, 168, 164, 0.05); border: 1px solid rgba(108, 168, 164, 0.2); border-radius: 8px; padding: 1.5rem; margin-top: 1rem;">
                        <ul style="color: rgba(255,255,255,0.8); line-height: 1.8; list-style: none; padding-left: 0;">
                            <li style="margin-bottom: 1rem;">✓ Cread a partir de la semana que viene un canal de slack y una reunión de seguimientos semanal breve para el sub-equipo.</li>
                            <li style="margin-bottom: 1rem;">✓ Empezad a pensar cómo vais a avanzar en la descentralización organizativa, de cara a necesitar algo menos a Fabian y a mí en las iniciativas respectivas de cada sub-equipo.</li>
                            <li style="margin-bottom: 1rem;">✓ Pensad en cómo vais a reportar el progreso cada semana, recoger y presentar las métricas y quién o quienes (sea fijo o rotatorio) hablara en vuestro nombre en las reuniones (10 min por equipo aprox, en nombre de todo el equipo).</li>
                            <li style="margin-bottom: 1rem;">✓ Tomaremos como punto de partida allí donde acabasteis el trabajo en el marco del Winter Growth Sprint. Revisad cómo de actualizado tenéis el status de vuestras iniciativas del Winter Growth Sprint en ClickUp y cómo retomarlas (si es que están paradas) en el marco del plan del Q1.</li>
                            <li style="margin-bottom: 1rem;">✓ Considerad cómo podéis combinar vuestras respectivas habilidades y trabajar mejor juntos. Gracias a la magia de las sinergias y a la especialización de cada rol, la combinación es mucho más que la suma de las partes: aquí, 1 + 1 puede ser 10.</li>
                            <li style="margin-bottom: 1rem;">✓ Pensad cómo podemos mejorar nuestros estándares de calidad en todo nuestro trabajo (checklists? tests antes de entregar? procedimientos de revisión estandarizados?), tanto a nivel individual como en toda la organización.</li>
                            <li style="margin-bottom: 1rem;">✓ Pensad cómo podéis multiplicar vuestra productividad y mejorar la calidad gracias a la implementación de IA en los puntos correctos - id pensando qué puntos créeis que son y como lo podríais abordar.</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- ================================================================== -->
            <!-- TAB 2: GENERATION TEAM -->
            <!-- ================================================================== -->
            <div class="tab-content" id="generation-team">
                <!-- Sub-tabs para Generation Team -->
                <div class="tabs-container" style="margin-bottom: 2rem;">
                    <button class="tab-btn active" data-tab="gen-overview">Overview</button>
                    <button class="tab-btn" data-tab="gen-kpis">KPIs</button>
                </div>
                
                <!-- Sub-tab 1: Overview -->
                <div class="tab-content active" id="gen-overview">
                    <div class="section-header" style="border-bottom: none; margin-bottom: 0;">
                        <h2 class="section-title">GENERATION TEAM - OVERVIEW</h2>
                        <div class="section-info">
                            <span class="info-icon">i</span>
                            <p>Visión general y recomendaciones para el equipo de generación.</p>
                        </div>
                    </div>
                    
                    <!-- Equipo Generation Team -->
                    <div style="margin-top: 2rem; margin-bottom: 2rem;">
                        <div class="section-header kpis-header">
                            <h2 class="section-title small">EQUIPO GENERATION TEAM</h2>
                        </div>
                        <div style="display: flex; justify-content: center; gap: 3rem; flex-wrap: wrap; margin-top: 1.5rem;">
                            <div style="display: flex; flex-direction: column; align-items: center; gap: 0.75rem;">
                                <div style="width: 120px; height: 120px; border-radius: 50%; overflow: hidden; border: 3px solid #6CA8A4; background: rgba(108, 168, 164, 0.1); display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(108, 168, 164, 0.2);">
                                    <img src="{{ url_for('static', filename='assets/generation-team/Angela.png') }}" alt="Angela" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22120%22 height=%22120%22%3E%3Crect fill=%22%236CA8A4%22 width=%22120%22 height=%22120%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22white%22 font-size=%2220%22%3EA%3C/text%3E%3C/svg%3E';">
                                </div>
                                <span style="color: #fff; font-family: 'Montserrat', sans-serif; font-size: 0.95rem; font-weight: 600;">Angela</span>
                            </div>
                            
                            <div style="display: flex; flex-direction: column; align-items: center; gap: 0.75rem;">
                                <div style="width: 120px; height: 120px; border-radius: 50%; overflow: hidden; border: 3px solid #6CA8A4; background: rgba(108, 168, 164, 0.1); display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(108, 168, 164, 0.2);">
                                    <img src="{{ url_for('static', filename='assets/generation-team/Julian.png') }}" alt="Julian" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22120%22 height=%22120%22%3E%3Crect fill=%22%236CA8A4%22 width=%22120%22 height=%22120%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22white%22 font-size=%2220%22%3EJ%3C/text%3E%3C/svg%3E';">
                                </div>
                                <span style="color: #fff; font-family: 'Montserrat', sans-serif; font-size: 0.95rem; font-weight: 600;">Julian</span>
                            </div>
                            
                            <div style="display: flex; flex-direction: column; align-items: center; gap: 0.75rem;">
                                <div style="width: 120px; height: 120px; border-radius: 50%; overflow: hidden; border: 3px solid #6CA8A4; background: rgba(108, 168, 164, 0.1); display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(108, 168, 164, 0.2);">
                                    <img src="{{ url_for('static', filename='assets/generation-team/Claudia.png') }}" alt="Claudia" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22120%22 height=%22120%22%3E%3Crect fill=%22%236CA8A4%22 width=%22120%22 height=%22120%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22white%22 font-size=%2220%22%3EC%3C/text%3E%3C/svg%3E';">
                                </div>
                                <span style="color: #fff; font-family: 'Montserrat', sans-serif; font-size: 0.95rem; font-weight: 600;">Claudia</span>
                            </div>
                            
                            <div style="display: flex; flex-direction: column; align-items: center; gap: 0.75rem;">
                                <div style="width: 120px; height: 120px; border-radius: 50%; overflow: hidden; border: 3px solid #6CA8A4; background: rgba(108, 168, 164, 0.1); display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(108, 168, 164, 0.2);">
                                    <img src="{{ url_for('static', filename='assets/generation-team/Dani.png') }}" alt="Dani" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22120%22 height=%22120%22%3E%3Crect fill=%22%236CA8A4%22 width=%22120%22 height=%22120%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22white%22 font-size=%2220%22%3ED%3C/text%3E%3C/svg%3E';">
                                </div>
                                <span style="color: #fff; font-family: 'Montserrat', sans-serif; font-size: 0.95rem; font-weight: 600;">Dani</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chart-section" style="margin-top: 2rem;">
                        <div class="section-header kpis-header">
                            <h2 class="section-title small">RECOMENDACIONES EQUIPO GENERACIÓN</h2>
                        </div>
                        <div style="background: rgba(108, 168, 164, 0.05); border: 1px solid rgba(108, 168, 164, 0.2); border-radius: 8px; padding: 1.5rem; margin-top: 1rem;">
                            <p style="color: rgba(255,255,255,0.8); margin-bottom: 1rem; font-weight: 600;">Tomemos como punto de partida principal todo el trabajo de Claudia en el marco del plan de crecimiento (idealmente contando la semana que viene con un actualización por su parte del status de Marketing / Generación de leads, métricas, progreso y demás que no tengamos tanta visibilidad), la v0 del entorno de datos de Ángela, Diana y el proceso actual de Julián para generación directa de SQLs via Apollo y Linkedin que ha arrancado el año con un éxito notable.</p>
                            <p style="color: rgba(255,255,255,0.8); margin-bottom: 1rem; font-weight: 600;">Podéis pensar ideas de iniciativas que apliquen a vuestra área en el marco del plan como:</p>
                            <ul style="color: rgba(255,255,255,0.8); line-height: 1.8; list-style: none; padding-left: 0;">
                                <li style="margin-bottom: 1rem;">✓ Diana v1 - cómo mediremos el impacto, cómo sabremos si está funcionando o no y por qué, cómo</li>
                                <li style="margin-bottom: 1rem;">✓ Hoja de ruta para la v2 de Diana - ideas de mejora, proceso de análisis de resultados a lo largo de las próximas semanas, posibles iteraciones etc</li>
                                <li style="margin-bottom: 1rem;">✓ Hoja de ruta ampliada de SEO (Claudia) - considerando pico de carga de trabajo actual en propuestas y proyectos, activación de Lead Motiv, posible inversión y tiempos hasta finales de marzo (y no finales de enero)</li>
                                <li style="margin-bottom: 1rem;">✓ Eventos (Claudia) - cómo avanzamos.</li>
                                <li style="margin-bottom: 1rem;">✓ Refuerzo de nuestra marca y otros activos comerciales que nos ayuden a generar más leads de calidad (y también a convertir con más facilidad)</li>
                                <li style="margin-bottom: 1rem;">✓ Despliegue de entorno de datos de Ángela y plan para incorporar nuevas fuentes de datos</li>
                            </ul>
                            <p style="color: rgba(255,255,255,0.8); margin-top: 1.5rem; font-weight: 600;">Todas las ideas que se os ocurran, estos días y en las próximas semanas para lograr que hablemos con más decisores de calidad (belivers listos para empezar), vayamos a máximo volumen de outreach con alta precisión en el mensaje y la selección del target, tengamos el calendario lleno de nuevas reuniones cada semana, consigamos más leads orgánicos / de mktg y mejoremos la conversión en todos los canales.</p>
                        </div>
                    </div>
                </div>
                
                <!-- Sub-tab 2: KPIs -->
                <div class="tab-content" id="gen-kpis">
                    <div class="section-header">
                        <h2 class="section-title">GENERATION TEAM - KPIs</h2>
                        <div class="section-info">
                            <span class="info-icon">i</span>
                            <p>Métricas y KPIs del equipo de generación. Puedes editar los datos directamente en las tablas.</p>
                        </div>
                    </div>
                    
                    <!-- Expander 1: Campañas Email/LinkedIn -->
                    <div class="expander-container" style="margin-top: 2rem;">
                        <div class="expander-header" data-expander="email-campaigns">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <img src="{{ url_for('static', filename='assets/mail.png') }}" alt="Email" style="width: 24px; height: 24px; object-fit: contain;">
                                <h3 class="expander-title">Campañas Email/LinkedIn</h3>
                            </div>
                            <span class="expander-icon">▼</span>
                        </div>
                        <div class="expander-content" id="email-campaigns-expander">
                            <div class="table-container" style="margin-top: 1.5rem; overflow-x: auto;">
                                <table class="data-table editable-table" id="email-campaigns-table">
                                    <thead>
                                        <tr>
                                            <th>Semana/Fecha</th>
                                            <th>Campaña</th>
                                            <th>Emails Enviados (Personas)</th>
                                            <th>Respuestas (Total)</th>
                                            <th>Tasa de Respuesta (Total)</th>
                                            <th>Respuestas Positivas</th>
                                            <th>Tasa de Respuestas Positivas</th>
                                            <th>Reuniones</th>
                                            <th>Notas / Observaciones Clave</th>
                                        </tr>
                                    </thead>
                                    <tbody id="email-campaigns-body">
                                        <!-- Datos se cargarán dinámicamente -->
                                    </tbody>
                                </table>
                                <button class="btn-add-row" data-table="email-campaigns" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #6CA8A4; border: none; border-radius: 4px; color: white; cursor: pointer;">
                                    + Agregar Fila
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Expander 2: Campañas LinkedIn -->
                    <div class="expander-container" style="margin-top: 1.5rem;">
                        <div class="expander-header" data-expander="linkedin-campaigns">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <img src="{{ url_for('static', filename='assets/linkedin.png') }}" alt="LinkedIn" style="width: 24px; height: 24px; object-fit: contain;">
                                <h3 class="expander-title">Campañas LinkedIn</h3>
                            </div>
                            <span class="expander-icon">▼</span>
                        </div>
                        <div class="expander-content" id="linkedin-campaigns-expander">
                            <div class="table-container" style="margin-top: 1.5rem; overflow-x: auto;">
                                <table class="data-table editable-table" id="linkedin-campaigns-table">
                                    <thead>
                                        <tr>
                                            <th>Semana/Fecha</th>
                                            <th>Campaña</th>
                                            <th>Total Mensajes Perfiles/Camp</th>
                                            <th>Respuestas (Total)</th>
                                            <th>Tasa de Respuesta (Total)</th>
                                            <th>Respuestas Positivas</th>
                                            <th>Tasa de Respuestas Positivas</th>
                                            <th>Reuniones</th>
                                            <th>Notas / Observaciones Clave</th>
                                        </tr>
                                    </thead>
                                    <tbody id="linkedin-campaigns-body">
                                        <!-- Datos se cargarán dinámicamente -->
                                    </tbody>
                                </table>
                                <button class="btn-add-row" data-table="linkedin-campaigns" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #6CA8A4; border: none; border-radius: 4px; color: white; cursor: pointer;">
                                    + Agregar Fila
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Expander 3: Métricas Web -->
                    <div class="expander-container" style="margin-top: 1.5rem;">
                        <div class="expander-header" data-expander="web-metrics">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <img src="{{ url_for('static', filename='assets/web.png') }}" alt="Web" style="width: 24px; height: 24px; object-fit: contain;">
                                <h3 class="expander-title">Métricas Web</h3>
                            </div>
                            <span class="expander-icon">▼</span>
                        </div>
                        <div class="expander-content" id="web-metrics-expander">
                            <div class="table-container" style="margin-top: 1.5rem; overflow-x: auto;">
                                <table class="data-table editable-table" id="web-metrics-table">
                                    <thead>
                                        <tr>
                                            <th>Semana</th>
                                            <th>Sesiones totales</th>
                                            <th>Usuarios</th>
                                            <th>% Usuarios Nuevos</th>
                                            <th>Sesiones Orgánicas</th>
                                            <th>Sesiones Paid</th>
                                            <th>Sesiones Referral</th>
                                            <th>Engagement Rate</th>
                                            <th>Bounced Rate</th>
                                            <th>Pages por sesión</th>
                                            <th>Leads web</th>
                                            <th>Reuniones agendadas</th>
                                            <th>Tasa conversión web</th>
                                            <th>TOP 3 pages</th>
                                            <th>Top Blog</th>
                                            <th>% Tráfico Blog</th>
                                            <th>Nuevas Páginas</th>
                                            <th>New KWs</th>
                                        </tr>
                                    </thead>
                                    <tbody id="web-metrics-body">
                                        <!-- Datos se cargarán dinámicamente -->
                                    </tbody>
                                </table>
                                <button class="btn-add-row" data-table="web-metrics" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #6CA8A4; border: none; border-radius: 4px; color: white; cursor: pointer;">
                                    + Agregar Fila
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ================================================================== -->
            <!-- TAB 3: CLOSE TEAM -->
            <!-- ================================================================== -->
            <div class="tab-content" id="close-team">
                <div class="section-header">
                    <h2 class="section-title">CLOSE TEAM - RECOMENDACIONES</h2>
                    <div class="section-info">
                        <span class="info-icon">i</span>
                        <p>Recomendaciones y objetivos para el equipo de cierre.</p>
                    </div>
                </div>
                
                <div class="chart-section" style="margin-top: 2rem;">
                    <div class="section-header kpis-header">
                        <h2 class="section-title small">RECOMENDACIONES EQUIPO CIERRE</h2>
                    </div>
                    <div style="background: rgba(108, 168, 164, 0.05); border: 1px solid rgba(108, 168, 164, 0.2); border-radius: 8px; padding: 1.5rem; margin-top: 1rem;">
                        <p style="color: rgba(255,255,255,0.8); margin-bottom: 1rem; font-weight: 600;">Tomemos como punto de partida principal el trabajo de análisis de procesos de Alessia y de preparación del lanzamiento de Miranda de Petra, veamos cómo de avanzado está y mejoremos la manera de dar seguimiento a las tareas, concretar alcance y marcar pasos concretos.</p>
                        <p style="color: rgba(255,255,255,0.8); margin-bottom: 1rem; font-weight: 600;">Podéis pensar ideas que apliquen a vuestra área en el marco del plan como:</p>
                        <ul style="color: rgba(255,255,255,0.8); line-height: 1.8; list-style: none; padding-left: 0;">
                            <li style="margin-bottom: 1rem;">✓ Integración de IA en la elaboración de materiales de venta y consultoría - docs y slides (prioritario)</li>
                            <li style="margin-bottom: 1rem;">✓ Consolidación del AI Quickstarter y Prototipado como servicios completos estandarizados.</li>
                            <li style="margin-bottom: 1rem;">✓ Homogeneización de criterios y procedimientos (SOPs) para llamadas, reuniones claves como por ejemplo kick-offs, propuestas, stress tests etc</li>
                            <li style="margin-bottom: 1rem;">✓ Elaboración de biblioteca de conocimientos, materiales, plantillas, SOPs comerciales y de consultoría que sean de fácil acceso, procedimiento de actualización, uso etc</li>
                            <li style="margin-bottom: 1rem;">✓ Entorno de métricas de funnel en Hubspot y/o entorno propio de datos con Ángela.</li>
                            <li style="margin-bottom: 1rem;">✓ Preparación del lanzamiento a mercado de Miranda (y potencial lanzamiento, en función del deal de Sacyr)</li>
                        </ul>
                        <p style="color: rgba(255,255,255,0.8); margin-top: 1.5rem; font-weight: 600;">Todas las ideas que se os ocurran, estos días y en las próximas semanas para lograr que cerremos más proyectos, enviemos más propuestas, convirtamos más en cada fase, cerremos más rápido y lancemos nuestro primer producto vertical, estandarizado y super replicable al mercado (Miranda).</p>
                    </div>
                </div>
            </div>
        </div>
        
        {% elif active_page == 'alerts' %}
        <!-- Alerts Content -->
        
        <!-- Tabs de Alertas -->
        <div class="chart-tabs-container">
            <button class="chart-tab-btn active" data-chart-tab="alertas-generales">Alertas Generales</button>
            <button class="chart-tab-btn" data-chart-tab="deteccion-bots">Detección de Bots</button>
        </div>
        
        <!-- ================================================================== -->
        <!-- TAB 1: ALERTAS GENERALES -->
        <!-- ================================================================== -->
        <div class="chart-tab-content active" id="alertas-generales">
            <!-- Grid de dos columnas: Top Alerta + Contador -->
            <div class="alerts-top-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-top: 1.5rem;">
                
                <!-- Columna 1: TOP ALERTA ACTUAL -->
                <div class="alert-section">
                    <div class="section-header kpis-header">
                        <h2 class="section-title small">TOP ALERTA ACTUAL</h2>
                    </div>
                    
                    <div class="alert-top-box" id="top-alert-box">
                        <ul class="alert-details">
                            <li><strong>Título:</strong> <span id="top-alert-title">Cargando...</span></li>
                            <li><strong>Descripción:</strong> <span id="top-alert-desc">Cargando...</span></li>
                            <li><strong>Recomendación:</strong> <span id="top-alert-rec">Cargando...</span></li>
                            <li><strong>Criticidad:</strong> <span id="top-alert-crit">Cargando...</span></li>
                        </ul>
                    </div>
                </div>
                
                <!-- Columna 2: CONTADOR DE ALERTAS -->
                <div class="alert-section">
                    <div class="section-header kpis-header">
                        <h2 class="section-title small">CONTADOR DE ALERTAS</h2>
                    </div>
                    
                    <!-- Stats Row -->
                    <div class="alert-stats-row">
                        <div class="alert-stat-box">
                            <span class="alert-stat-label">TOTAL DE ALERTAS</span>
                            <span class="alert-stat-value" id="total-alerts">0</span>
                        </div>
                        <div class="alert-stat-box">
                            <span class="alert-stat-label">ESTADO DEL TRÁFICO</span>
                            <span class="alert-status" id="traffic-status">
                                <span class="status-dot normal"></span>
                                <span id="status-text">Normal</span>
                            </span>
                        </div>
                    </div>
                    
                    <!-- Alert Types -->
                    <div class="alert-types-row">
                        <div class="alert-type-box critical">
                            <span class="alert-type-label">Críticas</span>
                            <span class="alert-type-value" id="critical-alerts">0</span>
                            <span class="alert-type-pct" id="critical-pct">0%</span>
                        </div>
                        <div class="alert-type-box moderate">
                            <span class="alert-type-label">Moderadas</span>
                            <span class="alert-type-value" id="moderate-alerts">0</span>
                            <span class="alert-type-pct" id="moderate-pct">0%</span>
                        </div>
                        <div class="alert-type-box info">
                            <span class="alert-type-label">Informativas</span>
                            <span class="alert-type-value" id="info-alerts">0</span>
                            <span class="alert-type-pct" id="info-pct">0%</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Insight -->
            <div class="insight-box" style="margin-top: 0.75rem; margin-bottom: 0.75rem;">
                <span class="insight-icon">💡</span>
                <div class="insight-content">
                    <p class="insight-text" id="alerts-insight-text">
                        Cargando análisis de alertas...
                    </p>
                </div>
            </div>
            
            <!-- Lista de Alertas Recientes - Dos Columnas -->
            <div class="alerts-columns-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 0.75rem;">
                <!-- Columna 1: Críticas y Moderadas -->
                <div class="alert-section">
                    <div class="section-header kpis-header">
                        <h2 class="section-title small">⚠️ CRÍTICAS Y MODERADAS</h2>
                    </div>
                    <div class="alerts-list" id="alerts-list-important">
                        <p class="loading-text">Cargando alertas...</p>
                    </div>
                </div>
                
                <!-- Columna 2: Informativas -->
                <div class="alert-section">
                    <div class="section-header kpis-header">
                        <h2 class="section-title small">ℹ️ INFORMATIVAS</h2>
                    </div>
                    <div class="alerts-list" id="alerts-list-info">
                        <p class="loading-text">Cargando alertas...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ================================================================== -->
        <!-- TAB 2: DETECCIÓN DE BOTS -->
        <!-- ================================================================== -->
        <div class="chart-tab-content" id="deteccion-bots">
            <div class="alert-section bot-detection-section" style="margin-top: 1.5rem;">
                <div class="section-header kpis-header">
                    <h2 class="section-title">🤖 DETECCIÓN DE BOTS</h2>
                </div>
                <div class="section-description">
                    <span class="info-icon">i</span>
                    <p>Análisis dedicado a identificar tráfico automatizado o de baja calidad. Se detectan países con duración media de sesión inferior a 5 segundos, patrón típico de bots y tráfico no válido.</p>
                </div>
                
                <!-- KPIs de Bots -->
                <div class="bot-stats-grid">
                    <div class="bot-stat-box">
                        <span class="bot-stat-icon">📊</span>
                        <div class="bot-stat-content">
                            <span class="bot-stat-label">Sesiones Analizadas</span>
                            <span class="bot-stat-value" id="bot-total-sessions">0</span>
                        </div>
                    </div>
                    <div class="bot-stat-box">
                        <span class="bot-stat-icon">🤖</span>
                        <div class="bot-stat-content">
                            <span class="bot-stat-label">Sesiones Sospechosas</span>
                            <span class="bot-stat-value" id="bot-suspicious-sessions">0</span>
                        </div>
                    </div>
                    <div class="bot-stat-box">
                        <span class="bot-stat-icon">📈</span>
                        <div class="bot-stat-content">
                            <span class="bot-stat-label">% Tráfico Bot</span>
                            <span class="bot-stat-value" id="bot-percentage">0%</span>
                        </div>
                    </div>
                    <div class="bot-stat-box">
                        <span class="bot-stat-icon">⚠️</span>
                        <div class="bot-stat-content">
                            <span class="bot-stat-label">Nivel de Riesgo</span>
                            <span class="bot-risk-badge" id="bot-risk-level">Bajo</span>
                        </div>
                    </div>
                </div>
                
                <!-- Tabla de Países Sospechosos -->
                <div class="bot-countries-section" style="margin-top: 2rem;">
                    <h3 class="section-title small">PAÍSES CON TRÁFICO SOSPECHOSO</h3>
                    <div class="section-description">
                        <span class="info-icon">i</span>
                        <p>Países con duración media de sesión inferior a 5 segundos. Este patrón indica tráfico automatizado, bots o usuarios que abandonan inmediatamente.</p>
                    </div>
                    
                    <div class="bot-countries-table-container">
                        <table class="bot-countries-table" id="bot-countries-table">
                            <thead>
                                <tr>
                                    <th>País</th>
                                    <th>Sesiones Totales</th>
                                    <th>Sesiones Engaged</th>
                                    <th>Sesiones Bot</th>
                                    <th>% Rebote</th>
                                    <th>Duración Media</th>
                                    <th>Riesgo</th>
                                </tr>
                            </thead>
                            <tbody id="bot-countries-tbody">
                                <tr>
                                    <td colspan="7" class="loading-text">Cargando datos...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Insight de Bots -->
                <div class="insight-box" style="margin-top: 1.5rem;">
                    <span class="insight-icon">💡</span>
                    <div class="insight-content">
                        <p class="insight-text" id="bot-insight-text">
                            Analizando patrones de tráfico automatizado...
                        </p>
                    </div>
                </div>
            </div>
        </div>
        
        {% elif active_page == 'realtime' %}
        <!-- ================================================================== -->
        <!-- REALTIME TRACKING PAGE -->
        <!-- ================================================================== -->
        
        <div class="realtime-header">
            <div class="realtime-main-stat">
                <div class="realtime-pulse"></div>
                <span class="realtime-big-number" id="realtimeTotalUsers">0</span>
                <span class="realtime-big-label">usuarios activos ahora</span>
            </div>
            <p class="realtime-subtitle">Datos actualizados cada 10 segundos</p>
        </div>
        
        <div class="realtime-grid">
            <!-- Columna 1: Por Ciudad -->
            <div class="realtime-card">
                <div class="realtime-card-header">
                    <span class="realtime-card-icon">🏙️</span>
                    <h3 class="realtime-card-title">Por Ciudad</h3>
                </div>
                <div class="realtime-card-body" id="realtimeCities">
                    <p class="loading-text">Cargando...</p>
                </div>
            </div>
            
            <!-- Columna 2: Por País -->
            <div class="realtime-card">
                <div class="realtime-card-header">
                    <span class="realtime-card-icon">🌍</span>
                    <h3 class="realtime-card-title">Por País</h3>
                </div>
                <div class="realtime-card-body" id="realtimeCountries">
                    <p class="loading-text">Cargando...</p>
                </div>
            </div>
            
            <!-- Columna 3: Por Página -->
            <div class="realtime-card">
                <div class="realtime-card-header">
                    <span class="realtime-card-icon">📄</span>
                    <h3 class="realtime-card-title">Por Página</h3>
                </div>
                <div class="realtime-card-body" id="realtimePages">
                    <p class="loading-text">Cargando...</p>
                </div>
            </div>
            
            <!-- Columna 4: Por Dispositivo -->
            <div class="realtime-card">
                <div class="realtime-card-header">
                    <span class="realtime-card-icon">📱</span>
                    <h3 class="realtime-card-title">Por Dispositivo</h3>
                </div>
                <div class="realtime-card-body" id="realtimeDevices">
                    <p class="loading-text">Cargando...</p>
                </div>
            </div>
        </div>
        
        <!-- Mapa de Tiempo Real -->
        <div class="realtime-map-container">
            <div class="realtime-map-header">
                <div class="realtime-map-title">
                    <span>🗺️</span>
                    <h3>Ubicación de Usuarios Activos</h3>
                </div>
                <div class="realtime-map-legend">
                    <div class="legend-pulse"></div>
                    <span>Usuario activo</span>
                </div>
            </div>
            <div id="realtimeMap"></div>
        </div>
        
        {% endif %}
    </main>
</div>

<!-- Page Progress Bar -->
<div class="page-progress" id="pageProgress"></div>

<!-- Quick Spinner (for page navigation) -->
<div class="quick-spinner" id="quickSpinner">
    <div class="quick-spinner-ring"></div>
</div>

<!-- Refresh Indicator (for F5 reload) -->
<div class="refresh-indicator" id="refreshIndicator">
    <div class="refresh-icon">↻</div>
    <span class="refresh-text">Actualizando...</span>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner">
        <div class="volcano-core"></div>
        <div class="ember"></div>
        <div class="ember"></div>
        <div class="ember"></div>
        <div class="ember"></div>
        <div class="ember"></div>
        <div class="ember"></div>
        <div class="ember"></div>
        <div class="ember"></div>
    </div>
    <p class="loading-text">CALIBRANDO...</p>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Variable global para saber en qué página estamos
    window.activePage = '{{ active_page }}';
    const activePage = window.activePage;
    
    // Tab functionality (main tabs)
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
            const tabId = btn.dataset.tab;
            
            // Si es un sub-tab (gen- o close-), manejarlo de forma diferente
            if (tabId && (tabId.startsWith('gen-') || tabId.startsWith('close-'))) {
                // Manejo de sub-tabs se hace en otro event listener
                return;
            }
            
            // Manejo de tabs principales
            const parentContainer = btn.closest('.tabs-container');
            if (parentContainer) {
                // Solo afectar tabs del mismo contenedor
                parentContainer.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                // Encontrar el contenedor padre (team-container, diana-container, etc.)
                const pageContainer = parentContainer.closest('.team-container, .diana-container, .main-content');
                if (pageContainer) {
                    // Ocultar todos los tab-content del mismo nivel
                    pageContainer.querySelectorAll('.tab-content').forEach(c => {
                        // Solo ocultar si no es un sub-tab
                        if (!c.id.startsWith('gen-') && !c.id.startsWith('close-')) {
                            c.classList.remove('active');
                        }
                    });
                    
                    // Mostrar el tab seleccionado
                    const targetTab = document.getElementById(tabId);
                    if (targetTab) {
                        targetTab.classList.add('active');
                    }
                }
            } else {
                // Fallback: comportamiento original
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                btn.classList.add('active');
                document.getElementById(tabId).classList.add('active');
            }
            
            // Cargar datos específicos según el tab
            if (tabId === 'fuentes-trafico' && window.activePage === 'general_overview') {
                console.log('[TABS] Cargando datos de Fuentes de Tráfico...');
                await loadTrafficSourcesData();
            } else if (tabId === 'pagina-contenido' && window.activePage === 'general_overview') {
                console.log('[TABS] Cargando datos de Página y Contenido...');
                await loadContentRanking();
            } else if (tabId === 'generation-team' && window.activePage === 'team') {
                // Asegurar que el sub-tab Overview esté activo por defecto
                const genOverview = document.getElementById('gen-overview');
                const genKPIs = document.getElementById('gen-kpis');
                if (genOverview) genOverview.classList.add('active');
                if (genKPIs) genKPIs.classList.remove('active');
            } else if (tabId === 'close-team' && window.activePage === 'team') {
                // Asegurar que el sub-tab Overview esté activo por defecto
                const closeOverview = document.getElementById('close-overview');
                const closeKPIs = document.getElementById('close-kpis');
                if (closeOverview) closeOverview.classList.add('active');
                if (closeKPIs) closeKPIs.classList.remove('active');
            }
        });
    });
    
    // Traffic sub-tabs functionality (Análisis General / SEO)
    document.querySelectorAll('.traffic-subtab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            // Remove active from all traffic subtab buttons
            document.querySelectorAll('.traffic-subtab-btn').forEach(b => b.classList.remove('active'));
            // Remove active from all traffic subtab contents
            document.querySelectorAll('.traffic-subtab-content').forEach(c => c.classList.remove('active'));
            
            btn.classList.add('active');
            const subtabId = btn.dataset.trafficSubtab;
            document.getElementById('subtab-' + subtabId).classList.add('active');
            
            // Si se selecciona SEO, cargar datos de Search Console
            if (subtabId === 'seo') {
                loadOrganicData();
            }
        });
    });
    
    // Top selector buttons (Top 5, Top 10, Top 25)
    document.querySelectorAll('.top-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const tableType = btn.dataset.table; // 'queries' o 'pages'
            const topLimit = parseInt(btn.dataset.top);
            
            // Remove active from sibling buttons only
            btn.parentElement.querySelectorAll('.top-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            // Guardar el límite seleccionado
            window.organicLimits = window.organicLimits || { queries: 10, pages: 10 };
            window.organicLimits[tableType] = topLimit;
            
            // Recargar datos con el nuevo límite
            loadOrganicData();
        });
    });
    
    // Organic queries/pages tabs functionality
    document.querySelectorAll('.organic-tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            // Remove active from all organic tab buttons
            document.querySelectorAll('.organic-tab-btn').forEach(b => b.classList.remove('active'));
            // Remove active from all organic tab contents
            document.querySelectorAll('.organic-tab-content').forEach(c => c.classList.remove('active'));
            
            btn.classList.add('active');
            const tabId = btn.dataset.organicTab;
            document.getElementById('organic-' + tabId).classList.add('active');
        });
    });
    
    // Chart sub-tabs functionality (scoped to each section)
    document.querySelectorAll('.chart-tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            // Find the parent tabs container
            const tabsContainer = btn.closest('.chart-tabs-container');
            
            if (tabsContainer) {
                // Remove active from all buttons in this container
                tabsContainer.querySelectorAll('.chart-tab-btn').forEach(b => b.classList.remove('active'));
                
                // Find all sibling chart-tab-content elements (next siblings of the tabs container)
                let sibling = tabsContainer.nextElementSibling;
                while (sibling) {
                    if (sibling.classList.contains('chart-tab-content')) {
                        sibling.classList.remove('active');
                    }
                    sibling = sibling.nextElementSibling;
                }
            }
            
            btn.classList.add('active');
            document.getElementById(btn.dataset.chartTab).classList.add('active');
            
            // Resize charts when tab changes (Plotly needs this)
            setTimeout(() => {
                const chartTab = btn.dataset.chartTab;
                if (chartTab === 'comparacion-periodos') {
                    Plotly.Plots.resize('comparisonChart');
                } else if (chartTab === 'usuarios-tipo') {
                    Plotly.Plots.resize('usersTypeChart');
                } else if (chartTab === 'invalid-users-dist') {
                    Plotly.Plots.resize('invalidUsersChart');
                } else if (chartTab === 'quality-rate-trend') {
                    Plotly.Plots.resize('qualityRateChart');
                } else if (chartTab === 'valid-vs-invalid') {
                    Plotly.Plots.resize('validVsInvalidChart');
                }
            }, 100);
        });
    });
    // Usar sessionStorage para persistir entre páginas (se borra al cerrar pestaña)
    function hasViewedAlerts() {
        return sessionStorage.getItem('alertsViewed') === 'true';
    }

    function updateAlertsNav(alertCount) {
        const alertsItem = document.getElementById('alertsNavItem');
        if (!alertsItem) return;

        // Si ya vio las alertas en esta sesión, no mostrar badge ni estado crítico
        if (hasViewedAlerts()) {
            alertsItem.removeAttribute('data-alert-count');
            alertsItem.classList.remove('alerts-critical');
            return;
        }

        // Badge numérico
        if (alertCount > 0) {
            alertsItem.setAttribute('data-alert-count', alertCount > 99 ? '99+' : alertCount);
        } else {
            alertsItem.removeAttribute('data-alert-count');
        }

        // Estado crítico (≥3 alertas)
        const isCritical = alertCount >= 3;
        const isActive = alertsItem.classList.contains('active');
        
        // No mostrar crítico si estamos en la página de alertas
        if (isCritical && !isActive) {
            alertsItem.classList.add('alerts-critical');
        } else {
            alertsItem.classList.remove('alerts-critical');
        }
    }

    // Marcar alertas como vistas cuando se hace clic en el botón
    window.markAlertsAsViewed = function() {
        sessionStorage.setItem('alertsViewed', 'true');
        const alertsItem = document.getElementById('alertsNavItem');
        if (alertsItem) {
            alertsItem.removeAttribute('data-alert-count');
            alertsItem.classList.remove('alerts-critical');
        }
    }

    // ===== REALTIME USERS =====
    async function loadRealtimeUsers() {
        try {
            const response = await fetch('/api/get-realtime-users');
            const data = await response.json();
            
            const realtimeEl = document.getElementById('realtimeUsers');
            if (realtimeEl && data.success) {
                realtimeEl.textContent = data.activeUsers;
                realtimeEl.style.color = data.activeUsers > 0 ? '#6CA8A4' : 'rgba(255,255,255,0.5)';
            }
        } catch (error) {
            console.log('[REALTIME] Error:', error);
        }
    }
    
    // Actualizar usuarios cada 30 segundos
    setInterval(loadRealtimeUsers, 30000);
    
    // ===== REALTIME PAGE DETAILS =====
    async function loadRealtimeDetails() {
        if (window.activePage !== 'realtime') return;
        
        try {
            const response = await fetch('/api/get-realtime-details');
            const data = await response.json();
            
            if (!data.success) {
                console.log('[REALTIME] Error:', data.error);
                return;
            }
            
            // Actualizar número grande
            const totalEl = document.getElementById('realtimeTotalUsers');
            if (totalEl) totalEl.textContent = data.totalUsers;
            
            // Renderizar ciudades
            renderRealtimeList('realtimeCities', data.cities, 'city', data.totalUsers);
            
            // Renderizar países
            renderRealtimeList('realtimeCountries', data.countries, 'country', data.totalUsers);
            
            // Renderizar páginas
            renderRealtimeList('realtimePages', data.pages, 'page', data.totalUsers);
            
            // Renderizar dispositivos
            renderRealtimeList('realtimeDevices', data.devices, 'device', data.totalUsers);
            
            // Actualizar mapa con las ciudades
            updateMapMarkers(data.cities);
            
        } catch (error) {
            console.log('[REALTIME DETAILS] Error:', error);
        }
    }
    
    function renderRealtimeList(containerId, items, nameKey, total) {
        const container = document.getElementById(containerId);
        if (!container) return;
        
        if (!items || items.length === 0) {
            container.innerHTML = '<p class="realtime-empty">Sin datos en este momento</p>';
            return;
        }
        
        const maxUsers = Math.max(...items.map(i => i.users));
        
        let html = '';
        items.forEach(item => {
            const name = item[nameKey] || 'Desconocido';
            const users = item.users;
            const percentage = maxUsers > 0 ? (users / maxUsers * 100) : 0;
            
            html += `
                <div class="realtime-row">
                    <span class="realtime-row-name" title="${name}">${name}</span>
                    <div class="realtime-row-bar">
                        <div class="realtime-row-bar-fill" style="width: ${percentage}%"></div>
                    </div>
                    <span class="realtime-row-value">${users}</span>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }
    
    // ===== REALTIME MAP =====
    let realtimeMap = null;
    let markersLayer = null;
    
    function initRealtimeMap() {
        if (window.activePage !== 'realtime') return;
        
        const mapContainer = document.getElementById('realtimeMap');
        if (!mapContainer || realtimeMap) return;
        
        // Inicializar mapa centrado en el mundo
        realtimeMap = L.map('realtimeMap', {
            center: [30, 0],
            zoom: 2,
            minZoom: 2,
            maxZoom: 12,
            zoomControl: true
        });
        
        // Añadir capa de tiles (CartoDB Dark)
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(realtimeMap);
        
        // Crear capa para los marcadores
        markersLayer = L.layerGroup().addTo(realtimeMap);
        
        console.log('[MAP] Mapa inicializado');
    }
    
    function createPulseIcon(users) {
        const size = Math.min(30 + users * 5, 60);
        return L.divIcon({
            className: 'pulse-marker-container',
            html: `
                <div class="pulse-marker" style="width: ${size}px; height: ${size}px;">
                    <div class="pulse-marker-ring"></div>
                    <div class="pulse-marker-ring pulse-marker-ring-2"></div>
                    <div class="pulse-marker-inner" style="width: ${size * 0.4}px; height: ${size * 0.4}px;"></div>
                </div>
            `,
            iconSize: [size, size],
            iconAnchor: [size / 2, size / 2]
        });
    }
    
    function updateMapMarkers(cities) {
        if (!realtimeMap || !markersLayer) return;
        
        // Limpiar marcadores existentes
        markersLayer.clearLayers();
        
        if (!cities || cities.length === 0) {
            console.log('[MAP] No hay ciudades para mostrar');
            return;
        }
        
        // Diccionario de coordenadas de ciudades principales
        const cityCoords = {
            // España
            'barcelona': [41.3851, 2.1734],
            'madrid': [40.4168, -3.7038],
            'valencia': [39.4699, -0.3763],
            'sevilla': [37.3891, -5.9845],
            'bilbao': [43.2630, -2.9350],
            'malaga': [36.7213, -4.4214],
            'zaragoza': [41.6488, -0.8891],
            // Europa
            'london': [51.5074, -0.1278],
            'paris': [48.8566, 2.3522],
            'berlin': [52.5200, 13.4050],
            'rome': [41.9028, 12.4964],
            'amsterdam': [52.3676, 4.9041],
            'lisbon': [38.7223, -9.1393],
            'dublin': [53.3498, -6.2603],
            'vienna': [48.2082, 16.3738],
            'brussels': [50.8503, 4.3517],
            'munich': [48.1351, 11.5820],
            'milan': [45.4642, 9.1900],
            'prague': [50.0755, 14.4378],
            'warsaw': [52.2297, 21.0122],
            'stockholm': [59.3293, 18.0686],
            'copenhagen': [55.6761, 12.5683],
            'helsinki': [60.1699, 24.9384],
            'zurich': [47.3769, 8.5417],
            'geneva': [46.2044, 6.1432],
            // América
            'new york': [40.7128, -74.0060],
            'los angeles': [34.0522, -118.2437],
            'chicago': [41.8781, -87.6298],
            'miami': [25.7617, -80.1918],
            'san francisco': [37.7749, -122.4194],
            'mexico city': [19.4326, -99.1332],
            'buenos aires': [-34.6037, -58.3816],
            'sao paulo': [-23.5505, -46.6333],
            'bogota': [4.7110, -74.0721],
            'lima': [-12.0464, -77.0428],
            'santiago': [-33.4489, -70.6693],
            'toronto': [43.6532, -79.3832],
            // Asia
            'tokyo': [35.6762, 139.6503],
            'beijing': [39.9042, 116.4074],
            'shanghai': [31.2304, 121.4737],
            'hong kong': [22.3193, 114.1694],
            'singapore': [1.3521, 103.8198],
            'dubai': [25.2048, 55.2708],
            'mumbai': [19.0760, 72.8777],
            'bangkok': [13.7563, 100.5018],
            'seoul': [37.5665, 126.9780],
            // Australia
            'sydney': [-33.8688, 151.2093],
            'melbourne': [-37.8136, 144.9631],
            // África
            'johannesburg': [-26.2041, 28.0473],
            'cairo': [30.0444, 31.2357],
            'lagos': [6.5244, 3.3792],
            'nairobi': [-1.2921, 36.8219],
            // Otros
            '(not set)': null
        };
        
        cities.forEach(cityData => {
            const cityName = cityData.city.toLowerCase();
            let coords = cityCoords[cityName];
            
            // Si no encontramos coordenadas exactas, intentar coincidencia parcial
            if (!coords) {
                for (const [key, value] of Object.entries(cityCoords)) {
                    if (cityName.includes(key) || key.includes(cityName)) {
                        coords = value;
                        break;
                    }
                }
            }
            
            // Si aún no hay coordenadas, generar aleatorias (para demo)
            if (!coords) {
                // Generar coordenadas semi-aleatorias basadas en el nombre
                const hash = cityName.split('').reduce((a, b) => ((a << 5) - a) + b.charCodeAt(0), 0);
                coords = [
                    (hash % 140) - 70,  // Lat entre -70 y 70
                    ((hash * 2) % 360) - 180  // Lng entre -180 y 180
                ];
                console.log(`[MAP] Ciudad "${cityData.city}" sin coords, usando generadas:`, coords);
            }
            
            if (coords) {
                const marker = L.marker(coords, {
                    icon: createPulseIcon(cityData.users)
                });
                
                marker.bindPopup(`
                    <div class="popup-city">${cityData.city}</div>
                    <div class="popup-users"><strong>${cityData.users}</strong> usuario${cityData.users > 1 ? 's' : ''} activo${cityData.users > 1 ? 's' : ''}</div>
                `);
                
                markersLayer.addLayer(marker);
            }
        });
        
        console.log(`[MAP] ${cities.length} marcadores añadidos`);
    }
    
    // Si estamos en la página de realtime, cargar datos y actualizar cada 10 segundos
    if (window.activePage === 'realtime') {
        // Esperar a que el DOM esté listo y luego inicializar el mapa
        setTimeout(() => {
            initRealtimeMap();
            loadRealtimeDetails();
        }, 100);
        setInterval(loadRealtimeDetails, 10000);
    }

    // ===== TRAFFIC SOURCES PAGE =====
    async function loadTrafficSourcesData() {
        console.log('[TRAFFIC-JS] Cargando datos de fuentes de tráfico...');
        
        try {
            // Obtener filtros directamente del sidebar
            const filters = getAllFilters();
            console.log('[TRAFFIC-JS] Filtros:', filters);
            
            const response = await fetch('/api/get-traffic-sources', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    fecha_inicio: filters.startDate,
                    fecha_fin: filters.endDate,
                    page: filters.page || null,
                    country: filters.country || null,
                    traffic_source: filters.trafficSource || null
                })
            });
            const data = await response.json();
            console.log('[TRAFFIC-JS] Respuesta:', data);
            
            console.log('[TRAFFIC-JS] Datos recibidos, success:', data.success, 'channels:', data.channels?.length);
            
            if (data.success && data.channels) {
                console.log('[TRAFFIC-JS] Llamando a renderChannelTable...');
                // Renderizar tabla de canales
                renderChannelTable(data.channels);
                
                // Actualizar insight
                const insightEl = document.getElementById('traffic-insight-text');
                if (insightEl && data.channels.length > 0) {
                    // Encontrar canal con mejor rendimiento
                    const topChannel = data.channels[0];
                    const bestEngagement = data.channels.reduce((best, c) => c.engagement_rate > best.engagement_rate ? c : best, data.channels[0]);
                    const worstPerformer = data.channels.find(c => c.sessions_delta < 0 && c.channel.includes('Paid'));
                    
                    let insightText = `El tráfico <strong>${getChannelName(topChannel.channel)}</strong> lidera el rendimiento con el mayor crecimiento sostenido`;
                    if (worstPerformer) {
                        insightText += `, mientras que <strong>${getChannelName(worstPerformer.channel)}</strong> muestra una caída significativa que sugiere menor eficiencia en campañas actuales`;
                    }
                    insightText += `. <strong>${getChannelName(bestEngagement.channel)}</strong> destaca como el canal más cualificado con el engagement más alto.`;
                    insightEl.innerHTML = insightText;
                }
                
                // Gráfico de distribución (pie chart)
                renderChannelDistributionChart(data.channels);
                
                // Gráfico de tendencia
                renderChannelTrendChart(data.trend);
            }
            
        } catch (error) {
            console.log('[TRAFFIC] Error:', error);
        }
    }
    
    // Mapeo de nombres de canales
    function getChannelName(channel) {
        const map = {
            'Organic Search': 'Orgánico',
            'Direct': 'Directo',
            'Referral': 'Referral',
            'Organic Social': 'Social',
            'Paid Search': 'Paid',
            'Email': 'Email',
            'Paid Social': 'Paid Social',
            'Cross-network': 'Cross-network',
            'Unassigned': 'Sin asignar',
            'Paid Other': 'Otros Paid'
        };
        return map[channel] || channel;
    }
    
    // ========================================
    // CARGAR DATOS DE SEARCH CONSOLE (QUERIES Y PÁGINAS ORGÁNICAS)
    // ========================================
    function loadOrganicData() {
        // Obtener filtros de fecha
        const filters = getAllFilters();
        const startDate = new Date(filters.startDate);
        const endDate = new Date(filters.endDate);
        const daysDiff = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
        
        // Obtener límites seleccionados
        const limits = window.organicLimits || { queries: 10, pages: 10 };
        
        console.log('[SEO] Cargando datos orgánicos para período:', filters.startDate, 'a', filters.endDate, `(${daysDiff} días)`, 'Límites:', limits);
        
        // Factor de escala basado en días (30 días = factor 1)
        const scaleFactor = daysDiff / 30;
        
        // Datos base (equivalentes a 30 días) - reemplazar con API de Search Console cuando esté disponible
        const baseQueriesData = [
            { query: 'crata ai', impressions: 12400, clicks: 1250, ctr: 0.101, position: 2.4, delta: '+6% impresiones / +0.3 posiciones' },
            { query: 'inteligencia artificial pymes', impressions: 8900, clicks: 410, ctr: 0.046, position: 8.1, delta: '+12% clics / -0.5 posiciones' },
            { query: 'automatización de procesos', impressions: 7200, clicks: 350, ctr: 0.048, position: 11.3, delta: '+18% clics / +1.1 posiciones' },
            { query: 'consultoría IA', impressions: 6850, clicks: 290, ctr: 0.042, position: 9.7, delta: '+9% clics / sin cambio' },
            { query: 'dashboards con IA', impressions: 5400, clicks: 260, ctr: 0.049, position: 6.4, delta: '+22% impresiones / +0.6 posiciones' },
            { query: 'machine learning empresas', impressions: 4900, clicks: 210, ctr: 0.043, position: 13, delta: '-3% clics / +0.4 posiciones' },
            { query: 'optimización procesos IA', impressions: 4120, clicks: 185, ctr: 0.045, position: 10.9, delta: '+15% clics / -0.2 posiciones' },
            { query: 'data analytics madrid', impressions: 3950, clicks: 170, ctr: 0.043, position: 7.8, delta: '+8% clics / +0.1 posiciones' },
            { query: 'soluciones IA para negocios', impressions: 3600, clicks: 160, ctr: 0.044, position: 12.6, delta: '+10% impresiones / -0.3 posiciones' },
            { query: 'automatizar tareas repetitivas', impressions: 3200, clicks: 135, ctr: 0.042, position: 14.1, delta: '+5% clics / sin cambio' },
            { query: 'transformación digital', impressions: 2900, clicks: 120, ctr: 0.041, position: 15.2, delta: '+7% impresiones / +0.2 posiciones' },
            { query: 'chatbot empresarial', impressions: 2750, clicks: 115, ctr: 0.042, position: 12.8, delta: '+14% clics / -0.4 posiciones' },
            { query: 'análisis predictivo', impressions: 2600, clicks: 105, ctr: 0.040, position: 16.3, delta: '+3% clics / +0.8 posiciones' },
            { query: 'big data empresas', impressions: 2450, clicks: 98, ctr: 0.040, position: 14.7, delta: '-5% impresiones / sin cambio' },
            { query: 'RPA automatización', impressions: 2300, clicks: 92, ctr: 0.040, position: 17.1, delta: '+11% clics / +0.5 posiciones' },
            { query: 'inteligencia de negocios', impressions: 2150, clicks: 85, ctr: 0.040, position: 15.9, delta: '+4% impresiones / -0.3 posiciones' },
            { query: 'software analítica', impressions: 2000, clicks: 78, ctr: 0.039, position: 18.4, delta: '+9% clics / +1.2 posiciones' },
            { query: 'consultoría datos', impressions: 1850, clicks: 72, ctr: 0.039, position: 16.8, delta: '+2% clics / sin cambio' },
            { query: 'dashboards interactivos', impressions: 1700, clicks: 68, ctr: 0.040, position: 19.2, delta: '+16% impresiones / +0.7 posiciones' },
            { query: 'KPIs negocio', impressions: 1550, clicks: 62, ctr: 0.040, position: 17.5, delta: '+6% clics / -0.2 posiciones' },
            { query: 'reporting automatizado', impressions: 1400, clicks: 55, ctr: 0.039, position: 20.1, delta: '+8% impresiones / +0.4 posiciones' },
            { query: 'visualización datos', impressions: 1250, clicks: 50, ctr: 0.040, position: 18.9, delta: '-2% clics / +0.6 posiciones' },
            { query: 'ETL procesos', impressions: 1100, clicks: 42, ctr: 0.038, position: 21.3, delta: '+12% clics / +1.0 posiciones' },
            { query: 'data warehouse', impressions: 950, clicks: 38, ctr: 0.040, position: 19.7, delta: '+5% impresiones / sin cambio' },
            { query: 'minería de datos', impressions: 800, clicks: 32, ctr: 0.040, position: 22.5, delta: '+10% clics / +0.3 posiciones' }
        ];
        
        const basePagesData = [
            { page: '/ai-solutions', impressions: 15200, clicks: 1450, ctr: 0.095, position: 3.2, delta: '+12% clics / +0.5 posiciones' },
            { page: '/blog/ia-empresas', impressions: 9800, clicks: 520, ctr: 0.053, position: 6.8, delta: '+8% impresiones / -0.2 posiciones' },
            { page: '/servicios/consultoria', impressions: 7500, clicks: 380, ctr: 0.051, position: 8.4, delta: '+15% clics / +0.8 posiciones' },
            { page: '/casos-exito', impressions: 6200, clicks: 310, ctr: 0.050, position: 9.1, delta: '+5% impresiones / sin cambio' },
            { page: '/precios', impressions: 5800, clicks: 290, ctr: 0.050, position: 7.2, delta: '+18% clics / +1.2 posiciones' },
            { page: '/contacto', impressions: 4500, clicks: 225, ctr: 0.050, position: 5.9, delta: '+3% clics / -0.1 posiciones' },
            { page: '/blog/automatizacion', impressions: 4100, clicks: 195, ctr: 0.048, position: 11.5, delta: '+22% impresiones / +0.4 posiciones' },
            { page: '/sobre-nosotros', impressions: 3800, clicks: 170, ctr: 0.045, position: 10.3, delta: '+7% clics / +0.3 posiciones' },
            { page: '/blog/machine-learning', impressions: 3200, clicks: 140, ctr: 0.044, position: 13.7, delta: '-2% clics / +0.6 posiciones' },
            { page: '/demo', impressions: 2900, clicks: 145, ctr: 0.050, position: 6.5, delta: '+25% clics / +1.5 posiciones' },
            { page: '/blog/transformacion-digital', impressions: 2650, clicks: 125, ctr: 0.047, position: 12.1, delta: '+9% impresiones / +0.2 posiciones' },
            { page: '/recursos/guias', impressions: 2400, clicks: 110, ctr: 0.046, position: 14.3, delta: '+11% clics / -0.5 posiciones' },
            { page: '/blog/chatbots', impressions: 2200, clicks: 95, ctr: 0.043, position: 15.8, delta: '+6% clics / +0.7 posiciones' },
            { page: '/partners', impressions: 2000, clicks: 85, ctr: 0.043, position: 13.2, delta: '+4% impresiones / sin cambio' },
            { page: '/blog/analytics', impressions: 1850, clicks: 78, ctr: 0.042, position: 16.5, delta: '+13% clics / +0.4 posiciones' },
            { page: '/industrias/retail', impressions: 1700, clicks: 72, ctr: 0.042, position: 14.9, delta: '-3% impresiones / +0.8 posiciones' },
            { page: '/industrias/finanzas', impressions: 1550, clicks: 65, ctr: 0.042, position: 17.2, delta: '+8% clics / -0.3 posiciones' },
            { page: '/recursos/webinars', impressions: 1400, clicks: 58, ctr: 0.041, position: 15.6, delta: '+15% impresiones / +0.5 posiciones' },
            { page: '/blog/big-data', impressions: 1250, clicks: 50, ctr: 0.040, position: 18.4, delta: '+5% clics / sin cambio' },
            { page: '/carreras', impressions: 1100, clicks: 45, ctr: 0.041, position: 16.9, delta: '+7% impresiones / +0.2 posiciones' },
            { page: '/blog/rpa', impressions: 950, clicks: 40, ctr: 0.042, position: 19.1, delta: '+10% clics / +0.6 posiciones' },
            { page: '/recursos/ebooks', impressions: 850, clicks: 35, ctr: 0.041, position: 17.8, delta: '+2% clics / -0.4 posiciones' },
            { page: '/industrias/salud', impressions: 750, clicks: 30, ctr: 0.040, position: 20.3, delta: '+12% impresiones / +0.9 posiciones' },
            { page: '/blog/kpis', impressions: 650, clicks: 26, ctr: 0.040, position: 18.7, delta: '+4% clics / sin cambio' },
            { page: '/legal/privacidad', impressions: 550, clicks: 22, ctr: 0.040, position: 21.5, delta: '+1% impresiones / +0.3 posiciones' }
        ];
        
        // Escalar datos según el período seleccionado
        const queriesData = baseQueriesData.slice(0, limits.queries).map(item => ({
            ...item,
            impressions: Math.round(item.impressions * scaleFactor),
            clicks: Math.round(item.clicks * scaleFactor)
        }));
        
        const pagesData = basePagesData.slice(0, limits.pages).map(item => ({
            ...item,
            impressions: Math.round(item.impressions * scaleFactor),
            clicks: Math.round(item.clicks * scaleFactor)
        }));
        
        // Formatear período para mostrar
        const periodoStr = `${filters.startDate} a ${filters.endDate}`;
        
        renderOrganicTable('organic-queries-body', queriesData, 'query', periodoStr);
        renderOrganicTable('organic-pages-body', pagesData, 'page', periodoStr);
    }
    
    function renderOrganicTable(tbodyId, data, type, periodo = '') {
        const tbody = document.getElementById(tbodyId);
        if (!tbody) return;
        
        if (!data || data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:rgba(255,255,255,0.5);padding:2rem;">Sin datos disponibles</td></tr>';
            return;
        }
        
        console.log(`[SEO] Renderizando tabla ${type} con ${data.length} registros para período: ${periodo}`);
        
        let html = '';
        data.forEach(row => {
            const displayText = type === 'query' ? row.query : row.page;
            const ctrFormatted = (row.ctr * 100).toFixed(3);
            
            // Formatear impresiones (ej: 12.4K, 8.9K)
            const impressionsFormatted = row.impressions >= 1000 
                ? (row.impressions / 1000).toFixed(1) 
                : row.impressions;
            
            // Determinar color del delta
            let deltaClass = 'delta-neutral';
            if (row.delta.includes('+')) deltaClass = 'delta-positive';
            else if (row.delta.includes('-')) deltaClass = 'delta-negative';
            
            html += `
                <tr>
                    <td class="query-cell">${escapeHtml(displayText)}</td>
                    <td class="metric-cell">${impressionsFormatted}</td>
                    <td class="metric-cell">${formatNumber(row.clicks)}</td>
                    <td class="metric-cell">${ctrFormatted}</td>
                    <td class="metric-cell">${row.position.toFixed(1)}</td>
                    <td class="delta-cell ${deltaClass}">${row.delta}</td>
                </tr>
            `;
        });
        
        tbody.innerHTML = html;
    }
    
    // ========================================
    // CARGAR RANKING DE CONTENIDO
    // ========================================
    async function loadContentRanking() {
        console.log('[CONTENT] Cargando ranking de contenido...');
        
        try {
            // Obtener filtros directamente del sidebar (no de window.currentFilters)
            const filters = getAllFilters();
            console.log('[CONTENT] Filtros aplicados:', filters);
            
            const response = await fetch('/api/get-content-ranking', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    fecha_inicio: filters.startDate,
                    fecha_fin: filters.endDate,
                    page: filters.page || null,
                    country: filters.country || null,
                    traffic_source: filters.trafficSource || null
                })
            });
            
            const data = await response.json();
            console.log('[CONTENT] Respuesta:', data);
            
            if (data.success && data.pages) {
                renderContentRankingTable(data.pages);
            } else {
                const tbody = document.getElementById('content-ranking-body');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:rgba(255,255,255,0.5);padding:2rem;">Sin datos de contenido disponibles</td></tr>';
                }
            }
            
        } catch (error) {
            console.error('[CONTENT] Error:', error);
            const tbody = document.getElementById('content-ranking-body');
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:rgba(255,255,255,0.5);padding:2rem;">Error al cargar datos</td></tr>';
            }
        }
    }
    
    // Renderizar tabla de ranking de contenido
    function renderContentRankingTable(pages) {
        const tbody = document.getElementById('content-ranking-body');
        if (!tbody) return;
        
        if (!pages || pages.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:rgba(255,255,255,0.5);padding:2rem;">Sin datos disponibles</td></tr>';
            return;
        }
        
        let html = '';
        pages.forEach(page => {
            // Determinar color de bounce rate
            let bounceClass = 'medium';
            if (page.bounce_rate >= 70) bounceClass = 'high';
            else if (page.bounce_rate <= 40) bounceClass = 'low';
            
            html += `
                <tr>
                    <td class="page-title">${escapeHtml(page.title)}</td>
                    <td>
                        <div class="metric-cell">
                            <span class="metric-value">${formatNumber(page.views)}</span>
                            <div class="metric-bar">
                                <div class="metric-bar-fill" style="width: ${page.views_pct}%"></div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div class="metric-cell">
                            <span class="metric-value">${formatNumber(page.active_users)}</span>
                            <div class="metric-bar">
                                <div class="metric-bar-fill" style="width: ${page.users_pct}%"></div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div class="metric-cell">
                            <span class="metric-value">${formatNumber(page.event_count)}</span>
                            <div class="metric-bar">
                                <div class="metric-bar-fill" style="width: ${page.events_pct}%"></div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="bounce-rate ${bounceClass}">${page.bounce_rate}%</span>
                    </td>
                </tr>
            `;
        });
        
        tbody.innerHTML = html;
    }
    
    // Función auxiliar para escapar HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Renderizar tabla de canales
    function renderChannelTable(channels) {
        console.log('[RENDER] Renderizando tabla con', channels?.length, 'canales');
        const tbody = document.getElementById('channelTableBody');
        if (!tbody) {
            console.log('[RENDER] ERROR: No se encontró channelTableBody');
            return;
        }
        if (!channels || channels.length === 0) {
            console.log('[RENDER] No hay canales para renderizar');
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:rgba(255,255,255,0.5);">Sin datos para el periodo seleccionado</td></tr>';
            return;
        }
        
        let html = '';
        channels.slice(0, 8).forEach(ch => {
            console.log('[RENDER] Canal:', ch.channel, 'Sessions:', ch.sessions);
            const sessionsClass = ch.sessions_delta >= 0 ? 'positive' : 'negative';
            const sessionsArrow = ch.sessions_delta >= 0 ? '▲' : '▼';
            const usersClass = ch.users_delta >= 0 ? 'positive' : 'negative';
            const usersArrow = ch.users_delta >= 0 ? '▲' : '▼';
            const wowClass = ch.wow >= 0 ? 'positive' : 'negative';
            const momClass = ch.mom >= 0 ? 'positive' : 'negative';
            
            html += `
                <tr>
                    <td><span class="channel-name">${getChannelName(ch.channel)}</span></td>
                    <td>
                        <span class="channel-value">${formatNumber(ch.sessions)}</span>
                        <span class="channel-delta ${sessionsClass}">
                            <span class="arrow">${sessionsArrow}</span>${Math.abs(ch.sessions_delta)}%
                        </span>
                    </td>
                    <td>
                        <span class="channel-value">${formatNumber(ch.users)}</span>
                        <span class="channel-delta ${usersClass}">
                            <span class="arrow">${usersArrow}</span>${Math.abs(ch.users_delta)}%
                        </span>
                    </td>
                    <td><span class="engagement-value">${ch.engagement_rate}%</span></td>
                    <td><span class="wow-value ${wowClass}">${ch.wow >= 0 ? '+' : ''}${ch.wow}%</span></td>
                    <td><span class="mom-value ${momClass}">${ch.mom >= 0 ? '+' : ''}${ch.mom}%</span></td>
                </tr>
            `;
        });
        
        tbody.innerHTML = html;
    }
    
    window.toggleDetailedTable = function() {
        // Por ahora solo muestra un mensaje
        alert('Funcionalidad de tabla detallada próximamente');
    }
    
    function renderChannelDistributionChart(channels) {
        const container = document.getElementById('channelDistributionChart');
        if (!container || !channels || channels.length === 0) return;
        
        const colors = ['#6CA8A4', '#4a8a86', '#ff5252', '#ffc107', '#9c27b0', '#2196f3', '#4caf50', '#ff9800'];
        
        const trace = {
            values: channels.map(c => c.sessions),
            labels: channels.map(c => c.channel),
            type: 'pie',
            hole: 0.5,
            marker: {
                colors: colors.slice(0, channels.length)
            },
            textinfo: 'percent',
            textposition: 'outside',
            textfont: { color: '#fff', size: 11 },
            hovertemplate: '<b>%{label}</b><br>Sesiones: %{value}<br>%{percent}<extra></extra>'
        };
        
        const layout = {
            paper_bgcolor: 'transparent',
            plot_bgcolor: 'transparent',
            font: { color: '#fff', family: 'Outfit' },
            margin: { t: 30, b: 30, l: 30, r: 30 },
            showlegend: true,
            legend: {
                orientation: 'h',
                y: -0.1,
                font: { size: 10, color: 'rgba(255,255,255,0.7)' }
            }
        };
        
        Plotly.newPlot(container, [trace], layout, { responsive: true, displayModeBar: false });
    }
    
    function renderChannelTrendChart(trend) {
        const container = document.getElementById('channelTrendChart');
        if (!container || !trend || trend.length === 0) return;
        
        const colors = ['#6CA8A4', '#4a8a86', '#ff5252', '#ffc107', '#9c27b0'];
        
        const traces = trend.map((ch, idx) => ({
            x: ch.dates,
            y: ch.sessions,
            name: ch.channel,
            type: 'scatter',
            mode: 'lines+markers',
            line: { color: colors[idx % colors.length], width: 2 },
            marker: { size: 4 }
        }));
        
        const layout = {
            paper_bgcolor: 'transparent',
            plot_bgcolor: 'transparent',
            font: { color: '#fff', family: 'Outfit' },
            margin: { t: 20, b: 50, l: 50, r: 20 },
            xaxis: {
                gridcolor: 'rgba(108, 168, 164, 0.1)',
                tickfont: { size: 10 }
            },
            yaxis: {
                gridcolor: 'rgba(108, 168, 164, 0.1)',
                tickfont: { size: 10 }
            },
            legend: {
                orientation: 'h',
                y: 1.1,
                font: { size: 10 }
            }
        };
        
        Plotly.newPlot(container, traces, layout, { responsive: true, displayModeBar: false });
    }
    
    // ===== EVENTS DATA =====
    async function loadEventsData() {
        console.log('[EVENTS-JS] Cargando datos de eventos...');
        try {
            const { startDate, endDate } = getDateRange();
            const filters = window.currentFilters || {};
            const response = await fetch('/api/get-events-data', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    fecha_inicio: startDate,
                    fecha_fin: endDate,
                    page: filters.page || null,
                    country: filters.country || null,
                    traffic_source: filters.trafficSource || null
                })
            });
            const data = await response.json();
            
            if (data.success && data.events) {
                const e = data.events;
                
                // Actualizar KPIs de eventos
                updateKpiValue('totalEvents', formatNumber(e.total_events), e.total_events_delta || 0);
                updateKpiValue('conversionsEvents', formatNumber(e.conversions), e.conversions_delta);
                updateKpiValue('conversionRate', e.conversion_rate.toFixed(1) + '%', e.conversion_rate_delta);
                updateKpiValue('eventsPerSession', e.events_per_session.toFixed(2), e.conversions_delta);
                
                // Actualizar insight
                const insightEl = document.getElementById('events-insight-text');
                if (insightEl) {
                    if (e.conversions > 0) {
                        insightEl.innerHTML = `Has registrado <strong>${e.conversions} conversiones</strong> con una tasa del <strong>${e.conversion_rate.toFixed(1)}%</strong>. ` +
                            (e.conversions_delta >= 0 ? 
                                `Las conversiones han <span style="color:#4CAF50">aumentado un ${e.conversions_delta.toFixed(1)}%</span> respecto al periodo anterior.` :
                                `Las conversiones han <span style="color:#ff5252">disminuido un ${Math.abs(e.conversions_delta).toFixed(1)}%</span> respecto al periodo anterior.`);
                    } else {
                        insightEl.textContent = 'No hay conversiones registradas en este periodo.';
                    }
                }
                
                // Gráfico de tendencia de conversiones
                renderConversionsTrendChart(data.trend);
            }
            
        } catch (error) {
            console.log('[EVENTS] Error:', error);
        }
    }
    
    function updateKpiValue(id, value, delta) {
        const el = document.getElementById(id);
        const deltaEl = document.getElementById(id + 'Delta');
        if (el) el.textContent = value;
        if (deltaEl) {
            deltaEl.textContent = (delta >= 0 ? '+' : '') + delta.toFixed(1) + '%';
            deltaEl.className = 'kpi-delta ' + (delta >= 0 ? 'positive' : 'negative');
        }
    }
    
    function renderConversionsTrendChart(trend) {
        const container = document.getElementById('conversionsTrendChart');
        if (!container || !trend || trend.length === 0) return;
        
        const trace = {
            x: trend.map(t => t.date),
            y: trend.map(t => t.conversions),
            type: 'scatter',
            mode: 'lines+markers',
            fill: 'tozeroy',
            fillcolor: 'rgba(108, 168, 164, 0.2)',
            line: { color: '#6CA8A4', width: 2 },
            marker: { size: 6, color: '#6CA8A4' }
        };
        
        const layout = {
            paper_bgcolor: 'transparent',
            plot_bgcolor: 'transparent',
            font: { color: '#fff', family: 'Outfit' },
            margin: { t: 20, b: 50, l: 50, r: 20 },
            xaxis: {
                gridcolor: 'rgba(108, 168, 164, 0.1)',
                tickfont: { size: 10 }
            },
            yaxis: {
                gridcolor: 'rgba(108, 168, 164, 0.1)',
                tickfont: { size: 10 }
            }
        };
        
        Plotly.newPlot(container, [trace], layout, { responsive: true, displayModeBar: false });
    }
    
    // Los datos de fuentes de tráfico ahora se cargan desde el tab en general_overview

    // ===== SMART ASSISTANT FUNCTIONS =====
    
    // Función para obtener el saludo según la hora
    function getTimeGreeting() {
        const hour = new Date().getHours();
        if (hour >= 6 && hour < 12) return '¡Buenos días';
        else if (hour >= 12 && hour < 20) return '¡Buenas tardes';
        else return '¡Buenas noches';
    }
    
    // Obtener nombre del usuario
    function getUserName() {
        return window.userName || 'Usuario';
    }
    
    function updateAssistant(alertCount, criticalCount = 0) {
        const box = document.getElementById('assistantBox');
        const message = document.getElementById('assistantMessage');
        const action = document.getElementById('assistantAction');
        
        if (!box || !message || !action) return;
        
        // Obtener saludo con nombre
        const greeting = `${getTimeGreeting()}, <strong>${getUserName()}</strong>!`;
        
        if (alertCount > 0) {
            // Estado con alertas
            box.classList.remove('no-alerts');
            box.classList.add('has-alerts');
            
            if (criticalCount > 0) {
                message.innerHTML = `${greeting} Tienes <span class="highlight">${alertCount} alertas</span> pendientes, <strong>${criticalCount} son críticas</strong>. Te recomiendo revisarlas.`;
            } else {
                message.innerHTML = `${greeting} Hay <span class="highlight">${alertCount} alertas</span> que deberías revisar.`;
            }
            
            action.innerHTML = `
                <a href="/alerts" class="assistant-btn primary" onclick="markAlertsAsViewed()">Ver Alertas</a>
            `;
        } else {
            // Estado sin alertas
            box.classList.remove('has-alerts');
            box.classList.add('no-alerts');
            
            message.innerHTML = `${greeting} Todo en orden. No hay alertas pendientes. ¡Sigue así!`;
            
            action.innerHTML = `
                <a href="/alerts" class="assistant-btn secondary">Historial</a>
            `;
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        console.log('[INIT] DOM loaded, activePage:', window.activePage);

        // Detectar tipo de navegación
        const navEntry = performance.getEntriesByType('navigation')[0];
        const navType = navEntry ? navEntry.type : 'navigate';
        console.log('[NAV] Tipo de navegación:', navType);
        
        // Solo resetear en recarga (F5), NO en navegación entre páginas
        if (navType === 'reload') {
            sessionStorage.removeItem('alertsViewed');
            console.log('[NAV] Recarga detectada - SessionStorage reseteado');
        }

        // Si ya estamos en alertas, marcar como vistas inmediatamente
        if (window.activePage === 'alerts') {
            sessionStorage.setItem('alertsViewed', 'true');
            sessionStorage.setItem('toastDismissed', 'true');
        }

        // 🔔 ALERTS SIDEBAR (el toast se muestra después de cargar datos en loadAlerts)
        const totalAlerts = window.totalAlerts || 0;
        updateAlertsNav(totalAlerts);

        // Event listener para marcar como vistas al hacer clic
        const alertsItem = document.getElementById('alertsNavItem');
        if (alertsItem) {
            alertsItem.addEventListener('click', markAlertsAsViewed);
        }

        // 🔄 PAGE TRANSITION: Interceptar navegación entre páginas
        document.querySelectorAll('.nav-item').forEach(link => {
            link.addEventListener('click', function(e) {
                const href = this.getAttribute('href');
                
                // Si es la misma página, no hacer nada especial
                if (this.classList.contains('active')) return;
                
                // Prevenir navegación inmediata
                e.preventDefault();
                
                // Mostrar transición
                showPageTransition();
                
                // Navegar después de un pequeño delay para ver la animación
                setTimeout(() => {
                    window.location.href = href;
                }, 300);
            });
        });

        // Fechas
        initDates();

        // Datos principales
        loadDashboardData();
        
        // Usuarios en tiempo real
        loadRealtimeUsers();

        // Alertas (solo si estamos en la página)
        if (window.activePage === 'alerts') {
            setTimeout(async () => {
                await loadAlerts();
            }, 500);
        }
    });


    // Quick filter toggle
    document.getElementById('quickFilter').addEventListener('change', function() {
        const customDates = document.getElementById('customDates');
        customDates.style.display = this.value === 'custom' ? 'block' : 'none';
    });
    
    // Initialize dates
    function initDates() {
        const today = new Date();
        const startDate = new Date(today);
        startDate.setDate(startDate.getDate() - 7);
        
        document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
        document.getElementById('endDate').value = today.toISOString().split('T')[0];
    }
    
    // Load data on page load
    window.addEventListener('DOMContentLoaded', () => {
        console.log('[INIT] DOMContentLoaded, activePage:', window.activePage);
        initDates();
        loadFilterOptions(); // Cargar opciones de filtros (páginas, países)
        loadDashboardData();
        
        // IMPORTANTE: Añadir event listener al botón de filtros
        const filterBtn = document.getElementById('applyFiltersBtn');
        if (filterBtn) {
            console.log('[INIT] Botón de filtros encontrado, añadiendo listener...');
            filterBtn.addEventListener('click', async function(e) {
                e.preventDefault();
                console.log('[CLICK] Botón de filtros pulsado!');
                await window.applyFilters();
            });
        } else {
            console.error('[INIT] ERROR: No se encontró el botón de filtros!');
        }
        
        // Si estamos en la página de alertas, cargar alertas después de un pequeño delay
        if (window.activePage === 'alerts') {
            setTimeout(async () => {
                console.log('[INIT] Cargando alertas directamente...');
                await loadAlerts();
            }, 500);
        }
        
        // Si estamos en la página de Diana, cargar datos de Diana
        if (window.activePage === 'diana') {
            setTimeout(async () => {
                console.log('[INIT] Cargando datos de Diana...');
                await loadDianaData();
            }, 500);
        }
        
        if (window.activePage === 'apollo') {
            setTimeout(async () => {
                console.log('[INIT] Cargando datos de Apollo...');
                await loadApolloData();
            }, 500);
        }

        if (window.activePage === 'leads') {
            setTimeout(async () => {
                console.log('[INIT] Cargando datos de Leads...');
                await loadLeadsData();
            }, 500);
        }
        
        if (window.activePage === 'team') {
            setTimeout(async () => {
                console.log('[INIT] Cargando datos de Team...');
                await loadTeamData();
            }, 500);
        }
    });
    
    // Apply filters (recalcula KPIs y datos de la página actual)
    // IMPORTANTE: Esta función se llama desde onclick, debe estar en window
    window.applyFilters = async function() {
        console.log('[FILTERS] === APLICANDO FILTROS ===');
        console.log('[FILTERS] Página actual:', window.activePage);
        
        // Mostrar indicador visual en el botón
        const btn = document.getElementById('applyFiltersBtn');
        if (!btn) return;
        
        btn.textContent = 'Calculando...';
        btn.disabled = true;
        
        try {
            // Obtener todos los filtros
            const filters = getAllFilters();
            console.log('[FILTERS] Filtros aplicados:', filters);
            
            // Guardar filtros en variable global para uso en otras funciones
            window.currentFilters = filters;
            
            // Recargar datos según la página actual
            const page = window.activePage;
            
            if (page === 'general_overview') {
                console.log('[FILTERS] Recargando general_overview...');
                await loadKPIs(filters.startDate, filters.endDate);
                await loadQualityKPIs(filters.startDate, filters.endDate);
                await loadGeoData(filters.startDate, filters.endDate);
                
                // Si el tab activo es fuentes-trafico o pagina-contenido, recargar esos datos también
                const activeTab = document.querySelector('.tab-btn.active');
                if (activeTab && activeTab.dataset.tab === 'fuentes-trafico') {
                    console.log('[FILTERS] Recargando fuentes de tráfico...');
                    await loadTrafficSourcesData();
                    // Si el sub-tab SEO está activo, recargar datos orgánicos
                    const seoSubtab = document.querySelector('.traffic-subtab-btn[data-traffic-subtab="seo"]');
                    if (seoSubtab && seoSubtab.classList.contains('active')) {
                        loadOrganicData();
                    }
                } else if (activeTab && activeTab.dataset.tab === 'pagina-contenido') {
                    console.log('[FILTERS] Recargando contenido...');
                    await loadContentRanking();
                }
            } 
            else if (page === 'realtime') {
                console.log('[FILTERS] Recargando realtime...');
                await loadRealtimeDetails();
            }
            else {
                // Otras páginas: solo KPIs generales
                console.log('[FILTERS] Recargando KPIs para:', page);
                await loadKPIs(filters.startDate, filters.endDate);
            }
            
            // Recargar alertas siempre (para el asistente)
            await loadAlerts();
            
            console.log('[FILTERS] === FILTROS APLICADOS ===');
            
        } catch (error) {
            console.error('[FILTERS] Error:', error);
        } finally {
            btn.textContent = 'Aplicar Filtros';
            btn.disabled = false;
        }
    }
    
    // Get selected date range
    function getDateRange() {
        const quickFilter = document.getElementById('quickFilter').value;
        const today = new Date();
        let startDate, endDate;
        
        if (quickFilter === 'custom') {
            startDate = document.getElementById('startDate').value;
            endDate = document.getElementById('endDate').value;
        } else {
            const days = parseInt(quickFilter);
            endDate = today.toISOString().split('T')[0];
            const start = new Date(today);
            start.setDate(start.getDate() - days);
            startDate = start.toISOString().split('T')[0];
        }
        
        return { startDate, endDate };
    }
    
    // Get all filters including page, country, and traffic source
    function getAllFilters() {
        const { startDate, endDate } = getDateRange();
        const pageFilter = document.getElementById('pageFilter')?.value || 'all';
        const countryFilter = document.getElementById('countryFilter')?.value || 'all';
        const trafficSourceFilter = document.getElementById('trafficSourceFilter')?.value || 'all';
        
        return {
            startDate,
            endDate,
            page: pageFilter === 'all' ? null : pageFilter,
            country: countryFilter === 'all' ? null : countryFilter,
            trafficSource: trafficSourceFilter === 'all' ? null : trafficSourceFilter
        };
    }
    
    // Load filter options for pages and countries
    async function loadFilterOptions() {
        console.log('[FILTERS] Cargando opciones de filtros...');
        
        try {
            const response = await fetch('/api/get-filter-options');
            const result = await response.json();
            
            if (result.success) {
                // Populate page filter
                const pageSelect = document.getElementById('pageFilter');
                if (pageSelect && result.pages) {
                    pageSelect.innerHTML = '<option value="all">Todas las páginas</option>';
                    result.pages.forEach(page => {
                        const option = document.createElement('option');
                        option.value = page;
                        // Mostrar solo la parte final de la URL si es muy larga
                        const displayName = page.length > 40 ? '...' + page.slice(-37) : page;
                        option.textContent = displayName;
                        option.title = page; // Tooltip con URL completa
                        pageSelect.appendChild(option);
                    });
                    console.log('[FILTERS] ✓ Páginas cargadas:', result.pages.length);
                }
                
                // Populate country filter
                const countrySelect = document.getElementById('countryFilter');
                if (countrySelect && result.countries) {
                    countrySelect.innerHTML = '<option value="all">Todos los países</option>';
                    result.countries.forEach(country => {
                        const option = document.createElement('option');
                        option.value = country;
                        option.textContent = country;
                        countrySelect.appendChild(option);
                    });
                    console.log('[FILTERS] ✓ Países cargados:', result.countries.length);
                }
            }
        } catch (error) {
            console.error('[FILTERS] Error cargando opciones:', error);
        }
    }
    
    // Clear all filters
    function clearFilters() {
        document.getElementById('quickFilter').value = '7';
        document.getElementById('pageFilter').value = 'all';
        document.getElementById('countryFilter').value = 'all';
        document.getElementById('trafficSourceFilter').value = 'all';
        
        // Hide custom dates
        document.getElementById('customDates').style.display = 'none';
        
        console.log('[FILTERS] Filtros limpiados');
    }
    
    // Setup clear filters button
    document.getElementById('clearFiltersBtn')?.addEventListener('click', () => {
        clearFilters();
        // Optionally auto-apply after clearing
        window.applyFilters();
    });
    
    // Verificar si los datos están cargados
    async function checkDataLoaded() {
        try {
            const response = await fetch('/api/check-data');
            const result = await response.json();
            return result.loaded;
        } catch (error) {
            console.error('Error checking data:', error);
            return false;
        }
    }
    
    // Load dashboard data (solo carga KPIs, NO recarga datos de GA)
    async function loadDashboardData() {
        console.log('[LOAD] Iniciando loadDashboardData, activePage:', window.activePage);

        // Pages that don't need GA4 data skip the check entirely
        const independentPages = ['apollo', 'diana', 'leads', 'team'];
        if (independentPages.includes(window.activePage)) {
            console.log('[LOAD] Página independiente de GA4, skip check');
            return;
        }

        showLoading(true);

        try {
            // Verificar si los datos ya están cargados
            const dataLoaded = await checkDataLoaded();
            console.log('[LOAD] Datos cargados:', dataLoaded);

            if (!dataLoaded) {
                // Los datos se cargan automáticamente en el servidor al arrancar.
                // Reintentar cada 10 segundos hasta que estén listos.
                console.log('[LOAD] Datos no disponibles aún, esperando carga automática...');
                showLoadingMessage('Los datos de GA4 se están cargando automáticamente. Esto puede tardar 1-2 minutos...');
                retryCheckData();
                return;
            }

            // Los datos ya están cargados, solo calcular KPIs con el filtro actual
            const { startDate, endDate } = getDateRange();
            await loadKPIs(startDate, endDate);

        } catch (error) {
            console.error('Error:', error);
        } finally {
            showLoading(false);
        }
    }

    function showLoadingMessage(msg) {
        const overlay = document.getElementById('loadingOverlay');
        if (!overlay) return;
        overlay.innerHTML = `
            <div style="text-align: center; max-width: 500px; padding: 2rem;">
                <p style="font-family: 'Outfit', sans-serif; color: rgba(255,255,255,0.7); font-size: 0.95rem; margin-bottom: 1.5rem;">${msg}</p>
                <div style="width: 100%; height: 6px; background: rgba(108,168,164,0.15); border-radius: 3px; overflow: hidden;">
                    <div id="ga4ProgressBar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #1D4744, #6CA8A4); border-radius: 3px; transition: width 0.5s ease;"></div>
                </div>
                <p id="ga4ProgressText" style="font-family: 'Outfit', sans-serif; color: rgba(255,255,255,0.4); font-size: 0.8rem; margin-top: 0.75rem;">0%</p>
            </div>
        `;
        overlay.classList.add('active');
    }

    function retryCheckData() {
        let attempts = 0;
        const maxAttempts = 30; // 5 minutos (30 x 10s)
        const interval = setInterval(async () => {
            attempts++;
            const pct = Math.min(Math.round((attempts / maxAttempts) * 100), 99);
            const bar = document.getElementById('ga4ProgressBar');
            const txt = document.getElementById('ga4ProgressText');
            if (bar) bar.style.width = pct + '%';
            if (txt) txt.textContent = pct + '%';
            console.log('[LOAD] Reintento ' + attempts + '/' + maxAttempts + '...');
            try {
                const loaded = await checkDataLoaded();
                if (loaded) {
                    clearInterval(interval);
                    if (bar) bar.style.width = '100%';
                    if (txt) txt.textContent = '100%';
                    setTimeout(() => {
                        const overlay = document.getElementById('loadingOverlay');
                        if (overlay) overlay.classList.remove('active');
                    }, 500);
                    const { startDate, endDate } = getDateRange();
                    await loadKPIs(startDate, endDate);
                    showLoading(false);
                } else if (attempts >= maxAttempts) {
                    clearInterval(interval);
                    showLoadingMessage('Los datos aún no están listos. Recargá la página en unos minutos.');
                }
            } catch (e) {
                console.error('[LOAD] Error en reintento:', e);
            }
        }, 10000);
    }
    
    // Load KPIs
    async function loadKPIs(startDate, endDate) {
        try {
            // Obtener filtros adicionales si están definidos
            const filters = window.currentFilters || {};
            
            const response = await fetch('/api/get-kpis', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    fecha_inicio: startDate, 
                    fecha_fin: endDate,
                    page: filters.page || null,
                    country: filters.country || null,
                    traffic_source: filters.trafficSource || null
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                const kpis = result.kpis;
                
                // Update KPI values
                document.getElementById('kpi-sessions').textContent = formatNumber(kpis.sessions);
                document.getElementById('kpi-users').textContent = formatNumber(kpis.users);
                
                // Update deltas
                updateDelta('kpi-sessions-delta', kpis.sessions_delta);
                updateDelta('kpi-users-delta', kpis.users_delta);
                
                // Update growth with conditional colors
                updateGrowth('kpi-wow', 'WoW', kpis.wow);
                updateGrowth('kpi-mom', 'MoM', kpis.mom);
                
                // Update insight
                updateInsight(kpis);
            }
        } catch (error) {
            console.error('Error loading KPIs:', error);
        }
    }
    
    // Update delta element
    function updateDelta(elementId, value) {
        const element = document.getElementById(elementId);
        const isPositive = value >= 0;
        
        element.className = `kpi-delta ${isPositive ? 'positive' : 'negative'}`;
        element.textContent = `${isPositive ? '↑' : '↓'} ${Math.abs(value)}%`;
    }
    
    // Update growth with conditional colors
    function updateGrowth(elementId, label, value) {
        const element = document.getElementById(elementId);
        const isPositive = value >= 0;
        
        element.className = `kpi-growth-value ${isPositive ? 'positive' : 'negative'}`;
        element.textContent = `${label}: ${isPositive ? '+' : ''}${value}%`;
    }
    
    // Update insight text
    function updateInsight(kpis) {
        const sessionsDown = kpis.sessions_delta < 0;
        const usersDown = kpis.users_delta < 0;
        const wowDown = kpis.wow < 0;
        const momDown = kpis.mom < 0;
        
        // Helper para colorear solo deltas
        const colorDelta = (value, isNegative) => {
            const cls = isNegative ? 'data-negative' : 'data-positive';
            return `<span class="${cls}">${value}%</span>`;
        };
        
        let insight = `Las ${formatNumber(kpis.sessions)} sesiones registradas representan una ${sessionsDown ? 'caída' : 'subida'} del ${colorDelta(Math.abs(kpis.sessions_delta), sessionsDown)}, `;
        insight += `mientras que los ${formatNumber(kpis.users)} usuarios de calidad (sin rebote) ${usersDown ? 'descienden' : 'aumentan'} un ${colorDelta(Math.abs(kpis.users_delta), usersDown)}. `;
        
        // Tendencia WoW y MoM
        if (wowDown && momDown) {
            insight += `La tendencia negativa se acentúa con un ${colorDelta(kpis.wow, true)} WoW y ${colorDelta(kpis.mom, true)} MoM, lo que indica una reducción sostenida del volumen de entrada. `;
            insight += `Este patrón sugiere revisar las fuentes que normalmente aportan mayor tráfico (orgánico, campañas y referencias) para identificar dónde se está produciendo la pérdida.`;
        } else if (!wowDown && !momDown) {
            insight += `La tendencia positiva se confirma con un ${colorDelta('+' + kpis.wow, false)} WoW y ${colorDelta('+' + kpis.mom, false)} MoM, lo que indica un crecimiento sostenido del volumen de entrada. `;
            insight += `Este patrón sugiere que las estrategias actuales están funcionando bien. Considera analizar qué fuentes están impulsando este crecimiento para potenciarlas aún más.`;
        } else if (wowDown && !momDown) {
            insight += `La semana muestra una caída de ${colorDelta(kpis.wow, true)} WoW, aunque el mes mantiene un crecimiento de ${colorDelta('+' + kpis.mom, false)} MoM. `;
            insight += `Esta variación a corto plazo podría ser estacional o puntual. Se recomienda monitorear los próximos días para confirmar si es una tendencia o una fluctuación temporal.`;
        } else {
            insight += `La semana muestra un crecimiento de ${colorDelta('+' + kpis.wow, false)} WoW, aunque el mes registra una caída de ${colorDelta(kpis.mom, true)} MoM. `;
            insight += `Esta recuperación reciente es positiva, pero conviene analizar si se mantiene para revertir la tendencia mensual negativa.`;
        }
        
        document.getElementById('insight-text').innerHTML = insight;
    }
    
    // Utility functions
    function formatNumber(num) {
        if (num === undefined || num === null) return '--';
        return new Intl.NumberFormat('es-ES').format(num);
    }
    
    // Mostrar transición al navegar entre páginas
    function showPageTransition() {
        const progressBar = document.getElementById('pageProgress');
        const quickSpinner = document.getElementById('quickSpinner');
        const mainContent = document.querySelector('.main-content');
        
        // Activar progress bar
        progressBar.classList.add('active');
        progressBar.classList.remove('complete');
        
        // Fade del contenido
        if (mainContent) mainContent.classList.add('loading');
        
        // Mostrar spinner pequeño
        quickSpinner.classList.add('active');
    }

    function showLoading(show) {
        const progressBar = document.getElementById('pageProgress');
        const quickSpinner = document.getElementById('quickSpinner');
        const refreshIndicator = document.getElementById('refreshIndicator');
        const mainContent = document.querySelector('.main-content');
        
        // Detectar si es recarga
        const navEntry = performance.getEntriesByType('navigation')[0];
        const isReload = navEntry && navEntry.type === 'reload';
        
        if (show) {
            // Activar progress bar siempre
            progressBar.classList.add('active');
            progressBar.classList.remove('complete');
            
            // Fade del contenido
            if (mainContent) mainContent.classList.add('loading');
            
            // Mostrar spinner o refresh según el caso
            if (isReload) {
                refreshIndicator.classList.add('active');
            } else {
                quickSpinner.classList.add('active');
            }
        } else {
            // Completar progress bar con animación
            progressBar.classList.add('complete');
            progressBar.classList.remove('active');
            
            // Restaurar contenido con animación de entrada
            if (mainContent) {
                mainContent.classList.remove('loading');
                mainContent.classList.add('fade-in');
                // Limpiar clase después de la animación
                setTimeout(() => mainContent.classList.remove('fade-in'), 500);
            }
            
            // Ocultar spinners
            quickSpinner.classList.remove('active');
            refreshIndicator.classList.remove('active');
            
            // Reset progress bar después de la transición
            setTimeout(() => {
                progressBar.classList.remove('complete');
                progressBar.style.width = '0%';
            }, 500);
        }
    }
    
    // showNoDataMessage y loadDataFromGA4 eliminados.
    // Los datos se cargan automáticamente al arrancar el servidor y cada 15 min.
    
    // ===== GRÁFICO DE COMPARACIÓN =====
    let comparisonChartData = null;
    
    async function updateComparisonChart() {
        const metric = document.getElementById('metricSelector').value;
        const { startDate, endDate } = getDateRange();
        const filters = window.currentFilters || {};
        
        try {
            const response = await fetch('/api/get-comparison-data', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    fecha_inicio: startDate,
                    fecha_fin: endDate,
                    metric: metric,
                    page: filters.page || null,
                    country: filters.country || null,
                    traffic_source: filters.trafficSource || null
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                comparisonChartData = result;
                renderComparisonChart(result, metric);
                updateChartInsight(result, metric);
            }
        } catch (error) {
            console.error('Error loading comparison data:', error);
        }
    }
    
    function renderComparisonChart(data, metric) {
        const metricLabels = {
            'sessions': 'Sesiones Totales',
            'totalUsers': 'Usuarios Únicos',
            'screenPageViews': 'Páginas Vistas'
        };
        
        // Preparar datos - alinear por posición (día 1 vs día 1, día 2 vs día 2, etc.)
        const currentY = data.current.map(d => d.value);
        const currentLabels = data.current.map(d => d.date);
        
        const previousY = data.previous.map(d => d.value);
        const previousLabels = data.previous.map(d => d.date);
        
        // Crear etiquetas numéricas para alinear ambas series (Día 1, Día 2, etc.)
        const maxLen = Math.max(currentY.length, previousY.length);
        const xIndices = Array.from({length: maxLen}, (_, i) => `Día ${i + 1}`);
        
        // Traza período actual (con sombra debajo)
        const traceCurrent = {
            x: xIndices.slice(0, currentY.length),
            y: currentY,
            type: 'scatter',
            mode: 'lines+markers',
            name: data.current_label,
            line: {
                color: '#6CA8A4',
                width: 3,
                shape: 'spline'
            },
            marker: {
                color: '#6CA8A4',
                size: 8,
                line: {
                    color: '#fff',
                    width: 2
                }
            },
            fill: 'tozeroy',
            fillcolor: 'rgba(108, 168, 164, 0.15)',
            text: currentLabels,
            hovertemplate: '<b>%{text}</b><br>%{y:,.0f} ' + metricLabels[metric].toLowerCase() + '<extra></extra>'
        };
        
        // Traza período anterior - usar las mismas posiciones X para alinear
        const tracePrevious = {
            x: xIndices.slice(0, previousY.length),
            y: previousY,
            type: 'scatter',
            mode: 'lines+markers',
            name: data.previous_label,
            line: {
                color: '#FFB347',
                width: 2,
                dash: 'dot',
                shape: 'spline'
            },
            marker: {
                color: '#FFB347',
                size: 6,
                line: {
                    color: '#fff',
                    width: 1
                }
            },
            text: previousLabels,
            hovertemplate: '<b>%{text}</b><br>%{y:,.0f} ' + metricLabels[metric].toLowerCase() + '<extra></extra>'
        };
        
        const layout = {
            title: {
                text: `${metricLabels[metric]} - Comparación de Períodos`,
                font: {
                    family: 'Montserrat, sans-serif',
                    size: 14,
                    color: '#fff'
                },
                y: 0.98,
                yanchor: 'top'
            },
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            font: {
                family: 'Outfit, sans-serif',
                color: 'rgba(255,255,255,0.7)'
            },
            xaxis: {
                title: '',
                gridcolor: 'rgba(108, 168, 164, 0.1)',
                linecolor: 'rgba(108, 168, 164, 0.3)',
                tickfont: { size: 10 },
                automargin: true,
                tickangle: 0,
                showgrid: false
            },
            yaxis: {
                title: metricLabels[metric],
                gridcolor: 'rgba(108, 168, 164, 0.1)',
                linecolor: 'rgba(108, 168, 164, 0.3)',
                tickfont: { size: 11 },
                rangemode: 'tozero'
            },
            legend: {
                orientation: 'h',
                y: 1.12,
                x: 0.5,
                xanchor: 'center',
                font: { size: 11 },
                bgcolor: 'rgba(0,0,0,0)'
            },
            margin: { t: 80, r: 30, b: 40, l: 60 },
            hovermode: 'closest',
            hoverlabel: {
                bgcolor: 'rgba(29, 71, 68, 0.95)',
                bordercolor: '#6CA8A4',
                font: {
                    family: 'Montserrat, sans-serif',
                    size: 12,
                    color: '#fff'
                },
                namelength: -1
            }
        };
        
        const config = {
            responsive: true,
            displayModeBar: false
        };
        
        Plotly.newPlot('comparisonChart', [traceCurrent, tracePrevious], layout, config);
    }
    
    function updateChartInsight(data, metric) {
        const metricLabels = {
            'sessions': 'tráfico',
            'totalUsers': 'usuarios',
            'screenPageViews': 'páginas vistas'
        };
        
        const isDown = data.change_pct < 0;
        const trend = data.trend;
        
        let insight = '';
        
        if (isDown) {
            insight = `El ${metricLabels[metric]} actual pierde fuerza a mitad de período y no llega a recuperar los niveles del ciclo anterior, señalando una menor tracción en los últimos días.`;
            if (trend === 'decreciente') {
                insight += ` La tendencia decreciente sugiere revisar las fuentes de adquisición principales.`;
            }
        } else {
            insight = `El ${metricLabels[metric]} actual muestra un comportamiento ${trend}, superando al período anterior en un ${Math.abs(data.change_pct)}%. `;
            insight += `Este patrón positivo indica que las estrategias actuales están generando resultados.`;
        }
        
        document.getElementById('chart-insight-text').textContent = insight;
    }
    
    // ===== GRÁFICO USUARIOS NUEVOS VS RECURRENTES =====
    async function updateUsersTypeChart() {
        const { startDate, endDate } = getDateRange();
        const filters = window.currentFilters || {};
        
        try {
            const response = await fetch('/api/get-users-type-data', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    fecha_inicio: startDate,
                    fecha_fin: endDate,
                    page: filters.page || null,
                    country: filters.country || null,
                    traffic_source: filters.trafficSource || null
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                renderUsersTypeChart(result);
                updateUsersTypeInsight(result);
            }
        } catch (error) {
            console.error('Error loading users type data:', error);
        }
    }
    
    function renderUsersTypeChart(data) {
        const xLabels = data.new_users.map(d => d.date);
        const newUsersY = data.new_users.map(d => d.value);
        const returningUsersY = data.returning_users.map(d => d.value);
        
        // Traza usuarios nuevos
        const traceNew = {
            x: xLabels,
            y: newUsersY,
            type: 'scatter',
            mode: 'lines+markers',
            name: 'Nuevos',
            line: {
                color: '#6CA8A4',
                width: 3,
                shape: 'linear'
            },
            marker: {
                color: '#6CA8A4',
                size: 8,
                line: { color: '#fff', width: 2 }
            },
            fill: 'tozeroy',
            fillcolor: 'rgba(108, 168, 164, 0.3)',
            hovertemplate: '<b>%{y:,.0f}</b><extra></extra>'
        };
        
        // Traza usuarios recurrentes
        const traceReturning = {
            x: xLabels,
            y: returningUsersY,
            type: 'scatter',
            mode: 'lines+markers',
            name: 'Recurrentes',
            line: {
                color: '#FFB347',
                width: 3,
                shape: 'linear'
            },
            marker: {
                color: '#FFB347',
                size: 8,
                line: { color: '#fff', width: 2 }
            },
            hovertemplate: '<b>%{y:,.0f}</b><extra></extra>'
        };
        
        const layout = {
            title: {
                text: 'Usuarios Nuevos vs. Recurrentes',
                font: {
                    family: 'Montserrat, sans-serif',
                    size: 14,
                    color: '#fff'
                },
                y: 0.98,
                yanchor: 'top'
            },
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            font: {
                family: 'Outfit, sans-serif',
                color: 'rgba(255,255,255,0.7)'
            },
            xaxis: {
                title: '',
                gridcolor: 'rgba(108, 168, 164, 0.1)',
                linecolor: 'rgba(108, 168, 164, 0.3)',
                tickfont: { size: 11 },
                automargin: true,
                tickangle: 0
            },
            yaxis: {
                title: 'Número de Usuarios',
                gridcolor: 'rgba(108, 168, 164, 0.1)',
                linecolor: 'rgba(108, 168, 164, 0.3)',
                tickfont: { size: 11 }
            },
            legend: {
                orientation: 'h',
                y: 1.15,
                x: 0.5,
                xanchor: 'center',
                font: { size: 11 }
            },
            margin: { t: 100, r: 50, b: 50, l: 70 },
            hovermode: 'x unified',
            hoverlabel: {
                bgcolor: 'rgba(29, 71, 68, 0.95)',
                bordercolor: '#6CA8A4',
                font: {
                    family: 'Montserrat, sans-serif',
                    size: 13,
                    color: '#fff'
                },
                namelength: -1
            }
        };
        
        const config = {
            responsive: true,
            displayModeBar: false
        };
        
        Plotly.newPlot('usersTypeChart', [traceNew, traceReturning], layout, config);
    }
    
    function updateUsersTypeInsight(data) {
        const totalNew = data.total_new;
        const totalReturning = data.total_returning;
        const total = totalNew + totalReturning;
        
        const pctNew = total > 0 ? ((totalNew / total) * 100).toFixed(1) : 0;
        const pctReturning = total > 0 ? ((totalReturning / total) * 100).toFixed(1) : 0;
        
        let insight = `De los ${formatNumber(total)} usuarios totales, ${formatNumber(totalNew)} son nuevos (${pctNew}%) y ${formatNumber(totalReturning)} son recurrentes (${pctReturning}%). `;
        
        if (pctNew > 70) {
            insight += `El alto porcentaje de usuarios nuevos indica buena capacidad de adquisición, pero sugiere revisar estrategias de retención para fidelizar a estos visitantes.`;
        } else if (pctReturning > 50) {
            insight += `La mayoría de usuarios son recurrentes, lo que refleja una buena retención. Considera ampliar canales de adquisición para atraer nuevos visitantes.`;
        } else {
            insight += `Existe un balance saludable entre adquisición y retención. Mantén las estrategias actuales y monitorea la evolución.`;
        }
        
        document.getElementById('users-type-insight-text').textContent = insight;
    }
    
    // ===== QUALITY KPIS =====
    async function loadQualityKPIs() {
        const { startDate, endDate } = getDateRange();
        const filters = window.currentFilters || {};
        
        try {
            const response = await fetch('/api/get-quality-kpis', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    fecha_inicio: startDate,
                    fecha_fin: endDate,
                    page: filters.page || null,
                    country: filters.country || null,
                    traffic_source: filters.trafficSource || null
                })
            });
            
            const result = await response.json();
            
            if (result.success && result.kpis) {
                const kpis = result.kpis;
                
                // Update KPI values
                document.getElementById('kpi-quality-rate').textContent = kpis.quality_rate + '%';
                document.getElementById('kpi-bounce-rate').textContent = kpis.bounce_rate + '%';
                document.getElementById('kpi-engaged-users').textContent = formatNumber(kpis.engaged_users);
                
                // Update deltas
                updateQualityDelta('kpi-quality-rate-delta', kpis.quality_rate_delta);
                updateQualityDelta('kpi-bounce-rate-delta', kpis.bounce_rate_delta, true); // inverted for bounce
                updateQualityDelta('kpi-engaged-users-delta', kpis.engaged_users_delta);
                
                // Update insight
                updateQualityInsight(kpis);
                
                // Render charts
                if (result.invalid_users_data && result.invalid_users_data.length > 0) {
                    renderInvalidUsersChart(result.invalid_users_data);
                }
                if (result.quality_rate_trend && result.quality_rate_trend.length > 0) {
                    renderQualityRateChart(result.quality_rate_trend);
                }
                if (result.valid_vs_invalid_data && result.valid_vs_invalid_data.length > 0) {
                    renderValidVsInvalidChart(result.valid_vs_invalid_data);
                }
            }
        } catch (error) {
            console.error('Error loading quality KPIs:', error);
        }
    }
    
    function updateQualityDelta(elementId, value, inverted = false) {
        const element = document.getElementById(elementId);
        if (!element) return;
        
        // For bounce rate, negative is good (inverted)
        const isPositive = inverted ? value <= 0 : value >= 0;
        
        element.className = `kpi-delta ${isPositive ? 'positive' : 'negative'}`;
        element.textContent = `${value >= 0 ? '+' : ''}${value}%`;
    }
    
    function updateQualityInsight(kpis) {
        const bounceHigh = kpis.bounce_rate > 60;
        const qualityLow = kpis.quality_rate < 50;
        
        let insight = '';
        
        if (bounceHigh && qualityLow) {
            insight = `El aumento del bounce rate (${kpis.bounce_rate}%) y los usuarios no válidos indica una caída en la calidad del tráfico. La Tasa de Calidad desciende, señalando que menos usuarios interactúan realmente con la web.`;
        } else if (bounceHigh) {
            insight = `El bounce rate de ${kpis.bounce_rate}% es elevado. Considera revisar las landing pages y la relevancia del contenido para reducir abandonos tempranos.`;
        } else if (qualityLow) {
            insight = `La tasa de calidad de ${kpis.quality_rate}% sugiere que muchos usuarios no interactúan significativamente. Revisa la segmentación de campañas y la experiencia de usuario.`;
        } else {
            insight = `La calidad del tráfico es buena con un ${kpis.quality_rate}% de usuarios de calidad y un bounce rate de ${kpis.bounce_rate}%. Los ${formatNumber(kpis.engaged_users)} usuarios engaged muestran una interacción saludable.`;
        }
        
        document.getElementById('quality-insight-text').textContent = insight;
    }
    
    // Gráfico 1: Distribución de Usuarios No Válidos (barras)
    function renderInvalidUsersChart(data) {
        const xLabels = data.map(d => d.date);
        const yValues = data.map(d => d.value);
        
        const trace = {
            x: xLabels,
            y: yValues,
            type: 'bar',
            name: 'Usuarios No Válidos',
            marker: {
                color: '#FF6B6B',
                line: { color: '#FF4444', width: 1 }
            },
            hovertemplate: '<b>%{y}</b> usuarios<extra></extra>'
        };
        
        const layout = {
            title: { text: 'Usuarios No Válidos por Día', font: { family: 'Montserrat', size: 14, color: '#fff' }, y: 0.98 },
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            font: { family: 'Outfit', color: 'rgba(255,255,255,0.7)' },
            xaxis: { title: '', gridcolor: 'rgba(108, 168, 164, 0.1)', linecolor: 'rgba(108, 168, 164, 0.3)', tickfont: { size: 11 } },
            yaxis: { title: 'Usuarios', gridcolor: 'rgba(108, 168, 164, 0.1)', linecolor: 'rgba(108, 168, 164, 0.3)', tickfont: { size: 11 } },
            margin: { t: 80, r: 30, b: 50, l: 60 },
            hovermode: 'x unified',
            hoverlabel: { bgcolor: 'rgba(29, 71, 68, 0.95)', bordercolor: '#FF6B6B', font: { family: 'Montserrat', size: 13, color: '#fff' } }
        };
        
        Plotly.newPlot('invalidUsersChart', [trace], layout, { responsive: true, displayModeBar: false });
    }
    
    // Gráfico 2: Tasa de Calidad (línea)
    function renderQualityRateChart(data) {
        const xLabels = data.map(d => d.date);
        const yValues = data.map(d => d.value);
        
        const trace = {
            x: xLabels,
            y: yValues,
            type: 'scatter',
            mode: 'lines+markers',
            name: 'Tasa de Calidad',
            line: { color: '#6CA8A4', width: 3, shape: 'linear' },
            marker: { color: '#6CA8A4', size: 8, line: { color: '#fff', width: 2 } },
            fill: 'tozeroy',
            fillcolor: 'rgba(108, 168, 164, 0.3)',
            hovertemplate: '<b>%{y}%</b><extra></extra>'
        };
        
        const layout = {
            title: { text: 'Evolución de la Tasa de Calidad (%)', font: { family: 'Montserrat', size: 14, color: '#fff' }, y: 0.98 },
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            font: { family: 'Outfit', color: 'rgba(255,255,255,0.7)' },
            xaxis: { title: '', gridcolor: 'rgba(108, 168, 164, 0.1)', linecolor: 'rgba(108, 168, 164, 0.3)', tickfont: { size: 11 } },
            yaxis: { title: 'Tasa de Calidad (%)', gridcolor: 'rgba(108, 168, 164, 0.1)', linecolor: 'rgba(108, 168, 164, 0.3)', tickfont: { size: 11 }, range: [0, 100] },
            margin: { t: 80, r: 30, b: 50, l: 60 },
            hovermode: 'x unified',
            hoverlabel: { bgcolor: 'rgba(29, 71, 68, 0.95)', bordercolor: '#6CA8A4', font: { family: 'Montserrat', size: 13, color: '#fff' } }
        };
        
        Plotly.newPlot('qualityRateChart', [trace], layout, { responsive: true, displayModeBar: false });
    }
    
    // Gráfico 3: Usuarios Válidos vs No Válidos (barras apiladas)
    function renderValidVsInvalidChart(data) {
        const xLabels = data.map(d => d.date);
        const validUsers = data.map(d => d.valid);
        const invalidUsers = data.map(d => d.invalid);
        
        const traceValid = {
            x: xLabels,
            y: validUsers,
            type: 'bar',
            name: 'Válidos',
            marker: { color: '#6CA8A4' },
            hovertemplate: '<b>%{y}</b> válidos<extra></extra>'
        };
        
        const traceInvalid = {
            x: xLabels,
            y: invalidUsers,
            type: 'bar',
            name: 'No Válidos',
            marker: { color: '#FF6B6B' },
            hovertemplate: '<b>%{y}</b> no válidos<extra></extra>'
        };
        
        const layout = {
            title: { text: 'Usuarios Válidos vs. No Válidos', font: { family: 'Montserrat', size: 14, color: '#fff' }, y: 0.98 },
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            font: { family: 'Outfit', color: 'rgba(255,255,255,0.7)' },
            xaxis: { title: '', gridcolor: 'rgba(108, 168, 164, 0.1)', linecolor: 'rgba(108, 168, 164, 0.3)', tickfont: { size: 11 } },
            yaxis: { title: 'Usuarios', gridcolor: 'rgba(108, 168, 164, 0.1)', linecolor: 'rgba(108, 168, 164, 0.3)', tickfont: { size: 11 } },
            barmode: 'stack',
            legend: { orientation: 'h', y: 1.12, x: 0.5, xanchor: 'center', font: { size: 11 } },
            margin: { t: 100, r: 30, b: 50, l: 60 },
            hovermode: 'x unified',
            hoverlabel: { bgcolor: 'rgba(29, 71, 68, 0.95)', bordercolor: '#6CA8A4', font: { family: 'Montserrat', size: 13, color: '#fff' } }
        };
        
        Plotly.newPlot('validVsInvalidChart', [traceValid, traceInvalid], layout, { responsive: true, displayModeBar: false });
    }
    
    // ===== GEOGRAPHY DATA =====
    async function loadGeoData() {
        const { startDate, endDate } = getDateRange();
        const filters = window.currentFilters || {};
        
        try {
            const response = await fetch('/api/get-geo-data', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    fecha_inicio: startDate,
                    fecha_fin: endDate,
                    page: filters.page || null,
                    traffic_source: filters.trafficSource || null
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                // Renderizar listas de países
                if (result.countries) {
                    renderGeoList('geo-users-list', result.countries.by_users);
                    renderGeoList('geo-sessions-list', result.countries.by_sessions);
                    renderGeoList('geo-engagement-list', result.countries.by_engagement, '%');
                }
                
                // Renderizar listas de ciudades
                if (result.cities) {
                    renderGeoList('city-users-list', result.cities.by_users);
                    renderGeoList('city-sessions-list', result.cities.by_sessions);
                    renderGeoList('city-engagement-list', result.cities.by_engagement, '%');
                }
                
                // Renderizar mapa choropleth de países
                if (result.all_countries && result.all_countries.length > 0) {
                    renderCountryMap(result.all_countries);
                    renderCountryBarChart(result.all_countries);
                }
                
                // Renderizar gráficos de ciudades
                if (result.all_cities && result.all_cities.length > 0) {
                    renderCityBubbleChart(result.all_cities);
                    renderCityBarChart(result.all_cities);
                }
                
                // Actualizar insights de países
                if (result.insight) {
                    const geoInsight = document.getElementById('geo-insight-text');
                    const mapInsight = document.getElementById('geo-map-insight-text');
                    const barInsight = document.getElementById('geo-bar-insight-text');
                    if (geoInsight) geoInsight.textContent = result.insight;
                    if (mapInsight) mapInsight.textContent = result.insight;
                    if (barInsight) barInsight.textContent = result.insight;
                }
                
                // Insight ciudades
                if (result.cities && result.cities.by_users && result.cities.by_users.length > 0) {
                    const topCities = result.cities.by_users.slice(0, 2).map(c => c.name);
                    const totalUsers = result.cities.by_users.reduce((sum, c) => sum + c.value, 0);
                    const topSum = result.cities.by_users.slice(0, 2).reduce((sum, c) => sum + c.value, 0);
                    const pct = totalUsers > 0 ? Math.round(topSum / totalUsers * 100) : 0;
                    const cityInsightText = `${topCities.join(' y ')} son los principales núcleos urbanos, concentrando el ${pct}% del tráfico a nivel ciudad.`;
                    
                    const cityInsight = document.getElementById('city-insight-text');
                    const bubbleInsight = document.getElementById('city-bubble-insight-text');
                    const cityBarInsight = document.getElementById('city-bar-insight-text');
                    if (cityInsight) cityInsight.textContent = cityInsightText;
                    if (bubbleInsight) bubbleInsight.textContent = cityInsightText;
                    if (cityBarInsight) cityBarInsight.textContent = cityInsightText;
                }
            }
        } catch (error) {
            console.error('Error loading geo data:', error);
        }
    }
    
    // Mapa Choropleth de Países
    function renderCountryMap(data) {
        const countries = data.map(d => d.iso).filter(iso => iso);
        const sessions = data.filter(d => d.iso).map(d => d.sessions);
        const names = data.filter(d => d.iso).map(d => d.name);
        const engagements = data.filter(d => d.iso).map(d => d.engagement);
        
        const trace = {
            type: 'choropleth',
            locationmode: 'ISO-3',
            locations: countries,
            z: sessions,
            text: names.map((n, i) => `${n}<br>Sesiones: ${formatNumber(sessions[i])}<br>Engagement: ${engagements[i]}%`),
            hoverinfo: 'text',
            colorscale: [
                [0, 'rgba(108, 168, 164, 0.1)'],
                [0.25, 'rgba(108, 168, 164, 0.3)'],
                [0.5, 'rgba(108, 168, 164, 0.5)'],
                [0.75, 'rgba(108, 168, 164, 0.7)'],
                [1, 'rgba(108, 168, 164, 1)']
            ],
            colorbar: {
                title: 'Sesiones',
                titlefont: { color: '#fff', family: 'Montserrat' },
                tickfont: { color: 'rgba(255,255,255,0.7)' }
            },
            marker: {
                line: { color: 'rgba(255,255,255,0.3)', width: 0.5 }
            }
        };
        
        const layout = {
            title: { text: 'Distribución Global de Tráfico', font: { family: 'Montserrat', size: 16, color: '#fff' } },
            geo: {
                showframe: false,
                showcoastlines: true,
                coastlinecolor: 'rgba(108, 168, 164, 0.3)',
                projection: { type: 'natural earth' },
                bgcolor: 'rgba(0,0,0,0)',
                landcolor: 'rgba(30, 30, 30, 0.8)',
                showland: true,
                showcountries: true,
                countrycolor: 'rgba(108, 168, 164, 0.2)'
            },
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            margin: { t: 50, r: 0, b: 0, l: 0 },
            hoverlabel: { bgcolor: 'rgba(29, 71, 68, 0.95)', bordercolor: '#6CA8A4', font: { family: 'Montserrat', color: '#fff' } }
        };
        
        Plotly.newPlot('geoMapChart', [trace], layout, { responsive: true, displayModeBar: false });
    }
    
    // Gráfico de barras horizontales de países
    function renderCountryBarChart(data) {
        const sorted = [...data].sort((a, b) => b.sessions - a.sessions).slice(0, 10);
        
        const trace = {
            type: 'bar',
            orientation: 'h',
            y: sorted.map(d => d.name).reverse(),
            x: sorted.map(d => d.sessions).reverse(),
            text: sorted.map(d => `${formatNumber(d.sessions)} | ${d.engagement}%`).reverse(),
            textposition: 'outside',
            textfont: { color: '#fff', size: 11 },
            marker: {
                color: sorted.map(d => d.engagement).reverse(),
                colorscale: [[0, '#FF6B6B'], [0.5, '#FFB347'], [1, '#6CA8A4']],
                line: { color: 'rgba(255,255,255,0.2)', width: 1 }
            },
            hovertemplate: '<b>%{y}</b><br>Sesiones: %{x:,.0f}<extra></extra>'
        };
        
        const layout = {
            title: { text: 'Top 10 Países por Sesiones Engaged', font: { family: 'Montserrat', size: 14, color: '#fff' } },
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            font: { family: 'Outfit', color: 'rgba(255,255,255,0.7)' },
            xaxis: { title: '', gridcolor: 'rgba(108, 168, 164, 0.1)', showgrid: true, zeroline: false },
            yaxis: { title: '', gridcolor: 'rgba(108, 168, 164, 0.1)', automargin: true },
            margin: { t: 50, r: 100, b: 40, l: 120 },
            hoverlabel: { bgcolor: 'rgba(29, 71, 68, 0.95)', bordercolor: '#6CA8A4', font: { family: 'Montserrat', color: '#fff' } }
        };
        
        Plotly.newPlot('geoBarChart', [trace], layout, { responsive: true, displayModeBar: false });
    }
    
    // Bubble chart de ciudades
    function renderCityBubbleChart(data) {
        const maxSessions = Math.max(...data.map(d => d.sessions));
        
        const trace = {
            type: 'scatter',
            mode: 'markers+text',
            x: data.map((d, i) => i),
            y: data.map(d => d.sessions),
            text: data.map(d => d.name),
            textposition: 'top center',
            textfont: { size: 10, color: 'rgba(255,255,255,0.8)' },
            marker: {
                size: data.map(d => Math.max(15, (d.sessions / maxSessions) * 60)),
                color: data.map(d => d.engagement),
                colorscale: [[0, '#FF6B6B'], [0.5, '#FFB347'], [1, '#6CA8A4']],
                showscale: true,
                colorbar: {
                    title: 'Engagement %',
                    titlefont: { color: '#fff', family: 'Montserrat', size: 11 },
                    tickfont: { color: 'rgba(255,255,255,0.7)', size: 10 }
                },
                line: { color: 'rgba(255,255,255,0.3)', width: 1 }
            },
            hovertemplate: '<b>%{text}</b><br>Sesiones: %{y:,.0f}<br>Engagement: %{marker.color:.1f}%<extra></extra>'
        };
        
        const layout = {
            title: { text: 'Ciudades por Sesiones y Engagement', font: { family: 'Montserrat', size: 14, color: '#fff' } },
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            font: { family: 'Outfit', color: 'rgba(255,255,255,0.7)' },
            xaxis: { title: '', showgrid: false, showticklabels: false, zeroline: false },
            yaxis: { title: 'Sesiones Engaged', gridcolor: 'rgba(108, 168, 164, 0.1)' },
            margin: { t: 50, r: 80, b: 40, l: 70 },
            hoverlabel: { bgcolor: 'rgba(29, 71, 68, 0.95)', bordercolor: '#6CA8A4', font: { family: 'Montserrat', color: '#fff' } },
            showlegend: false
        };
        
        Plotly.newPlot('cityBubbleChart', [trace], layout, { responsive: true, displayModeBar: false });
    }
    
    // Gráfico de barras de ciudades
    function renderCityBarChart(data) {
        const sorted = [...data].sort((a, b) => b.sessions - a.sessions).slice(0, 10);
        
        const trace = {
            type: 'bar',
            orientation: 'h',
            y: sorted.map(d => d.name).reverse(),
            x: sorted.map(d => d.sessions).reverse(),
            text: sorted.map(d => `${formatNumber(d.sessions)} | ${d.engagement}%`).reverse(),
            textposition: 'outside',
            textfont: { color: '#fff', size: 11 },
            marker: {
                color: sorted.map(d => d.engagement).reverse(),
                colorscale: [[0, '#FF6B6B'], [0.5, '#FFB347'], [1, '#6CA8A4']],
                line: { color: 'rgba(255,255,255,0.2)', width: 1 }
            },
            hovertemplate: '<b>%{y}</b><br>Sesiones: %{x:,.0f}<extra></extra>'
        };
        
        const layout = {
            title: { text: 'Top 10 Ciudades por Sesiones Engaged', font: { family: 'Montserrat', size: 14, color: '#fff' } },
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            font: { family: 'Outfit', color: 'rgba(255,255,255,0.7)' },
            xaxis: { title: '', gridcolor: 'rgba(108, 168, 164, 0.1)', showgrid: true, zeroline: false },
            yaxis: { title: '', gridcolor: 'rgba(108, 168, 164, 0.1)', automargin: true },
            margin: { t: 50, r: 100, b: 40, l: 120 },
            hoverlabel: { bgcolor: 'rgba(29, 71, 68, 0.95)', bordercolor: '#6CA8A4', font: { family: 'Montserrat', color: '#fff' } }
        };
        
        Plotly.newPlot('cityBarChart', [trace], layout, { responsive: true, displayModeBar: false });
    }
    
    function renderGeoList(containerId, data, suffix = '') {
        const container = document.getElementById(containerId);
        if (!container) return;
        
        if (!data || data.length === 0) {
            container.innerHTML = '<p class="loading-text">Sin datos disponibles</p>';
            return;
        }
        
        let html = '';
        data.forEach(item => {
            html += `
                <div class="geo-item">
                    <div class="geo-item-bar" style="width: ${item.percentage}%"></div>
                    <span class="geo-item-rank">${item.rank}</span>
                    <span class="geo-item-name">${item.name}</span>
                    <span class="geo-item-value">${formatNumber(item.value)}${suffix}</span>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }

    // ===== ALERTS DATA =====
    async function loadAlerts() {
        console.log('[ALERTS] Cargando alertas...');
        const { startDate, endDate } = getDateRange();
        const filters = window.currentFilters || {};
        console.log('[ALERTS] Fechas:', startDate, endDate, 'Filtros:', filters);
        
        try {
            const response = await fetch('/api/get-alerts', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    fecha_inicio: startDate,
                    fecha_fin: endDate,
                    page: filters.page || null,
                    country: filters.country || null,
                    traffic_source: filters.trafficSource || null
                })
            });
            
            const result = await response.json();
            console.log('[ALERTS] Respuesta:', result);
            
            if (result.success) {
                // Actualizar conteo global y sidebar (siempre, desde cualquier página)
                const totalAlerts = result.summary.total || 0;
                const criticalAlerts = result.summary.critical || 0;
                window.totalAlerts = totalAlerts;
                updateAlertsNav(totalAlerts);
                
                // 🤖 ACTUALIZAR ASISTENTE
                updateAssistant(totalAlerts, criticalAlerts);
                
                // Solo actualizar la página completa si estamos en la página de alertas
                if (window.activePage !== 'alerts') {
                    console.log('[ALERTS] Conteo actualizado en sidebar:', totalAlerts);
                    return;
                }
                
                // Actualizar resumen
                const totalEl = document.getElementById('total-alerts');
                const criticalEl = document.getElementById('critical-alerts');
                const moderateEl = document.getElementById('moderate-alerts');
                const infoEl = document.getElementById('info-alerts');
                
                if (totalEl) totalEl.textContent = result.summary.total;
                if (criticalEl) criticalEl.textContent = result.summary.critical;
                if (moderateEl) moderateEl.textContent = result.summary.moderate;
                if (infoEl) infoEl.textContent = result.summary.info;
                
                // Porcentajes
                const total = result.summary.total || 1;
                const critPctEl = document.getElementById('critical-pct');
                const modPctEl = document.getElementById('moderate-pct');
                const infoPctEl = document.getElementById('info-pct');
                
                if (critPctEl) critPctEl.textContent = `${Math.round(result.summary.critical / total * 100)}% SOBRE TOTAL`;
                if (modPctEl) modPctEl.textContent = `${Math.round(result.summary.moderate / total * 100)}% SOBRE TOTAL`;
                if (infoPctEl) infoPctEl.textContent = `${Math.round(result.summary.info / total * 100)}% SOBRE TOTAL`;
                
                // Estado del tráfico
                const statusDot = document.querySelector('.status-dot');
                const statusText = document.getElementById('status-text');
                if (statusDot) {
                    statusDot.className = `status-dot ${result.status}`;
                }
                if (statusText) {
                    statusText.textContent = result.status_text || 'Normal';
                    statusText.style.color = result.status === 'anomaly' ? '#FF6B6B' : 
                                              result.status === 'warning' ? '#FFB347' : '#6CA8A4';
                }
                
                // Top alerta
                if (result.top_alert) {
                    const titleEl = document.getElementById('top-alert-title');
                    const descEl = document.getElementById('top-alert-desc');
                    const recEl = document.getElementById('top-alert-rec');
                    const critEl = document.getElementById('top-alert-crit');
                    
                    if (titleEl) titleEl.textContent = result.top_alert.title;
                    if (descEl) descEl.textContent = result.top_alert.desc;
                    if (recEl) recEl.textContent = result.top_alert.rec;
                    if (critEl) {
                        const critText = result.top_alert.type === 'critical' ? 'Crítica' :
                                        result.top_alert.type === 'moderate' ? 'Moderada' : 'Informativa';
                        critEl.textContent = critText;
                        critEl.style.color = result.top_alert.type === 'critical' ? '#FF6B6B' :
                                            result.top_alert.type === 'moderate' ? '#FFB347' : '#6CA8A4';
                    }
                    
                    // Actualizar borde de la caja
                    const topBox = document.getElementById('top-alert-box');
                    if (topBox) {
                        topBox.style.borderLeftColor = result.top_alert.type === 'critical' ? '#FF6B6B' :
                                                       result.top_alert.type === 'moderate' ? '#FFB347' : '#6CA8A4';
                    }
                }
                
                // Lista de alertas - Separar por tipo
                const alertsListImportant = document.getElementById('alerts-list-important');
                const alertsListInfo = document.getElementById('alerts-list-info');
                
                if (result.alerts) {
                    // Separar alertas por tipo
                    const importantAlerts = result.alerts.filter(a => a.type === 'critical' || a.type === 'moderate');
                    const infoAlerts = result.alerts.filter(a => a.type === 'info');
                    
                    // Renderizar alertas críticas y moderadas
                    if (alertsListImportant) {
                        if (importantAlerts.length === 0) {
                            alertsListImportant.innerHTML = '<p class="loading-text" style="color: #4CAF50;">✓ Sin alertas críticas o moderadas</p>';
                        } else {
                            let htmlImportant = '';
                            importantAlerts.forEach(alert => {
                                htmlImportant += `
                                    <div class="alert-item ${alert.type}">
                                        <span class="alert-item-icon">${alert.icon}</span>
                                        <div class="alert-item-content">
                                            <div class="alert-item-title">${alert.title}</div>
                                            <div class="alert-item-desc">${alert.desc}</div>
                                        </div>
                                        <div class="alert-item-meta">${alert.type === 'critical' ? 'Crítica' : 'Moderada'}</div>
                                    </div>
                                `;
                            });
                            alertsListImportant.innerHTML = htmlImportant;
                        }
                    }
                    
                    // Renderizar alertas informativas
                    if (alertsListInfo) {
                        if (infoAlerts.length === 0) {
                            alertsListInfo.innerHTML = '<p class="loading-text">Sin alertas informativas</p>';
                        } else {
                            let htmlInfo = '';
                            infoAlerts.forEach(alert => {
                                htmlInfo += `
                                    <div class="alert-item ${alert.type}">
                                        <span class="alert-item-icon">${alert.icon}</span>
                                        <div class="alert-item-content">
                                            <div class="alert-item-title">${alert.title}</div>
                                            <div class="alert-item-desc">${alert.desc}</div>
                                        </div>
                                        <div class="alert-item-meta">Info</div>
                                    </div>
                                `;
                            });
                            alertsListInfo.innerHTML = htmlInfo;
                        }
                    }
                }
                
                // Insight
                const insightEl = document.getElementById('alerts-insight-text');
                if (insightEl) {
                    let insight = '';
                    if (result.summary.critical > 0) {
                        insight = `El volumen actual de alertas críticas es elevado (${result.summary.critical}), indicando que el tráfico presenta anomalías relevantes en mercados clave. La presencia de alertas moderadas e informativas sugiere cambios significativos en la distribución y comportamiento de usuarios.`;
                    } else if (result.summary.moderate > 0) {
                        insight = `Se detectan ${result.summary.moderate} alertas moderadas que requieren atención. Aunque no son críticas, es recomendable monitorear la evolución de las métricas afectadas.`;
                    } else {
                        insight = `El tráfico se mantiene dentro de los parámetros normales. Las ${result.summary.info} alertas informativas son de seguimiento y no requieren acción inmediata.`;
                    }
                    insightEl.textContent = insight;
                }
                
                // ========================================
                // RENDERIZAR SECCIÓN DE DETECCIÓN DE BOTS
                // ========================================
                if (result.bot_detection) {
                    const bd = result.bot_detection;
                    
                    // Actualizar KPIs de bots
                    const botTotalEl = document.getElementById('bot-total-sessions');
                    const botSuspiciousEl = document.getElementById('bot-suspicious-sessions');
                    const botPctEl = document.getElementById('bot-percentage');
                    const botRiskEl = document.getElementById('bot-risk-level');
                    
                    if (botTotalEl) botTotalEl.textContent = bd.total_sessions_analyzed.toLocaleString();
                    if (botSuspiciousEl) botSuspiciousEl.textContent = bd.total_bot_sessions.toLocaleString();
                    if (botPctEl) {
                        botPctEl.textContent = `${bd.bot_percentage}%`;
                        // Color condicional
                        if (bd.bot_percentage > 50) {
                            botPctEl.style.color = '#F44336';
                        } else if (bd.bot_percentage > 30) {
                            botPctEl.style.color = '#FF9800';
                        } else if (bd.bot_percentage > 15) {
                            botPctEl.style.color = '#FFC107';
                        } else {
                            botPctEl.style.color = '#4CAF50';
                        }
                    }
                    
                    if (botRiskEl) {
                        const riskText = {
                            'low': 'Bajo',
                            'medium': 'Medio',
                            'high': 'Alto',
                            'critical': 'Crítico'
                        };
                        botRiskEl.textContent = riskText[bd.risk_level] || bd.risk_level;
                        botRiskEl.className = `bot-risk-badge ${bd.risk_level}`;
                    }
                    
                    // Renderizar tabla de países
                    const botTbody = document.getElementById('bot-countries-tbody');
                    if (botTbody && bd.countries) {
                        if (bd.countries.length === 0) {
                            botTbody.innerHTML = '<tr><td colspan="7" class="loading-text">No se detectan países con tráfico sospechoso.</td></tr>';
                        } else {
                            let tableHtml = '';
                            bd.countries.forEach(c => {
                                // Color para el % de rebote
                                let botRateClass = 'value-success';
                                if (c.bot_rate > 60) botRateClass = 'value-danger';
                                else if (c.bot_rate > 40) botRateClass = 'value-warning';
                                
                                // Emoji de bandera (simplificado)
                                const flag = '🌍';
                                
                                tableHtml += `
                                    <tr>
                                        <td class="country-name"><span class="country-flag">${flag}</span> ${c.country}</td>
                                        <td>${c.total_sessions.toLocaleString()}</td>
                                        <td>${c.engaged_sessions.toLocaleString()}</td>
                                        <td class="value-highlight ${c.bot_sessions > 50 ? 'value-danger' : ''}">${c.bot_sessions.toLocaleString()}</td>
                                        <td class="${botRateClass}">${c.bot_rate}%</td>
                                        <td>${c.avg_duration}s</td>
                                        <td><span class="risk-indicator ${c.risk_level}">${c.risk_level === 'critical' ? '🔴' : c.risk_level === 'high' ? '🟠' : c.risk_level === 'medium' ? '🟡' : '🟢'} ${c.risk_level}</span></td>
                                    </tr>
                                `;
                            });
                            botTbody.innerHTML = tableHtml;
                        }
                    }
                    
                    // Insight de bots
                    const botInsightEl = document.getElementById('bot-insight-text');
                    if (botInsightEl && bd.insight) {
                        botInsightEl.textContent = bd.insight;
                    }
                }
            }
        } catch (error) {
            console.error('Error loading alerts:', error);
        }
    }

    // Cargar datos cuando se carguen los KPIs
    const originalLoadKPIs = loadKPIs;
    loadKPIs = async function(startDate, endDate) {
        console.log('[KPIs] Ejecutando loadKPIs extendido...');
        await originalLoadKPIs(startDate, endDate);
        await updateComparisonChart();
        await updateUsersTypeChart();
        await loadQualityKPIs();
        await loadGeoData();
        console.log('[KPIs] Llamando a loadAlerts...');
        await loadAlerts();
        console.log('[KPIs] Completado');
    };

    // ===== BOTÓN DE FILTROS - LISTENER DIRECTO =====
    // Esperar a que el DOM esté listo y añadir listener
    // El botón de filtros se maneja en window.applyFilters (definido arriba)
    
    // ===== APOLLO PAGE =====
    async function loadApolloData() {
        console.log('[APOLLO] Cargando datos de Apollo...');
        const btn = document.getElementById('apollo-test-btn');
        if (btn) { btn.textContent = 'Testing...'; btn.disabled = true; }

        try {
            const response = await fetch('/api/get-apollo-data', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            });
            const data = await response.json();
            console.log('[APOLLO] Respuesta:', data);

            if (data.success) {
                updateApolloStatus(data);
                updateApolloContacts(data.endpoints.people);
                updateApolloEmails(data.endpoints.emails);
            }
        } catch (error) {
            console.error('[APOLLO] Error:', error);
            const el = document.getElementById('apollo-key-status');
            if (el) { el.textContent = 'ERROR'; el.style.color = '#ff6b6b'; }
        } finally {
            if (btn) { btn.textContent = 'Test Connection'; btn.disabled = false; }
        }
    }

    function updateApolloStatus(data) {
        const conn = data.connection;
        const people = data.endpoints.people;
        const emails = data.endpoints.emails;

        // API Key status
        const keyEl = document.getElementById('apollo-key-status');
        const keyMasked = document.getElementById('apollo-key-masked');
        if (keyEl) {
            keyEl.textContent = conn.api_key_configured ? 'Configurada' : 'No configurada';
            keyEl.style.color = conn.api_key_configured ? '#6CA8A4' : '#ff6b6b';
        }
        if (keyMasked) keyMasked.textContent = conn.api_key_configured ? conn.api_key_masked : 'Falta APOLLO_API_KEY en .env';

        // People endpoint
        const pEl = document.getElementById('apollo-people-status');
        const pDetail = document.getElementById('apollo-people-detail');
        if (pEl) {
            if (people.status === 'ok') {
                pEl.textContent = `OK (${people.count})`;
                pEl.style.color = '#6CA8A4';
            } else {
                pEl.textContent = `Error ${people.http_code || ''}`;
                pEl.style.color = '#ff6b6b';
            }
        }
        if (pDetail) pDetail.textContent = people.status === 'ok'
            ? `${people.count} contactos · ${people.response_time_ms}ms`
            : (people.error || 'Error desconocido');

        // Emails endpoint
        const eEl = document.getElementById('apollo-emails-status');
        const eDetail = document.getElementById('apollo-emails-detail');
        if (eEl) {
            if (emails.status === 'ok') {
                eEl.textContent = `OK (${emails.count})`;
                eEl.style.color = '#6CA8A4';
            } else {
                eEl.textContent = `Error ${emails.http_code || ''}`;
                eEl.style.color = '#ff6b6b';
            }
        }
        if (eDetail) eDetail.textContent = emails.status === 'ok'
            ? `${emails.count} emails · ${emails.response_time_ms}ms`
            : (emails.error || 'Error desconocido');

        // Endpoint details
        function renderDetail(ep) {
            let html = `<p style="color:rgba(255,255,255,0.6); font-size:0.8rem; margin-bottom:0.5rem;">
                <strong>HTTP:</strong> ${ep.http_code || 'N/A'} &nbsp;|&nbsp;
                <strong>Tiempo:</strong> ${ep.response_time_ms}ms &nbsp;|&nbsp;
                <strong>Registros:</strong> ${ep.count}</p>`;
            if (ep.error) {
                html += `<p style="color:#ff6b6b; font-size:0.8rem; word-break:break-all;">${ep.error}</p>`;
            }
            if (ep.error_body) {
                html += `<pre style="color:#ff6b6b; font-size:0.7rem; margin-top:0.5rem; white-space:pre-wrap;">${ep.error_body}</pre>`;
            }
            return html;
        }
        const pDetails = document.getElementById('apollo-people-details');
        if (pDetails) pDetails.innerHTML = renderDetail(people);
        const eDetails = document.getElementById('apollo-emails-details');
        if (eDetails) eDetails.innerHTML = renderDetail(emails);

        // Raw JSON preview
        const rawEl = document.getElementById('apollo-raw-json');
        if (rawEl) {
            const preview = {
                people_sample: people.data.slice(0, 2),
                emails_sample: emails.data.slice(0, 2)
            };
            rawEl.textContent = JSON.stringify(preview, null, 2);
        }
    }

    function updateApolloContacts(people) {
        const tbody = document.getElementById('apollo-contacts-table');
        const countEl = document.getElementById('apollo-contacts-count');
        if (countEl) countEl.textContent = people.count || 0;

        if (!tbody) return;
        if (!people.data || people.data.length === 0) {
            tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; color:rgba(255,255,255,0.5);">
                ${people.error ? 'Error: ' + people.error : 'Sin contactos'}</td></tr>`;
            return;
        }
        tbody.innerHTML = people.data.map(p => {
            const name = p.name || p.first_name && p.last_name ? (p.first_name + ' ' + (p.last_name || '')) : '-';
            const title = p.title || '-';
            const company = (p.organization && p.organization.name) || p.organization_name || '-';
            const industry = (p.organization && p.organization.industry) || '-';
            const country = p.country || '-';
            const email = p.email || '-';
            const linkedin = p.linkedin_url
                ? `<a href="${p.linkedin_url}" target="_blank" style="color:#6CA8A4;">Ver</a>`
                : '-';
            return `<tr>
                <td>${name}</td>
                <td>${title}</td>
                <td>${company}</td>
                <td>${industry}</td>
                <td>${country}</td>
                <td style="font-size:0.8rem;">${email}</td>
                <td>${linkedin}</td>
            </tr>`;
        }).join('');
    }

    function updateApolloEmails(emails) {
        const tbody = document.getElementById('apollo-emails-table');
        const countEl = document.getElementById('apollo-emails-count');
        if (countEl) countEl.textContent = emails.count || 0;

        if (!tbody) return;
        if (!emails.data || emails.data.length === 0) {
            tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; color:rgba(255,255,255,0.5);">
                ${emails.error ? 'Error: ' + emails.error : 'Sin emails'}</td></tr>`;
            return;
        }
        tbody.innerHTML = emails.data.map(m => {
            const date = m.created_at ? new Date(m.created_at).toLocaleDateString('es-ES') : '-';
            const recipient = m.to_name || (m.contact && m.contact.name) || m.to || '-';
            const subject = m.subject || '-';
            const replied = m.is_replied;
            const status = replied ? '<span style="color:#6CA8A4;">Respondido</span>' : '<span style="color:rgba(255,255,255,0.5);">Pendiente</span>';
            const repliedAt = m.replied_at ? new Date(m.replied_at).toLocaleDateString('es-ES') : '-';
            return `<tr>
                <td>${date}</td>
                <td>${recipient}</td>
                <td>${subject}</td>
                <td>${status}</td>
                <td>${repliedAt}</td>
            </tr>`;
        }).join('');
    }

    // ===== DIANA PAGE =====
    async function loadDianaData() {
        console.log('[DIANA] Cargando datos de Diana...');
        
        try {
            // Obtener fechas del filtro
            const { startDate, endDate } = getDateRange();
            
            const response = await fetch('/api/get-diana-data', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    fecha_inicio: startDate,
                    fecha_fin: endDate
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Actualizar KPIs
                updateDianaKPIs(data.kpis);
                
                // Actualizar gráficos
                updateDianaCharts(data.charts);
                
                // Actualizar tabla de mensajes
                updateDianaMessagesTable(data.messages);
                
                // Actualizar resumen de Top 3 Targets
                updateDianaTargetsSummary(data.targets_summary);
            } else {
                console.error('[DIANA] Error:', data.error);
            }
        } catch (error) {
            console.error('[DIANA] Error cargando datos:', error);
        }
    }
    
    function updateDianaKPIs(kpis) {
        if (!kpis) return;
        
        // Función helper para actualizar delta con formato
        function updateDelta(elementId, delta) {
            const el = document.getElementById(elementId);
            if (!el) return;
            
            const isPositive = delta >= 0;
            el.textContent = `${isPositive ? '↑' : '↓'} ${Math.abs(delta).toFixed(1)}%`;
            el.className = `kpi-delta ${isPositive ? 'positive' : 'negative'}`;
        }
        
        // Mensajes enviados
        const sentEl = document.getElementById('diana-messages-sent');
        const sentDeltaEl = document.getElementById('diana-messages-sent-delta');
        if (sentEl) sentEl.textContent = formatNumber(kpis.messages_sent || 0);
        updateDelta('diana-messages-sent-delta', kpis.messages_sent_delta || 0);
        
        // Respuestas
        const repliedEl = document.getElementById('diana-messages-replied');
        if (repliedEl) repliedEl.textContent = formatNumber(kpis.messages_replied || 0);
        updateDelta('diana-messages-replied-delta', kpis.messages_replied_delta || 0);
        
        // Leads generados
        const leadsEl = document.getElementById('diana-leads-generated');
        if (leadsEl) leadsEl.textContent = formatNumber(kpis.leads_generated || 0);
        updateDelta('diana-leads-generated-delta', kpis.leads_generated_delta || 0);
        
        // Reuniones agendadas
        const meetingsEl = document.getElementById('diana-meetings-scheduled');
        if (meetingsEl) meetingsEl.textContent = formatNumber(kpis.meetings_scheduled || 0);
        updateDelta('diana-meetings-scheduled-delta', kpis.meetings_scheduled_delta || 0);
    }
    
    function updateDianaCharts(charts) {
        if (!charts) return;
        
        // Gráfico de mensajes enviados por día
        const messagesCtx = document.getElementById('diana-messages-chart');
        if (messagesCtx && charts.messages_by_day) {
            console.log('[DIANA] Datos para gráfico de mensajes:', charts.messages_by_day);
        }
        
        // Gráfico de tasa de respuesta
        const rateCtx = document.getElementById('diana-response-rate-chart');
        if (rateCtx && charts.response_rate_by_day) {
            console.log('[DIANA] Datos para gráfico de tasa de respuesta:', charts.response_rate_by_day);
        }
    }
    
    function updateDianaMessagesTable(messages) {
        const tableBody = document.getElementById('diana-messages-table');
        if (!tableBody || !messages) return;
        
        if (messages.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: rgba(255,255,255,0.5);">No hay mensajes disponibles</td></tr>';
            return;
        }
        
        tableBody.innerHTML = messages.map(msg => {
            const date = new Date(msg.date || msg.created_at).toLocaleDateString('es-ES');
            const status = msg.replied ? '✅ Respondido' : '⏳ Pendiente';
            const responseTime = msg.response_time ? `${Math.floor(msg.response_time / 3600)}h ${Math.floor((msg.response_time % 3600) / 60)}m` : '-';
            
            return `
                <tr>
                    <td>${date}</td>
                    <td>${msg.recipient || msg.to || '-'}</td>
                    <td>${msg.subject || msg.title || '-'}</td>
                    <td>${status}</td>
                    <td>${responseTime}</td>
                </tr>
            `;
        }).join('');
    }
    
    function updateDianaTargetsSummary(summary) {
        if (!summary || !summary.top_3) return;
        
        const targets = summary.top_3;
        const stats = summary.stats || {};
        
        // Actualizar Top 3 Targets
        for (let i = 0; i < 3; i++) {
            const target = targets[i];
            if (!target) continue;
            
            const num = i + 1;
            const typeEl = document.getElementById(`diana-target${num}-type`);
            const industryEl = document.getElementById(`diana-target${num}-industry`);
            const countryEl = document.getElementById(`diana-target${num}-country`);
            const headlineEl = document.getElementById(`diana-target${num}-headline`);
            const scoreEl = document.getElementById(`diana-target${num}-score`);
            
            if (typeEl) typeEl.textContent = target.type || '-';
            if (industryEl) industryEl.textContent = target.industry || '-';
            if (countryEl) countryEl.textContent = target.country || '-';
            if (headlineEl) {
                headlineEl.textContent = target.headline || '-';
                // Truncar si es muy largo
                if (headlineEl.textContent.length > 120) {
                    headlineEl.textContent = headlineEl.textContent.substring(0, 120) + '...';
                }
            }
            if (scoreEl) {
                scoreEl.textContent = `${target.match_score || 0}%`;
                scoreEl.className = `kpi-delta ${target.match_score >= 90 ? 'positive' : target.match_score >= 80 ? 'positive' : 'negative'}`;
            }
        }
        
        // Actualizar estadísticas
        const topIndustryEl = document.getElementById('diana-top-industry');
        const topIndustryCountEl = document.getElementById('diana-top-industry-count');
        const topCountryEl = document.getElementById('diana-top-country');
        const topCountryCountEl = document.getElementById('diana-top-country-count');
        const topTypeEl = document.getElementById('diana-top-type');
        const topTypeCountEl = document.getElementById('diana-top-type-count');
        const totalLeadsEl = document.getElementById('diana-total-leads');
        
        if (topIndustryEl) topIndustryEl.textContent = stats.top_industry || '-';
        if (topIndustryCountEl) topIndustryCountEl.textContent = `${stats.top_industry_count || 0} leads`;
        if (topCountryEl) topCountryEl.textContent = stats.top_country || '-';
        if (topCountryCountEl) topCountryCountEl.textContent = `${stats.top_country_count || 0} leads`;
        if (topTypeEl) topTypeEl.textContent = (stats.top_type || '-').substring(0, 20) + (stats.top_type && stats.top_type.length > 20 ? '...' : '');
        if (topTypeCountEl) topTypeCountEl.textContent = `${stats.top_type_count || 0} leads`;
        if (totalLeadsEl) totalLeadsEl.textContent = formatNumber(stats.total_leads || 0);
    }
    
    // =============================================================================
    // LEADS PAGE FUNCTIONS
    // =============================================================================
    
    // Variable global para almacenar leads y poder filtrar
    let allLeadsData = [];
    
    async function loadLeadsData() {
        console.log('[LEADS] Cargando datos de leads...');
        
        try {
            const response = await fetch('/api/leads');
            const data = await response.json();
            
            if (data.success) {
                allLeadsData = data.leads || [];
                updateLeadsPipeline(allLeadsData);
            } else {
                console.error('[LEADS] Error:', data.error);
            }
        } catch (error) {
            console.error('[LEADS] Error cargando datos:', error);
        }
    }
    
    // Event listener para el filtro de fuente
    document.addEventListener('DOMContentLoaded', () => {
        const filterSource = document.getElementById('filter-source');
        if (filterSource) {
            filterSource.addEventListener('change', () => {
                updateLeadsPipeline(allLeadsData);
            });
        }
    });
    
    function updateLeadsPipeline(leads) {
        // Definir las fases del pipeline
        const phases = ['respuesta_positiva', 'primera_reunion', 'segunda_reunion', 'propuesta', 'cerrado_ganado'];
        
        // Limpiar todas las columnas
        phases.forEach(phase => {
            const container = document.getElementById(`cards-${phase}`);
            if (container) {
                container.innerHTML = '';
            }
        });
        
        // Mapear estados antiguos a nuevos si es necesario
        const statusMapping = {
            'nuevo': 'respuesta_positiva',
            'contactado': 'respuesta_positiva',
            'reunion_agendada': 'primera_reunion',
            'cerrado': 'cerrado_ganado'
        };
        
        // Contar leads por fase
        const counts = {};
        phases.forEach(phase => counts[phase] = 0);
        
        // Aplicar filtro de fuente
        const filterSource = document.getElementById('filter-source');
        const selectedSource = filterSource ? filterSource.value : '';
        
        const filteredLeads = selectedSource 
            ? leads.filter(lead => lead.source === selectedSource)
            : leads;
        
        // Renderizar cada lead en su columna correspondiente
        filteredLeads.forEach(lead => {
            // Determinar la fase (usar mapping si es estado antiguo)
            let phase = lead.status;
            if (statusMapping[phase]) {
                phase = statusMapping[phase];
            }
            if (!phases.includes(phase)) {
                phase = 'respuesta_positiva'; // Default
            }
            
            counts[phase]++;
            
            const container = document.getElementById(`cards-${phase}`);
            if (!container) return;
            
            const sourceBadge = getSourceBadge(lead.source);
            const meetingDate = lead.meeting_date ? new Date(lead.meeting_date).toLocaleDateString('es-ES') : null;
            const createdBy = lead.created_by || (lead.id && lead.id.toString().startsWith('diana_') ? 'Diana' : 'Sistema');
            const createdByDisplay = createdBy.includes('@') ? createdBy.split('@')[0] : createdBy;
            
            const card = document.createElement('div');
            card.className = 'pipeline-card';
            card.dataset.leadId = lead.id;
            card.style.cssText = 'background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; padding: 0.75rem; cursor: pointer; transition: all 0.2s ease;';
            
            card.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                    <span style="color: #fff; font-weight: 600; font-size: 0.9rem;">${lead.company_name || 'Sin nombre'}</span>
                    ${sourceBadge}
                </div>
                ${lead.contact_name ? `<div style="color: rgba(255,255,255,0.7); font-size: 0.8rem; margin-bottom: 0.25rem;">👤 ${lead.contact_name}</div>` : ''}
                ${meetingDate ? `<div style="color: rgba(255,255,255,0.6); font-size: 0.75rem; margin-bottom: 0.25rem;">📅 ${meetingDate}</div>` : ''}
                ${lead.project_reason ? `<div style="color: rgba(255,255,255,0.5); font-size: 0.75rem; margin-bottom: 0.5rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${lead.project_reason.substring(0, 40)}${lead.project_reason.length > 40 ? '...' : ''}</div>` : ''}
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid rgba(255,255,255,0.05);">
                    <span style="color: rgba(255,255,255,0.4); font-size: 0.7rem;">Por: ${createdByDisplay}</span>
                    <div style="display: flex; gap: 0.25rem;">
                        <button class="btn-edit-lead" data-lead-id="${lead.id}" style="background: rgba(108, 168, 164, 0.2); border: none; border-radius: 4px; padding: 0.25rem 0.5rem; color: #6CA8A4; cursor: pointer; font-size: 0.7rem;">✏️</button>
                        <button class="btn-delete-lead" data-lead-id="${lead.id}" style="background: rgba(244, 67, 54, 0.2); border: none; border-radius: 4px; padding: 0.25rem 0.5rem; color: #F44336; cursor: pointer; font-size: 0.7rem;">🗑️</button>
                    </div>
                </div>
            `;
            
            // Hover effect
            card.addEventListener('mouseenter', () => {
                card.style.background = 'rgba(255,255,255,0.06)';
                card.style.borderColor = 'rgba(108, 168, 164, 0.3)';
            });
            card.addEventListener('mouseleave', () => {
                card.style.background = 'rgba(255,255,255,0.03)';
                card.style.borderColor = 'rgba(255,255,255,0.1)';
            });
            
            container.appendChild(card);
        });
        
        // Actualizar contadores
        phases.forEach(phase => {
            const countEl = document.getElementById(`count-${phase}`);
            if (countEl) {
                countEl.textContent = counts[phase];
            }
        });
        
        // Agregar event listeners a los botones de editar y eliminar
        document.querySelectorAll('.btn-edit-lead').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const leadId = btn.dataset.leadId;
                const lead = leads.find(l => l.id == leadId || l.id === leadId);
                if (lead) {
                    openLeadModal(lead);
                }
            });
        });
        
        document.querySelectorAll('.btn-delete-lead').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const leadId = btn.dataset.leadId;
                if (confirm('¿Estás seguro de que quieres eliminar este lead?')) {
                    deleteLead(leadId);
                }
            });
        });
    }
    
    // Mantener compatibilidad con la función antigua
    function updateLeadsTable(leads) {
        updateLeadsPipeline(leads);
    }
    
    function getSourceBadge(source) {
        const badges = {
            'diana': '<span style="background: rgba(108, 168, 164, 0.2); color: #6CA8A4; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">Diana</span>',
            'manual': '<span style="background: rgba(255, 152, 0, 0.2); color: #FF9800; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">Manual</span>',
            'web': '<span style="background: rgba(33, 150, 243, 0.2); color: #2196F3; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">Web</span>',
            'linkedin': '<span style="background: rgba(0, 119, 181, 0.2); color: #0077B5; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">LinkedIn</span>'
        };
        return badges[source] || `<span style="background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.7); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">${source || 'N/A'}</span>`;
    }
    
    function getStatusBadge(status) {
        const badges = {
            'respuesta_positiva': '<span style="background: rgba(76, 175, 80, 0.2); color: #4CAF50; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">💬 Respuesta +</span>',
            'primera_reunion': '<span style="background: rgba(33, 150, 243, 0.2); color: #2196F3; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">📅 1ª Reunión</span>',
            'segunda_reunion': '<span style="background: rgba(156, 39, 176, 0.2); color: #9C27B0; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">🤝 2ª Reunión</span>',
            'propuesta': '<span style="background: rgba(255, 152, 0, 0.2); color: #FF9800; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">📋 Propuesta</span>',
            'cerrado_ganado': '<span style="background: rgba(108, 168, 164, 0.2); color: #6CA8A4; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">🏆 Cerrado</span>',
            // Compatibilidad con estados antiguos
            'nuevo': '<span style="background: rgba(76, 175, 80, 0.2); color: #4CAF50; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">Nuevo</span>',
            'contactado': '<span style="background: rgba(255, 152, 0, 0.2); color: #FF9800; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">Contactado</span>',
            'reunion_agendada': '<span style="background: rgba(156, 39, 176, 0.2); color: #9C27B0; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">Reunión Agendada</span>',
            'cerrado': '<span style="background: rgba(158, 158, 158, 0.2); color: #9E9E9E; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">Cerrado</span>'
        };
        return badges[status] || `<span style="background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.7); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">${status || 'N/A'}</span>`;
    }
    
    // Manejo del modal de leads
    const leadModal = document.getElementById('lead-modal');
    const btnAddLead = document.getElementById('btn-add-lead');
    const leadForm = document.getElementById('lead-form');
    
    if (btnAddLead) {
        btnAddLead.addEventListener('click', () => {
            if (leadModal) {
                document.getElementById('lead-modal-title').textContent = 'Agregar Nuevo Lead';
                document.getElementById('lead-id').value = '';
                leadForm.reset();
                leadModal.style.display = 'block';
            }
        });
    }
    
    if (leadModal) {
        const closeButtons = leadModal.querySelectorAll('.modal-close');
        closeButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                leadModal.style.display = 'none';
                if (leadForm) leadForm.reset();
            });
        });
        
        leadModal.addEventListener('click', (e) => {
            if (e.target === leadModal) {
                leadModal.style.display = 'none';
                if (leadForm) leadForm.reset();
            }
        });
    }
    
    async function editLead(leadId) {
        try {
            const response = await fetch('/api/leads');
            const data = await response.json();
            
            if (data.success) {
                const lead = data.leads.find(l => l.id == leadId);
                if (lead) {
                    document.getElementById('lead-modal-title').textContent = 'Editar Lead';
                    document.getElementById('lead-id').value = lead.id;
                    document.getElementById('lead-source').value = lead.source || '';
                    document.getElementById('lead-company').value = lead.company_name || '';
                    document.getElementById('lead-contact-name').value = lead.contact_name || '';
                    document.getElementById('lead-email').value = lead.contact_email || '';
                    document.getElementById('lead-phone').value = lead.contact_phone || '';
                    document.getElementById('lead-meeting-date').value = lead.meeting_date || '';
                    document.getElementById('lead-project-reason').value = lead.project_reason || '';
                    document.getElementById('lead-status').value = lead.status || 'nuevo';
                    document.getElementById('lead-notes').value = lead.notes || '';
                    
                    if (leadModal) leadModal.style.display = 'block';
                }
            }
        } catch (error) {
            console.error('[LEADS] Error cargando lead:', error);
        }
    }
    
    if (leadForm) {
        leadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const leadId = document.getElementById('lead-id').value;
            const companyName = document.getElementById('lead-company').value.trim();
            const source = document.getElementById('lead-source').value;
            
            if (!source || !companyName) {
                alert('Por favor, completa los campos requeridos (Fuente y Empresa)');
                return;
            }
            
            const leadData = {
                source: source,
                company_name: companyName,
                contact_name: document.getElementById('lead-contact-name').value.trim(),
                contact_email: document.getElementById('lead-email').value.trim(),
                contact_phone: document.getElementById('lead-phone').value.trim(),
                meeting_date: document.getElementById('lead-meeting-date').value,
                project_reason: document.getElementById('lead-project-reason').value.trim(),
                status: document.getElementById('lead-status').value,
                notes: document.getElementById('lead-notes').value.trim()
            };
            
            try {
                let response;
                if (leadId) {
                    // Actualizar lead existente
                    response = await fetch(`/api/leads/${leadId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(leadData)
                    });
                } else {
                    // Crear nuevo lead
                    response = await fetch('/api/leads', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(leadData)
                    });
                }
                
                const data = await response.json();
                
                if (data.success) {
                    if (leadModal) leadModal.style.display = 'none';
                    leadForm.reset();
                    await loadLeadsData();
                } else {
                    alert('Error al guardar el lead: ' + (data.error || 'Error desconocido'));
                }
            } catch (error) {
                console.error('[LEADS] Error guardando lead:', error);
                alert('Error al guardar el lead. Por favor, intenta de nuevo.');
            }
        });
    }
    
    async function deleteLead(leadId) {
        try {
            const response = await fetch(`/api/leads/${leadId}`, {
                method: 'DELETE'
            });
            
            const data = await response.json();
            
            if (data.success) {
                await loadLeadsData();
            } else {
                alert('Error al eliminar el lead: ' + (data.error || 'Error desconocido'));
            }
        } catch (error) {
            console.error('[LEADS] Error eliminando lead:', error);
            alert('Error al eliminar el lead. Por favor, intenta de nuevo.');
        }
    }
    
    // =============================================================================
    // TEAM PAGE FUNCTIONS
    // =============================================================================
    
    async function loadTeamData() {
        console.log('[TEAM] Cargando datos de métricas...');
        
        try {
            const [emailRes, linkedinRes, webRes] = await Promise.all([
                fetch('/api/team/email-campaigns'),
                fetch('/api/team/linkedin-campaigns'),
                fetch('/api/team/web-metrics')
            ]);
            
            const emailData = await emailRes.json();
            const linkedinData = await linkedinRes.json();
            const webData = await webRes.json();
            
            if (emailData.success) {
                updateEmailCampaignsTable(emailData.data || []);
            }
            if (linkedinData.success) {
                updateLinkedinCampaignsTable(linkedinData.data || []);
            }
            if (webData.success) {
                updateWebMetricsTable(webData.data || []);
            }
        } catch (error) {
            console.error('[TEAM] Error cargando datos:', error);
        }
    }
    
    function updateEmailCampaignsTable(campaigns) {
        const tbody = document.getElementById('email-campaigns-body');
        if (!tbody) return;
        
        if (campaigns.length === 0) {
            campaigns = [
                {semana_fecha: '09 Dic - 15 Dic', campana: 'Tanda 1 Launch Clean', emails_enviados: '103', respuestas_total: '1', tasa_respuesta_total: '97.09%', respuestas_positivas: '0', tasa_respuestas_positivas: '0.00%', reuniones: '', notas: 'Contacto redirigido a Dpto. IT. Acción: Seguir contacto de IT.'},
                {semana_fecha: '09 Dic - 15 Dic', campana: 'Packaging 9 Diciembre', emails_enviados: '67', respuestas_total: '0', tasa_respuesta_total: '0.00%', respuestas_positivas: '0', tasa_respuestas_positivas: '0.00%', reuniones: '', notas: ''},
                {semana_fecha: '12 En - 16 En', campana: 'Diana I', emails_enviados: '671', respuestas_total: '17', tasa_respuesta_total: '2.53%', respuestas_positivas: '3', tasa_respuestas_positivas: '17.65%', reuniones: '1', notas: 'Campaign no terminada'},
                {semana_fecha: '18 En - 23 En', campana: 'Diana I', emails_enviados: '686', respuestas_total: '18', tasa_respuesta_total: '2.62%', respuestas_positivas: '3', tasa_respuestas_positivas: '16.67%', reuniones: '1', notas: ''}
            ];
        }
        
        tbody.innerHTML = campaigns.map((campaign, index) => `
            <tr data-index="${index}">
                <td contenteditable="true" data-field="semana_fecha">${campaign.semana_fecha || ''}</td>
                <td contenteditable="true" data-field="campana">${campaign.campana || ''}</td>
                <td contenteditable="true" data-field="emails_enviados">${campaign.emails_enviados || ''}</td>
                <td contenteditable="true" data-field="respuestas_total">${campaign.respuestas_total || ''}</td>
                <td contenteditable="true" data-field="tasa_respuesta_total">${campaign.tasa_respuesta_total || ''}</td>
                <td contenteditable="true" data-field="respuestas_positivas">${campaign.respuestas_positivas || ''}</td>
                <td contenteditable="true" data-field="tasa_respuestas_positivas">${campaign.tasa_respuestas_positivas || ''}</td>
                <td contenteditable="true" data-field="reuniones">${campaign.reuniones || ''}</td>
                <td contenteditable="true" data-field="notas">${campaign.notas || ''}</td>
            </tr>
        `).join('');
        
        tbody.querySelectorAll('td[contenteditable="true"]').forEach(cell => {
            cell.addEventListener('blur', debounce(saveEmailCampaigns, 1000));
        });
    }
    
    function updateLinkedinCampaignsTable(campaigns) {
        const tbody = document.getElementById('linkedin-campaigns-body');
        if (!tbody) return;
        
        if (campaigns.length === 0) {
            campaigns = [
                {semana_fecha: '09 Dic - 15 Dic', campana: 'Packaging 1 y 2', total_mensajes: '73', respuestas_total: '16', tasa_respuesta_total: '21.92%', respuestas_positivas: '10', tasa_respuestas_positivas: '13.70%', reuniones: '', notas: ''},
                {semana_fecha: '12 En - 16 En', campana: 'Early Adopters', total_mensajes: '177', respuestas_total: '24', tasa_respuesta_total: '13.56%', respuestas_positivas: '10', tasa_respuestas_positivas: '5.65%', reuniones: '3', notas: 'CTA a Reu'},
                {semana_fecha: '18 En - 23 En', campana: 'Early Adopters', total_mensajes: '120', respuestas_total: '28', tasa_respuesta_total: '23.33%', respuestas_positivas: '12', tasa_respuestas_positivas: '10.00%', reuniones: '6', notas: 'Algunos habian pedido info y han respondido que no. Otros pendientes de contestar si quieren reu o no.'}
            ];
        }
        
        tbody.innerHTML = campaigns.map((campaign, index) => `
            <tr data-index="${index}">
                <td contenteditable="true" data-field="semana_fecha">${campaign.semana_fecha || ''}</td>
                <td contenteditable="true" data-field="campana">${campaign.campana || ''}</td>
                <td contenteditable="true" data-field="total_mensajes">${campaign.total_mensajes || ''}</td>
                <td contenteditable="true" data-field="respuestas_total">${campaign.respuestas_total || ''}</td>
                <td contenteditable="true" data-field="tasa_respuesta_total">${campaign.tasa_respuesta_total || ''}</td>
                <td contenteditable="true" data-field="respuestas_positivas">${campaign.respuestas_positivas || ''}</td>
                <td contenteditable="true" data-field="tasa_respuestas_positivas">${campaign.tasa_respuestas_positivas || ''}</td>
                <td contenteditable="true" data-field="reuniones">${campaign.reuniones || ''}</td>
                <td contenteditable="true" data-field="notas">${campaign.notas || ''}</td>
            </tr>
        `).join('');
        
        tbody.querySelectorAll('td[contenteditable="true"]').forEach(cell => {
            cell.addEventListener('blur', debounce(saveLinkedinCampaigns, 1000));
        });
    }
    
    function updateWebMetricsTable(metrics) {
        const tbody = document.getElementById('web-metrics-body');
        if (!tbody) return;
        
        if (metrics.length === 0) {
            metrics = [
                {semana: '12 ene - 18 ene 2026', sesiones_totales: '312', usuarios: '276', usuarios_nuevos: '95%', sesiones_organicas: '70', sesiones_paid: '0', sesiones_referral: '26', engagement_rate: '17,9%', bounced_rate: '82,1 %', pages_por_sesion: '1,3', leads_web: '1', reuniones_agendadas: '0', tasa_conversion_web: '0.32', top_3_pages: 'HOME(ES/EN), Assesment, AI Solutions', top_blog: 'Agentes IA construcción', trafico_blog: '27.9', nuevas_paginas: 'Chatbots empresa', new_kws: '-'},
                {semana: '19 ene - 25 ene 2026', sesiones_totales: '774', usuarios: '715', usuarios_nuevos: '71%', sesiones_organicas: '54', sesiones_paid: '277', sesiones_referral: '24', engagement_rate: '42,4%', bounced_rate: '57,6%', pages_por_sesion: '1,6', leads_web: '3', reuniones_agendadas: '0', tasa_conversion_web: '0.39', top_3_pages: 'Assesment, Home (EN/ES) y AI Solutions', top_blog: 'IA en logistica', trafico_blog: '5.9', nuevas_paginas: 'Blog Sevica y ajustes en otras pages', new_kws: 'make your data ai ready'}
            ];
        }
        
        tbody.innerHTML = metrics.map((metric, index) => `
            <tr data-index="${index}">
                <td contenteditable="true" data-field="semana">${metric.semana || ''}</td>
                <td contenteditable="true" data-field="sesiones_totales">${metric.sesiones_totales || ''}</td>
                <td contenteditable="true" data-field="usuarios">${metric.usuarios || ''}</td>
                <td contenteditable="true" data-field="usuarios_nuevos">${metric.usuarios_nuevos || ''}</td>
                <td contenteditable="true" data-field="sesiones_organicas">${metric.sesiones_organicas || ''}</td>
                <td contenteditable="true" data-field="sesiones_paid">${metric.sesiones_paid || ''}</td>
                <td contenteditable="true" data-field="sesiones_referral">${metric.sesiones_referral || ''}</td>
                <td contenteditable="true" data-field="engagement_rate">${metric.engagement_rate || ''}</td>
                <td contenteditable="true" data-field="bounced_rate">${metric.bounced_rate || ''}</td>
                <td contenteditable="true" data-field="pages_por_sesion">${metric.pages_por_sesion || ''}</td>
                <td contenteditable="true" data-field="leads_web">${metric.leads_web || ''}</td>
                <td contenteditable="true" data-field="reuniones_agendadas">${metric.reuniones_agendadas || ''}</td>
                <td contenteditable="true" data-field="tasa_conversion_web">${metric.tasa_conversion_web || ''}</td>
                <td contenteditable="true" data-field="top_3_pages">${metric.top_3_pages || ''}</td>
                <td contenteditable="true" data-field="top_blog">${metric.top_blog || ''}</td>
                <td contenteditable="true" data-field="trafico_blog">${metric.trafico_blog || ''}</td>
                <td contenteditable="true" data-field="nuevas_paginas">${metric.nuevas_paginas || ''}</td>
                <td contenteditable="true" data-field="new_kws">${metric.new_kws || ''}</td>
            </tr>
        `).join('');
        
        tbody.querySelectorAll('td[contenteditable="true"]').forEach(cell => {
            cell.addEventListener('blur', debounce(saveWebMetrics, 1000));
        });
    }
    
    function getTableData(tableId) {
        const tbody = document.getElementById(tableId + '-body');
        if (!tbody) return [];
        
        const rows = tbody.querySelectorAll('tr');
        const data = [];
        
        rows.forEach(row => {
            const cells = row.querySelectorAll('td[contenteditable="true"]');
            const rowData = {};
            cells.forEach(cell => {
                rowData[cell.getAttribute('data-field')] = cell.textContent.trim();
            });
            data.push(rowData);
        });
        
        return data;
    }
    
    async function saveEmailCampaigns() {
        const data = getTableData('email-campaigns');
        try {
            const response = await fetch('/api/team/email-campaigns', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ campaigns: data })
            });
            const result = await response.json();
            if (result.success) {
                console.log('[TEAM] Email campaigns guardadas');
            }
        } catch (error) {
            console.error('[TEAM] Error guardando email campaigns:', error);
        }
    }
    
    async function saveLinkedinCampaigns() {
        const data = getTableData('linkedin-campaigns');
        try {
            const response = await fetch('/api/team/linkedin-campaigns', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ campaigns: data })
            });
            const result = await response.json();
            if (result.success) {
                console.log('[TEAM] LinkedIn campaigns guardadas');
            }
        } catch (error) {
            console.error('[TEAM] Error guardando linkedin campaigns:', error);
        }
    }
    
    async function saveWebMetrics() {
        const data = getTableData('web-metrics');
        try {
            const response = await fetch('/api/team/web-metrics', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ metrics: data })
            });
            const result = await response.json();
            if (result.success) {
                console.log('[TEAM] Web metrics guardadas');
            }
        } catch (error) {
            console.error('[TEAM] Error guardando web metrics:', error);
        }
    }
    
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
    
    document.addEventListener('click', (e) => {
        if (e.target.classList.contains('btn-add-row')) {
            const tableType = e.target.getAttribute('data-table');
            const tbody = document.getElementById(tableType + '-body');
            if (!tbody) return;
            
            let newRow;
            if (tableType === 'email-campaigns') {
                newRow = document.createElement('tr');
                newRow.innerHTML = `
                    <td contenteditable="true" data-field="semana_fecha"></td>
                    <td contenteditable="true" data-field="campana"></td>
                    <td contenteditable="true" data-field="emails_enviados"></td>
                    <td contenteditable="true" data-field="respuestas_total"></td>
                    <td contenteditable="true" data-field="tasa_respuesta_total"></td>
                    <td contenteditable="true" data-field="respuestas_positivas"></td>
                    <td contenteditable="true" data-field="tasa_respuestas_positivas"></td>
                    <td contenteditable="true" data-field="reuniones"></td>
                    <td contenteditable="true" data-field="notas"></td>
                `;
            } else if (tableType === 'linkedin-campaigns') {
                newRow = document.createElement('tr');
                newRow.innerHTML = `
                    <td contenteditable="true" data-field="semana_fecha"></td>
                    <td contenteditable="true" data-field="campana"></td>
                    <td contenteditable="true" data-field="total_mensajes"></td>
                    <td contenteditable="true" data-field="respuestas_total"></td>
                    <td contenteditable="true" data-field="tasa_respuesta_total"></td>
                    <td contenteditable="true" data-field="respuestas_positivas"></td>
                    <td contenteditable="true" data-field="tasa_respuestas_positivas"></td>
                    <td contenteditable="true" data-field="reuniones"></td>
                    <td contenteditable="true" data-field="notas"></td>
                `;
            } else if (tableType === 'web-metrics') {
                newRow = document.createElement('tr');
                newRow.innerHTML = `
                    <td contenteditable="true" data-field="semana"></td>
                    <td contenteditable="true" data-field="sesiones_totales"></td>
                    <td contenteditable="true" data-field="usuarios"></td>
                    <td contenteditable="true" data-field="usuarios_nuevos"></td>
                    <td contenteditable="true" data-field="sesiones_organicas"></td>
                    <td contenteditable="true" data-field="sesiones_paid"></td>
                    <td contenteditable="true" data-field="sesiones_referral"></td>
                    <td contenteditable="true" data-field="engagement_rate"></td>
                    <td contenteditable="true" data-field="bounced_rate"></td>
                    <td contenteditable="true" data-field="pages_por_sesion"></td>
                    <td contenteditable="true" data-field="leads_web"></td>
                    <td contenteditable="true" data-field="reuniones_agendadas"></td>
                    <td contenteditable="true" data-field="tasa_conversion_web"></td>
                    <td contenteditable="true" data-field="top_3_pages"></td>
                    <td contenteditable="true" data-field="top_blog"></td>
                    <td contenteditable="true" data-field="trafico_blog"></td>
                    <td contenteditable="true" data-field="nuevas_paginas"></td>
                    <td contenteditable="true" data-field="new_kws"></td>
                `;
            }
            
            if (newRow) {
                tbody.appendChild(newRow);
                newRow.querySelectorAll('td[contenteditable="true"]').forEach(cell => {
                    if (tableType === 'email-campaigns') {
                        cell.addEventListener('blur', debounce(saveEmailCampaigns, 1000));
                    } else if (tableType === 'linkedin-campaigns') {
                        cell.addEventListener('blur', debounce(saveLinkedinCampaigns, 1000));
                    } else if (tableType === 'web-metrics') {
                        cell.addEventListener('blur', debounce(saveWebMetrics, 1000));
                    }
                });
            }
        }
    });
    
    // =============================================================================
    // TEAM PAGE - SUB-TABS AND EXPANDERS
    // =============================================================================
    
    // Manejo de sub-tabs dentro de Generation Team y Close Team
    document.addEventListener('click', (e) => {
        if (e.target.classList.contains('tab-btn') && e.target.hasAttribute('data-tab')) {
            const tabId = e.target.getAttribute('data-tab');
            
            // Verificar si es un sub-tab (gen-overview, gen-kpis, close-overview, close-kpis)
            if (tabId.startsWith('gen-') || tabId.startsWith('close-')) {
                e.preventDefault();
                e.stopPropagation();
                
                // Encontrar el contenedor padre (generation-team o close-team)
                const parentTab = e.target.closest('.tab-content[id="generation-team"], .tab-content[id="close-team"]');
                if (!parentTab) return;
                
                // Ocultar todos los sub-tabs del mismo contenedor
                const subTabs = parentTab.querySelectorAll('.tab-content');
                subTabs.forEach(tab => {
                    if (tab.id.startsWith('gen-') || tab.id.startsWith('close-')) {
                        tab.classList.remove('active');
                    }
                });
                
                // Mostrar el sub-tab seleccionado
                const targetTab = document.getElementById(tabId);
                if (targetTab) {
                    targetTab.classList.add('active');
                }
                
                // Actualizar botones activos dentro del mismo contenedor
                const tabsContainer = e.target.closest('.tabs-container');
                if (tabsContainer) {
                    tabsContainer.querySelectorAll('.tab-btn').forEach(btn => {
                        if (btn.getAttribute('data-tab') === tabId) {
                            btn.classList.add('active');
                        } else {
                            btn.classList.remove('active');
                        }
                    });
                }
            }
        }
    });
    
    // Manejo de expanders
    document.addEventListener('click', (e) => {
        if (e.target.closest('.expander-header')) {
            const header = e.target.closest('.expander-header');
            const expanderId = header.getAttribute('data-expander');
            const container = header.closest('.expander-container');
            
            if (container) {
                container.classList.toggle('expanded');
            }
        }
    });

</script>
{% endblock %}

